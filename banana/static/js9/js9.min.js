var JS9;if(JS9&&("object"!==typeof JS9||JS9.NAME))throw Error("Namespace 'JS9' already exists");JS9={NAME:"JS9",VERSION:"1.5",COPYRIGHT:"Copyright (c) 2012-2015 Smithsonian Institution"};
JS9=function(a){a.DEFID="JS9";a.ANON="[anonymous]";a.PREFSFILE="js9Prefs.json";a.ZINDEX=0;a.SHAPEZINDEX=7;a.MESSZINDEX=8;a.BTNZINDEX=10;a.MENUZINDEX=1E3;a.COLORSIZE=1024;a.SCALESIZE=16384;a.INSTALLDIR="";a.TOROOT="";a.PLUGINS="";a.LIGHTWIN="dhtml";a.ANTIALIAS=!1;a.SCALEIREG=!0;a.NOMOVE=3;a.DBLCLICK=500;a.TIMEOUT=250;a.SUPERMENU=/^_SUPERMENU/;var F=a,D=navigator.platform,G=navigator.appName,B=navigator.userAgent,C,v=B.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);C=B.match(/version\/([\.\d]+)/i);
v&&null!==C&&(v[2]=C[1]);v=v?[v[1],v[2],D]:[G,navigator.appVersion,"-?",D];v.push(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(B));F.BROWSER=v;a.globalOpts={helperType:"sock.io",helperPort:2718,winType:"light",rgb:{mode:!1,rim:null,gim:null,bim:null},defcolor:"#00FF00",pngisfits:!0,fits2png:!1,alerts:!0,internalValPos:!0,xtimeout:1E3,extlist:"EVENTS STDEVT",dims:[1024,1024],helperProtocol:location.protocol,maxMemory:45E7,debug:0};a.imageOpts={contrast:1,bias:0.5,invert:!1,exp:1E3,colormap:"grey",
scale:"linear",scaleclipping:"dataminmax",zscalecontrast:0.25,zscalesamples:600,zscaleline:120,wcssys:"native",wcsunits:"sexagesimal",lcs:"physical",valpos:!0,alpha:255,alpha1:100,alpha2:255,zoom:1,zooms:5,nancolor:"#000000",listonchange:!1};a.analOpts={epattern:/^(ERROR:[^\n]*)\n/,dpathURL:"params/datapath.html",prependJS9Dir:!0,dataDir:null};a.lightOpts={dhtml:{top:".dhtmlwindow",drag:".drag-contentarea",dragBar:"drag-handle",format:"width=%spx,height=%spx,center=1,resize=%s,scrolling=0",textWin:"width=830px,height=400px,center=1,resize=1,scrolling=1",
plotWin:"width=830px,height=420px,center=1,resize=1,scrolling=1",dpathWin:"width=830px,height=175px,center=1,resize=1,scrolling=1",paramWin:"width=830px,height=230px,center=1,resize=1,scrolling=1",imageWin:"width=512px,height=542px,center=1,resize=1,scrolling=1",lineWin:"width=400px,height=10px,center=1,resize=1,scrolling=1"}};a.textColorOpts={regions:"#00FF00",info:"#00FF00"};a.plotOpts={zoomStack:!0,selection:{mode:"xy"},series:{clickable:!0,hoverable:!0,lines:{show:!0},points:{show:!1}}};a.helpOpts=
{user:{type:"help",url:"user.html",title:"JS9 User Manual"},install:{type:"help",url:"install.html",title:"Installing JS9"},webpage:{type:"help",url:"webpage.html",title:"Adding JS9 To A Web Page"},yourdata:{type:"help",url:"yourdata.html",title:"Adding Data To A Web Page"},localtasks:{type:"help",url:"localtasks.html",title:"Local Analysis with JS9"},publicapi:{type:"help",url:"publicapi.html",title:"The JS9 Public API"},helper:{type:"help",url:"helper.html",title:"Adding Server-side Analysis"},
serverside:{type:"help",url:"serverside.html",title:"Server-side Analysis with JS9"},regions:{type:"help",url:"regions.html",title:"JS9 Regions Format"},extmsg:{type:"help",url:"extmsg.html",title:"JS9 External Messaging"},preferences:{type:"help",url:"preferences.html",title:"JS9 Site Preferences"},repfile:{type:"help",url:"repfile.html",title:"The PNG Represention File"},changelog:{type:"help",url:"changelog.html",title:"JS9 ChangeLog"},issues:{type:"help",url:"knownissues.html",title:"Known Issues"}};
a.menuButtonOptsArr=[{name:"file",label:"File"},{name:"view",label:"View"},{name:"zoom",label:"Zoom"},{name:"scale",label:"Scale"},{name:"color",label:"Color"},{name:"region",label:"Region"},{name:"wcs",label:"WCS"},{name:"analysis",label:"Analysis"},{name:"help",label:"Help"}];a.images=[];a.displays=[];a.colormaps=[];a.commands=[];a.plugins=[];a.preloads=[];a.auxFiles=[];a.publics={};a.helper={};a.fits={};a.userOpts={};a.scales="linear log pow sqrt squared asinh sinh".split(" ");a.wcssyss="FK4 FK5 ICRS galactic ecliptic native image physical".split(" ");
a.wcsunitss=["degrees","sexagesimal","pixels"];a.menubarHTML="";a.consoleHTML="<form name='form' onsubmit='return false;' class='JS9CmdForm' action=''><table class='JS9CmdTable'><tr class='JS9Tr'><td><div id='JS9CmdPrompt' class='JS9CmdPrompt'>@@PR@@</div></td><td class='JS9CmdTd'><input type='text' class='JS9CmdIn' autocomplete='off' value='' /></td></tr></table></form>";a.bugs={};a.bugs.hide_menu=!0;"Firefox"===a.BROWSER[0]&&0<=a.BROWSER[2].search(/Linux/)&&(a.bugs.firefox_linux=!0);"Chrome"===
a.BROWSER[0]&&(a.bugs.tval=parseInt(a.BROWSER[1].split(".").shift(),10),31<=a.bugs.tval&&33>=a.bugs.tval&&(a.bugs.chrome_31=!0));a.Image=function(d,b,c){var e,f,g,h,l=this,j=null,m=function(a,d){var b,c=[];void 0!==d.xcen&&c.push(d.xcen);void 0!==d.ycen&&c.push(d.ycen);void 0!==d.zoom&&(b=a.parseZoom(d.zoom))&&c.push(b);return c};b&&("object"===typeof b?(j=b,j.display&&(f=j.display)):f=b);f||(f=0<a.displays.length?a.displays[0].id:a.DEFID);this.type="image";this.display=a.lookupDisplay(f);this.params=
$.extend(!0,{},a.imageOpts,j);this.cmapObj=a.lookupColormap(this.params.colormap);this.displayMode=!0;this.evstate=-1;this.rclick=0;this.queried=!1;this.iy=this.ix=0;this.params.scalemin=Number.Nan;this.params.scalemax=Number.Nan;this.params.xeqonchange=!0;this.params.plotOpts=$.extend(!0,{},a.plotOpts);this.png={};this.png.image=new Image;this.status={};this.primary={};this.primary.sect={zoom:1,ozoom:1};this.layers={};this.lcs={};this.aux={};this.binning={bin:1,obin:1};this.updateshapes=!1;switch(typeof d){case "object":this.source=
"fits";this.mkRawDataFromHDU(d,d.filename);"zscale"===this.params.scaleclipping&&this.zscale(!0);this.mkSection();e=m(this,j);e.length&&this.mkSection.apply(this,e);this.displayImage("all");this.clearMessage();a.images.push(this);if(c)try{a.xeqByName(c,window,this)}catch(n){a.error("in image onload callback",n,!1)}for(g in this.display.pluginInstances)if(this.display.pluginInstances.hasOwnProperty(g)&&(h=this.display.pluginInstances[g],d=h.plugin.opts,h.isActive("onimageload")))try{d.onimageload.call(h,
this)}catch(r){h.errLog("onimageload",r)}this.updateshapes&&this.updateShapes("regions","all","update");this.status.load="complete";a.waiting(!1);break;case "string":this.source="fits2png";this.imtab="image";this.file=d;this.oid=this.file.split("/").reverse()[0];this.id=a.getImageID(this.oid,this.display.id);this.status.load="loading";a.waiting(!0);$(this.png.image).on("load",function(){var d,b,g;l.mkOffScreenCanvas();l.mkRawDataFromPNG();"zscale"===l.params.scaleclipping&&l.zscale(!0);l.mkSection();
e=m(l,j);e.length&&l.mkSection.apply(l,e);l.displayImage("all");l.clearMessage();a.images.push(l);if(c)try{a.xeqByName(c,window,l)}catch(f){a.error("in image onload callback",f,!1)}for(d in l.display.pluginInstances)if(l.display.pluginInstances.hasOwnProperty(d)&&(b=l.display.pluginInstances[d],g=b.plugin.opts,b.isActive("onimageload")))try{g.onimageload.call(b,l)}catch(n){h.errLog("onimageload",n)}l.status.load="complete";a.waiting(!1);a.DEBUG&&a.log("JS9 image: %s dims(%d,%d) min/max(%d,%d)",l.file,
l.raw.width,l.raw.height,l.raw.dmin,l.raw.dmax)}).on("error",function(){a.waiting(!1);l.status.load="error";a.error("could not load image: "+l.id)});this.png.image.src=d;break;default:a.log("unknown specification type for Load: "+typeof d)}};a.Image.prototype.closeImage=function(){var d,b,c,e,f,g;b=a.images.length;var h=this.display;for(d=0;d<b;d++)if(this===a.images[d]){b=a.images[d];b.clearMessage();b.display.context.clear();for(e in b.display.pluginInstances)if(b.display.pluginInstances.hasOwnProperty(e)&&
(f=b.display.pluginInstances[e],g=f.plugin.opts,f.isActive("onimageclose")))try{g.onimageclose.call(f,b)}catch(l){f.errLog("onimageclose",l)}for(c in b.layers)b.layers.hasOwnProperty(c)&&(b.layers[c].canvas.dispose(),b.layers[c]=null);b.display.image=null;switch(b.cmapObj.name){case "red":a.globalOpts.rgb.rim=null;break;case "green":a.globalOpts.rgb.gim=null;break;case "blue":a.globalOpts.rgb.bim=null}a.fits.cleanupFITSFile&&a.fits.cleanupFITSFile(b.raw.hdu.fits,!0);b.primary=null;b.offscreen=null;
b.raw=null;b.colorData=null;b.colorCells=null;b.psColors=null;a.images.splice(d,1);break}for(d=0;d<a.images.length;d++)if(b=a.images[d],h===b.display){b.displayImage("display");break}};a.Image.prototype.mkOffScreenCanvas=function(){if(!this.png||!this.png.image)return this;this.offscreen={};this.offscreen.canvas=document.createElement("canvas");this.offscreen.canvas.setAttribute("width",this.png.image.width);this.offscreen.canvas.setAttribute("height",this.png.image.height);this.offscreen.context=
this.offscreen.canvas.getContext("2d");a.ANTIALIAS||(this.offscreen.context.imageSmoothingEnabled=!1,this.offscreen.context.mozImageSmoothingEnabled=!1,this.offscreen.context.webkitImageSmoothingEnabled=!1);this.offscreen.context.drawImage(this.png.image,0,0,this.png.image.width,this.png.image.height,0,0,this.png.image.width,this.png.image.height);try{this.offscreen.img=this.offscreen.context.getImageData(0,0,this.png.image.width,this.png.image.height)}catch(d){"Chrome"===a.BROWSER[0]&&""===document.domain?
alert("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access data."):alert("could not read JS9 data")}return this};a.Image.prototype.initLCS=function(a){var b=[[0,0,0],[0,0,0],[0,0,0]],c=function(a){var d,b,c=0,l=0,j=[[0,0,0],[0,0,0],[0,0,0]],m=a[0][0]*a[1][1];for(d=0;3>d;d++)for(b=0;2>b;b++)if(void 0===a[d][b]||isNaN(a[d][b]))return null;0<=m?c+=m:l+=m;m=-a[0][1]*a[1][0];0<=m?c+=m:l+=m;d=c+l;if(0===d||1E-15>Math.abs(d/(c-l)))return null;
d=1/d;j[0][0]=a[1][1]*d;j[1][0]=-a[1][0]*d;j[0][1]=-a[0][1]*d;j[1][1]=a[0][0]*d;j[2][0]=-(a[2][0]*j[0][0]+a[2][1]*j[1][0]);j[2][1]=-(a[2][0]*j[0][1]+a[2][1]*j[1][1]);return j};a&&(b[0][0]=a.LTM1_1||1,b[1][0]=a.LTM2_1||0,b[0][1]=a.LTM1_2||0,b[1][1]=a.LTM2_2||1,b[2][0]=a.LTV1||0,b[2][1]=a.LTV2||0,this.lcs.physical={forward:$.extend(!0,[],b),reverse:c(b)},this.lcs.physical.reverse||delete this.lcs.physical,b[0][0]=a.DTM1_1||1,b[1][0]=a.DTM2_1||0,b[0][1]=a.DTM1_2||0,b[1][1]=a.DTM2_2||1,b[2][0]=a.DTV1||
0,b[2][1]=a.DTV2||0,this.lcs.detector={forward:$.extend(!0,[],b),reverse:c(b)},this.lcs.detector.reverse||delete this.lcs.detector,b[0][0]=a.ATM1_1||1,b[1][0]=a.ATM2_1||0,b[0][1]=a.ATM1_2||0,b[1][1]=a.ATM2_2||1,b[2][0]=a.ATV1||0,b[2][1]=a.ATV2||0,this.lcs.amplifier={forward:$.extend(!0,[],b),reverse:c(b)},this.lcs.amplifier.reverse||delete this.lcs.amplifier,this.lcs[this.params.lcs]||(this.params.lcs="image"),this.params.wcssys0||(this.setWCSSys("physical"),this.params.wcssys0=this.params.lcs))};
a.Image.prototype.mkRawDataFromIMG=function(a){var b,c,e,f,g,h;if(a){b=a.height;c=a.width;e=a.data;this.raw.data=new Float32Array(b*c);for(g=a=0;g<b;g++)for(f=0;f<c;f++)h=0.299*e[a]+0.587*e[a+1]+0.114*e[a+2],this.raw.data[(b-g)*c+f]=h,a+=4;this.raw.width=c;this.raw.height=b;this.raw.bitpix=-32;this.raw.dmin=Number.MAX_VALUE;this.raw.dmax=Number.MIN_VALUE;for(a=0;a<b*c;a++)isNaN(this.raw.data[a])||(this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[a]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[a]));
isNaN(this.params.scalemin)&&(this.params.scalemin=this.raw.dmin);isNaN(this.params.scalemax)&&(this.params.scalemax=this.raw.dmax);this.source="png";this.raw.header=null;return this}};a.Image.prototype.mkRawDataFromPNG=function(){var d,b,c,e,f,g,h,l;h=[];c=new ArrayBuffer(8);var j=new Uint8Array(c),m=new DataView(c);if(!this.offscreen.img)return this;this.raw={};e=this.offscreen.img.data;for(d=c=0;c<e.length&&0!==e[c];c++)if(255!==e[c]&&(h[d]=String.fromCharCode(e[c]),d++),15===d&&'{"js9Protocol":'!==
h.join("")){f=!0;break}if(15>d||f)this.mkRawDataFromIMG(this.offscreen.img),this.offscreen.img=null;else{d=h.join("");2<a.DEBUG&&a.log("jsonHeader: %s",d);try{b=JSON.parse(d)}catch(n){a.error("can't read FITS header from PNG file: "+d,n)}if(1===b.js9Protocol)this.raw.header=b,this.raw.endian=this.raw.header.js9Endian,this.raw.protocol=this.raw.header.js9Protocol;else{this.raw.endian=b.js9Endian;this.raw.protocol=b.js9Protocol;this.raw.cardstr=b.cardstr;this.raw.ncard=b.ncard;this.raw.header={};b=
this.raw.ncard;for(d=0;d<b;d++)f=this.raw.cardstr.slice(80*d,80*(d+1)),f=a.cardpars(f),void 0!==f&&(this.raw.header[f[0]]=f[1])}c+=1;this.raw.header.NAXIS1?this.raw.width=this.raw.header.NAXIS1:a.error("NAXIS1 missing from PNG-based FITS header");this.raw.header.NAXIS2?this.raw.height=this.raw.header.NAXIS2:a.error("NAXIS2 missing from PNG-based FITS header");this.raw.header.BITPIX?this.raw.bitpix=this.raw.header.BITPIX:a.error("BITPIX missing from PNG-based FITS header");"little"===this.raw.endian?
l=!0:"big"===this.raw.endian?l=!1:a.error("js9Endian missing from PNG-based FITS header");this.object=this.raw.header.OBJECT;this.raw.dmin=Number.MAX_VALUE;this.raw.dmax=Number.MIN_VALUE;b=this.raw.width*this.raw.height;f=c%4;switch(this.raw.bitpix){case 8:this.raw.data=new Uint8Array(b);for(d=0;d<b;d++){switch(f){case 0:g=e[c];c+=1;f=1;break;case 1:g=e[c];c+=1;f=2;break;case 2:g=e[c];c+=2;f=0;break;case 3:g=e[c+1],c+=2,f=1}this.raw.data[d]=g;isNaN(g)||(this.raw.dmin=Math.min(this.raw.dmin,g),this.raw.dmax=
Math.max(this.raw.dmax,g))}break;case 16:case -16:16===this.raw.bitpix?(this.raw.data=new Int16Array(b),h=DataView.prototype.getInt16):(this.raw.data=new Uint16Array(b),h=DataView.prototype.getUint16);for(d=0;d<b;d++){switch(f){case 0:j[0]=e[c];j[1]=e[c+1];g=h.call(m,0,l);c+=2;f=2;break;case 1:j[0]=e[c];j[1]=e[c+1];g=h.call(m,0,l);c+=3;f=0;break;case 2:j[0]=e[c];j[1]=e[c+2];g=h.call(m,0,l);c+=3;f=1;break;case 3:j[0]=e[c+1],j[1]=e[c+2],g=h.call(m,0,l),c+=3,f=2}this.raw.data[d]=g;isNaN(g)||(this.raw.dmin=
Math.min(this.raw.dmin,g),this.raw.dmax=Math.max(this.raw.dmax,g))}break;case 32:case -32:32===this.raw.bitpix?(this.raw.data=new Int32Array(b),h=DataView.prototype.getInt32):(this.raw.data=new Float32Array(b),h=DataView.prototype.getFloat32);for(d=0;d<b;d++){switch(f){case 0:j[0]=e[c];j[1]=e[c+1];j[2]=e[c+2];j[3]=e[c+4];g=h.call(m,0,l);c+=5;f=1;break;case 1:j[0]=e[c];j[1]=e[c+1];j[2]=e[c+3];j[3]=e[c+4];g=h.call(m,0,l);c+=5;f=2;break;case 2:j[0]=e[c];j[1]=e[c+2];j[2]=e[c+3];j[3]=e[c+4];g=h.call(m,
0,l);c+=6;f=0;break;case 3:j[0]=e[c+1],j[1]=e[c+2],j[2]=e[c+3],j[3]=e[c+5],g=h.call(m,0,l),c+=6,f=1}this.raw.data[d]=g;isNaN(g)||(this.raw.dmin=Math.min(this.raw.dmin,g),this.raw.dmax=Math.max(this.raw.dmax,g))}break;case -64:this.raw.data=new Float64Array(b);for(d=0;d<b;d++){switch(f){case 0:case 4:j[0]=e[c];j[1]=e[c+1];j[2]=e[c+2];j[3]=e[c+4];j[4]=e[c+5];j[5]=e[c+6];j[6]=e[c+8];j[7]=e[c+9];g=m.getFloat64(0,l);c+=10;f=2;break;case 1:case 5:j[0]=e[c];j[1]=e[c+1];j[2]=e[c+3];j[3]=e[c+4];j[4]=e[c+5];
j[5]=e[c+7];j[6]=e[c+8];j[7]=e[c+9];g=m.getFloat64(0,l);c+=11;f=0;break;case 2:case 6:j[0]=e[c];j[1]=e[c+2];j[2]=e[c+3];j[3]=e[c+4];j[4]=e[c+6];j[5]=e[c+7];j[6]=e[c+8];j[7]=e[c+10];g=m.getFloat64(0,l);c+=11;f=1;break;case 3:case 7:j[0]=e[c+1],j[1]=e[c+2],j[2]=e[c+3],j[3]=e[c+5],j[4]=e[c+6],j[5]=e[c+7],j[6]=e[c+9],j[7]=e[c+10],g=m.getFloat64(0,l),c+=11,f=2}this.raw.data[d]=g;isNaN(g)||(this.raw.dmin=Math.min(this.raw.dmin,g),this.raw.dmax=Math.max(this.raw.dmax,g))}break;default:a.error("unsupported bitpix in PNG file: "+
this.raw.bitpix)}isNaN(this.params.scalemin)&&(this.params.scalemin=this.raw.dmin);isNaN(this.params.scalemax)&&(this.params.scalemax=this.raw.dmax);this.offscreen.img=null;this.wcs=a.initwcs(a.raw2FITS(this.raw));0<this.wcs&&(this.setWCSSys(this.params.wcssys),this.params.wcssys0=this.params.wcssys.trim());this.initLCS(this.raw.header);return this}};a.Image.prototype.mkRawDataFromHDU=function(d,b){var c,e,f,g;$.isArray(d)||a.isTypedArray(d)||d instanceof ArrayBuffer?($.isArray(d[0])&&(d=d.reduce(function(a,
d){return a.concat(d)})),g={image:d}):"object"===typeof d?g=d:a.error("unknown or missing input for HDU creation");g.data&&!g.image&&(g.image=g.data);g.image||a.error("data missing from JS9 FITS object"+JSON.stringify(g));2>g.naxis&&a.error("can't image a FITS file with less than 2 dimensions");b?this.file=b:g.filename&&(this.file=g.filename);this.file=this.file||a.ANON;this.id||(this.oid=this.file.split("/").reverse()[0],this.id=a.getImageID(this.oid,this.display.id));this.raw&&(c=this.raw.width,
e=this.raw.height,f=this.raw.bitpix);this.raw={};this.raw.hdu=g;g.axis?(this.raw.width=g.axis[1],this.raw.height=g.axis[2]):g.naxis1&&g.naxis2?(this.raw.width=g.naxis1,this.raw.height=g.naxis2):c&&e&&(this.raw.width=c,this.raw.height=e);g.bitpix?this.raw.bitpix=g.bitpix:f&&(this.raw.bitpix=f);if("base64"===g.encoding){e=window.atob(g.image);g.image=new ArrayBuffer(e.length);f=new Uint8Array(g.image);for(c=0;c<e.length;c++)f[c]=e.charCodeAt(c)}$.isArray(g.image[0])&&(g.image=g.image.reduce(function(a,
d){return a.concat(d)}));switch(this.raw.bitpix){case 8:this.raw.data=new Uint8Array(g.image);break;case 16:this.raw.data=new Int16Array(g.image);break;case -16:this.raw.data=new Uint16Array(g.image);break;case 32:this.raw.data=new Int32Array(g.image);break;case -32:this.raw.data=new Float32Array(g.image);break;case -64:this.raw.data=new Float64Array(g.image)}this.raw.card=g.card;this.raw.cardstr=g.cardstr;this.raw.ncard=g.ncard;if(g.head)this.raw.header=g.head;else if(this.raw.card){this.raw.header=
{};e=this.raw.card.length;for(c=0;c<e;c++)f=a.cardpars(this.raw.card[c]),void 0!==f&&(this.raw.header[f[0]]=f[1])}else if(this.raw.cardstr){this.raw.header={};e=this.raw.ncard;for(c=0;c<e;c++)f=this.raw.cardstr.slice(80*c,80*(c+1)),f=a.cardpars(f),void 0!==f&&(this.raw.header[f[0]]=f[1])}else this.raw.header={},this.raw.header.SIMPLE=!0,this.raw.header.NAXIS=2,this.raw.header.NAXIS1=this.raw.width,this.raw.header.NAXIS2=this.raw.height,this.raw.header.BITPIX=this.raw.bitpix;if(g.dmin&&g.dmax)this.raw.dmin=
g.dmin,this.raw.dmax=g.dmax;else{this.raw.dmin=Number.MAX_VALUE;this.raw.dmax=Number.MIN_VALUE;e=this.raw.width*this.raw.height;for(c=0;c<e;c++)isNaN(this.raw.data[c])||(this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[c]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[c]))}this.imtab=g.imtab?g.imtab:g.table?"table":"image";this.object=this.raw.header.OBJECT;this.binning.bin="table"===this.imtab&&g.table?Number(g.table.bin)||1:1;this.wcs=a.initwcs(a.raw2FITS(this.raw));0<this.wcs&&(this.setWCSSys(this.params.wcssys),
this.params.wcssys0=this.params.wcssys.trim(),this.setWCSUnits(this.params.wcsunits));this.initLCS(this.raw.header);if(isNaN(this.params.scalemin)||"dataminmax"===this.params.scaleclipping)this.params.scalemin=this.raw.dmin;if(isNaN(this.params.scalemax)||"dataminmax"===this.params.scaleclipping)this.params.scalemax=this.raw.dmax;return this};a.Image.prototype.mkSection=function(a,b,c){var e=this.primary.sect;switch(arguments.length){case 0:e.xcen=Math.floor(this.raw.width/2);e.ycen=Math.floor(this.raw.height/
2);e.width=Math.min(this.raw.width,this.display.canvas.width);e.height=Math.min(this.raw.height,this.display.canvas.height);break;case 1:e.ozoom=e.zoom;e.zoom=a;e.width=Math.min(this.raw.width*e.zoom,this.display.canvas.width);e.height=Math.min(this.raw.height*e.zoom,this.display.canvas.height);break;case 2:e.xcen=parseInt(a,10);e.ycen=parseInt(b,10);break;case 3:e.ozoom=e.zoom,e.xcen=parseInt(a,10),e.ycen=parseInt(b,10),e.zoom=c,e.width=Math.min(this.raw.width*e.zoom,this.display.canvas.width),e.height=
Math.min(this.raw.height*e.zoom,this.display.canvas.height)}e.width=Math.floor(e.width);e.height=Math.floor(e.height);e.x0=Math.floor(e.xcen-(e.width+1)/(2*e.zoom)+1);e.y0=Math.floor(e.ycen-(e.height+1)/(2*e.zoom)+1);e.x1=Math.floor(e.xcen+e.width/(2*e.zoom));e.y1=Math.floor(e.ycen+e.height/(2*e.zoom));0>e.x0&&(e.x1-=e.x0,e.x0=0);0>e.y0&&(e.y1-=e.y0,e.y0=0);e.x1>this.raw.width&&(e.x0-=e.x1-this.raw.width,e.x1=this.raw.width);e.y1>this.raw.height&&(e.y0-=e.y1-this.raw.height,e.y1=this.raw.height);
e.x0=Math.max(0,e.x0);e.y0=Math.max(0,e.y0)};a.Image.prototype.mkColorData=function(){var d,b,c=a.SCALESIZE,e=this.params.scalemin,f=this.params.scalemax,g=this.raw.width*this.raw.height,h=(c-1)/(f-e);this.colorData||(this.colorData=[]);for(d=0;d<g;d++)b=this.raw.data[d],this.colorData[d]=b<=e?0:b>=f?c-1:Math.floor((b-e)*h+0.5);return this};a.Image.prototype.calcContrastBias=function(d){var b=a.COLORSIZE,c=this.params.bias,e=this.params.contrast;if(1E-4>c-0.5&&1E-4>e-1)return d;this.params.invert&&
(c=1-c);d=Math.floor(((d/b-c)*e+0.5)*b);return 0>d?0:d>=b?b-1:d};a.Image.prototype.mkColorCells=function(){var d,b,c=a.COLORSIZE;this.colorCells||(this.colorCells=[]);for(d=0;d<c;d++)b=this.params.invert?c-d-1:d,b=this.calcContrastBias(b),this.colorCells[d]=this.cmapObj.mkColorCell(b);return this};a.Image.prototype.mkScaledCells=function(){var d,b,c,e=a.COLORSIZE,f=a.SCALESIZE;if(!this.colorCells)return this;if(!this.psColors){c=this.psColors=[];b=this.params.nancolor;var g,h,l,j=[];"#"===b.charAt(0)&&
(b=b.slice(1));b=b.toUpperCase();for(g=d=0;6>d;d+=2,g++)h="0123456789ABCDEF".indexOf(b.charAt(d)),l="0123456789ABCDEF".indexOf(b.charAt(d+1)),j[g]=16*h+l;c[NaN]=j}switch(this.params.scale){case "linear":for(c=0;c<f;c++)d=c/f,d=Math.floor(d*e),this.psColors[c]=this.colorCells[d];break;case "log":b=this.params.exp;for(c=0;c<f;c++)d=Math.log(b*c/f+1)/Math.log(b),d=Math.floor(d*e),d>=e&&(d=e-1),this.psColors[c]=this.colorCells[d];break;case "pow":b=this.params.exp;for(c=0;c<f;c++)d=(Math.pow(b,c/f)-1)/
b,d=Math.floor(d*e),d>=e&&(d=e-1),this.psColors[c]=this.colorCells[d];break;case "sqrt":for(c=0;c<f;c++)d=c/f,d=Math.floor(Math.sqrt(d*e)),this.psColors[c]=this.colorCells[d];break;case "squared":for(c=0;c<f;c++)d=c/f,d=Math.floor(d*d*e),this.psColors[c]=this.colorCells[d];break;case "asinh":for(c=0;c<f;c++)d=c/f,b=10*d,d=Math.floor(Math.log(b+Math.sqrt(b*b+1))/3*e),d>=e&&(d=e-1),this.psColors[c]=this.colorCells[d];break;case "sinh":for(c=0;c<f;c++)d=c/f,b=3*d,d=Math.floor((Math.exp(b)-Math.exp(-b))/
2/10*e),d>=e&&(d=e-1),this.psColors[c]=this.colorCells[d];break;default:a.log("unknown scale '"+this.params.scale+"'")}return this};a.Image.prototype.mkPrimaryImage=function(){var d,b,c,e,f,g,h,l,j,m,n,r,k,q,p,s,t,u,w,E,y=this,x=this,z=this,A=!1;if(!this.primary||!this.psColors)return this;if(a.globalOpts.rgb.mode&&(this===a.globalOpts.rgb.rim||this===a.globalOpts.rgb.gim||this===a.globalOpts.rgb.bim))A=!0;A&&(y=a.globalOpts.rgb.rim,x=a.globalOpts.rgb.gim,z=a.globalOpts.rgb.bim);d=this.primary;b=
d.sect;if(!d.img||d.img.width!==b.width||d.img.height!==b.height)d.img=this.display.context.createImageData(b.width,b.height);d=d.img;p=this.params.alpha;this.maskData&&(this.params.maskInvert?(s=this.params.alpha2,t=this.params.alpha1):(s=this.params.alpha1,t=this.params.alpha2));e=b.y1-1;for(g=0;e>=b.y0;e--,g++){k=e*this.raw.width;l=g*b.zoom;c=b.x0;for(f=0;c<b.x1;c++,f++){A?(y&&(u=y.colorData[k+c]),x&&(w=x.colorData[k+c]),z&&(E=z.colorData[k+c])):n=this.colorData[k+c];this.maskData&&(p=0<this.maskData[k+
c]?s:t);h=f*b.zoom;for(j=0;j<b.zoom;j++){m=Math.floor(l+j);q=m*b.width;for(m=0;m<b.zoom;m++)r=Math.floor(h+m),r=4*(q+r),A?(d.data[r]=y?y.psColors[u][0]:0,d.data[r+1]=x?x.psColors[w][1]:0,d.data[r+2]=z?z.psColors[E][2]:0):(d.data[r]=this.psColors[n][0],d.data[r+1]=this.psColors[n][1],d.data[r+2]=this.psColors[n][2]),d.data[r+3]=p}}}return this};a.Image.prototype.displayImage=function(a){var b,c;c=this.primary;var e=this.display,f={},g=function(a){a=a.trim();f[a]=!0;switch(a){case "colors":f.scaled=
!0;f.primary=!0;break;case "scaled":f.primary=!0}};if(!1===a)this.displayMode=!1;else if(!0===a&&(this.displayMode=!0,a="all"),this.displayMode){a?"all"===a?(a="colors,scaled,primary,display,plugins",f.notify=!0):"display"===a&&(f.notify=!0):a="primary";a.split(",").forEach(g);f.display=!0;f.plugins=!0;f.colors&&this.mkColorData();f.scaled&&(this.mkColorCells(),this.mkScaledCells());f.primary&&this.mkPrimaryImage();f.display&&(this.ix=Math.floor((e.canvas.width-c.img.width)/2),this.iy=Math.floor((e.canvas.height-
c.img.height)/2),e.context.clear(),e.context.putImageData(c.img,this.ix,this.iy),this.displayShapeLayers(),f.notify&&this.notifyHelper(),e.image=this);if(f.plugins)for(b in this.display.pluginInstances)if(this.display.pluginInstances.hasOwnProperty(b)&&(a=this.display.pluginInstances[b],c=a.plugin.opts,a.isActive("onimagedisplay")))try{c.onimagedisplay.call(a,this)}catch(h){a.errLog("onimagedisplay",h)}return this}};a.Image.prototype.refreshImage=function(d,b){var c,e,f,g,h,l,j;!b&&a.imageOpts.onrefresh&&
(b=a.imageOpts.onrefresh);e=this.primary.sect.xcen;f=this.primary.sect.ycen;l=this.primary.sect.zoom;g=this.raw.width;h=this.raw.height;this.binning.obin=this.binning.bin;this.mkRawDataFromHDU(d);this.raw.width===g&&this.raw.height===h?this.mkSection(e,f,l):(this.mkSection(),this.mkSection(l));this.displayImage("colors");for(c in this.layers)this.layers.hasOwnProperty(c)&&this.layers[c].show&&this.refreshShapes(c);this.updateShapes("regions","all","binning");if(b)try{a.xeqByName(b,window,this)}catch(m){a.error("in image refresh callback",
m)}for(j in this.display.pluginInstances)if(this.display.pluginInstances.hasOwnProperty(j)&&(c=this.display.pluginInstances[j],e=c.plugin.opts,c.isActive("onimagerefresh")))try{e.onimagerefresh.call(c,this)}catch(n){c.errLog("onimagerefresh",n)}};a.Image.prototype.getPan=function(){return{x:(this.primary.sect.x0+this.primary.sect.x1)/2+1,y:(this.primary.sect.y0+this.primary.sect.y1)/2+1}};a.Image.prototype.setPan=function(a,b){var c;0===arguments.length&&(a=this.raw.width/2,b=this.raw.height/2);this.mkSection(a,
b);this.displayImage("primary");for(c in this.layers)this.layers.hasOwnProperty(c)&&this.layers[c].show&&this.layers[c].opts.panzoom&&this.refreshShapes(c);return this};a.Image.prototype.getZoom=function(){return this.primary.sect.zoom};a.Image.prototype.parseZoom=function(a){var b;b=this.primary.sect.zoom;switch(typeof a){case "string":switch(a.charAt(0)){case "*":case "x":case "X":a=b*parseFloat(a.slice(1));break;case "/":a=b/parseFloat(a.slice(1));break;case "I":case "i":a=2*b;break;case "O":case "o":a=
b/2;break;case "T":case "t":a=Math.min(this.display.width,this.display.height)/Math.max(this.raw.width,this.raw.height);break;default:a=parseFloat(a)}break;case "number":break;default:return}return a};a.Image.prototype.setZoom=function(a){var b;if(a=this.parseZoom(a)){this.mkSection(a);this.displayImage("primary");for(b in this.layers)this.layers.hasOwnProperty(b)&&this.layers[b].show&&this.layers[b].opts.panzoom&&this.refreshShapes(b);return this}};a.Image.prototype.imageToLogicalPos=function(a,
b){var c,e=a.x,f=a.y,g="image";b=b||this.params.lcs||"image";switch(b){case "physical":this.lcs.physical&&(g=b,c=this.lcs.physical.reverse);break;case "detector":this.lcs.detector&&(g=b,c=this.lcs.detector.reverse);break;case "amplifier":this.lcs.amplifier&&(g=b,c=this.lcs.amplifier.reverse)}c&&(e=a.x*c[0][0]+a.y*c[1][0]+c[2][0],f=a.x*c[0][1]+a.y*c[1][1]+c[2][1]);return{x:e,y:f,sys:g}};a.Image.prototype.logicalToImagePos=function(a,b){var c,e={x:a.x,y:a.y};b=b||this.params.lcs||"image";switch(b){case "physical":this.lcs.physical&&
(c=this.lcs.physical.forward);break;case "detector":this.lcs.detector&&(c=this.lcs.detector.forward);break;case "amplifier":this.lcs.amplifier&&(c=this.lcs.amplifier.forward)}c&&(e.x=a.x*c[0][0]+a.y*c[1][0]+c[2][0],e.y=a.x*c[0][1]+a.y*c[1][1]+c[2][1]);return e};a.Image.prototype.displayToImagePos=function(a){var b=this.primary,c=this.primary.sect,e={};1>=c.zoom?(e.x=(a.x-this.ix)/c.zoom+c.x0+1,e.y=(b.img.height-1-(a.y-this.iy))/c.zoom+c.y0+1):(e.x=(a.x-this.ix)/c.zoom+c.x0+1-0.5,e.y=(b.img.height-
1-(a.y-this.iy))/c.zoom+c.y0+1-0.5);return e};a.Image.prototype.imageToDisplayPos=function(a){var b=this.primary,c=this.primary.sect,e={};1>=c.zoom?(e.x=(a.x-1-c.x0)*c.zoom+this.ix,e.y=(c.y0-(a.y-1))*c.zoom+(b.img.height-1)+this.iy):(e.x=(a.x-1+0.5-c.x0)*c.zoom+this.ix,e.y=(c.y0-(a.y-1+0.5))*c.zoom+(b.img.height-1)+this.iy);return e};a.Image.prototype.logicalToDisplayPos=function(a){return this.imageToDisplayPos(this.logicalToImagePos(a))};a.Image.prototype.displayToLogicalPos=function(a){return this.imageToLogicalPos(this.displayToImagePos(a))};
a.Image.prototype.getWCSSys=function(){if(this.params.wcssys)return this.params.wcssys};a.Image.prototype.setWCSSys=function(d){if("image"===d)this.params.wcssys="image",this.params.wcsunits="pixels";else if("physical"===d)this.params.wcssys="physical",this.params.wcsunits="pixels";else if(this.wcs&&0<this.wcs){"native"===d&&(d=this.params.wcssys0);if(d=a.wcssys(this.wcs,d))this.params.wcssys=d.trim(),d="pixels"===this.params.wcsunits?a.imageOpts.wcsunits:this.params.wcsunits,this.setWCSUnits(d),
this.updateShapes("regions","all","update");return this}};a.Image.prototype.getWCSUnits=function(){return this.params.wcsunits?this.params.wcsunits:"pixels"};a.Image.prototype.setWCSUnits=function(d){var b;if("pixels"===d)this.params.wcssys="physical",this.params.wcsunits="pixels";else{if(this.wcs&&0<this.wcs){if("image"===this.params.wcssys||"physical"===this.params.wcssys)b=a.imageOpts.wcssys,this.setWCSSys(this.wcs,b);if(d=a.wcsunits(this.wcs,d))this.params.wcsunits=d.trim(),this.updateShapes("regions",
"all","update")}return this}};a.Image.prototype.notifyHelper=function(){var d,b=this;a.helper.connected&&this.file!==a.ANON&&a.helper.send("image",{image:this.file},function(c){var e,f,g;"object"===typeof c?(e=c.stdout,c.stderr&&1<a.DEBUG&&a.log(c.stderr)):e=c;if(e){e=e.trim().split(/ +/);if((c=a.lookupImage(e[0],b.display.id||a.DEFID))&&!c.fitsFile){f=e[1];if("?"!==f){if(a.analOpts.dataDir)g=f.lastIndexOf("/")+1,c.fitsFile=a.analOpts.dataDir+"/"+f.slice(g);else{c.fitsFile=f;if(0>c.fitsFile.indexOf("/")&&
(d=c.file.match(/.*\//)))c.fitsFile=d+c.fitsFile;a.analOpts.prependJS9Dir&&"/"!==c.fitsFile.charAt(0)&&(c.fitsFile="$JS9_DIR/"+c.fitsFile)}1<a.DEBUG&&a.log("JS9 fitsFile: %s %s",c.file,c.fitsFile)}e=e[2];"?"!==e&&(c.fitsExt=e.match(/\[.*\]/))}b.queried||(b.queryHelper("all"),b.queried=!0)}});return this};a.Image.prototype.queryHelper=function(d){var b=this;d=d||"all";if(a.helper.connected&&("all"===d||"getAnalysis"===d))this.analysisPackages||a.helper.send("getAnalysis",{fits:this.fitsFile},function(c){if(c)try{b.analysisPackages=
JSON.parse(c)}catch(d){a.log("can't get analysis",d)}});return this};a.Image.prototype.expandMacro=function(d,b){var c,e,f=this;if(d)return c=d.replace(/\$(\w+)/g,function(c,d){var l,j;switch(d){case "id":j=f.display.divjq.attr("id");break;case "png":j=f.id;break;case "filename":f.fitsFile||a.error("no FITS file for "+f.id);j=f.fitsFile;"table"===f.imtab&&f.raw.hdu.table.filter&&(j+="[EVENTS]["+f.raw.hdu.table.filter+"]");break;case "ext":j=f.fitsExt||"[]";break;case "sregions":j=f.listRegions("source",
0).replace(/\s+/g,"");break;case "bregions":j=f.listRegions("background",0).replace(/\s+/g,"");break;case "regions":j=f.listRegions("all",0).replace(/\s+/g,"");break;default:if(b){e=b.length;for(l=0;l<e;l++)if(b[l].name===d){j=b[l].value;break}j||(j="false")}j||(j=c)}return j})};a.Image.prototype.lookupAnalysis=function(a){var b,c,e,f=null;if(this.analysisPackages){for(c=0;c<this.analysisPackages.length&&!f;c++){e=this.analysisPackages[c];for(b=0;b<e.length;b++){f=e[b];if(f.xclass&&f.xclass+":"+f.name===
a)break;f=null}}if(f)return f;for(c=0;c<this.analysisPackages.length&&!f;c++){e=this.analysisPackages[c];for(b=0;b<e.length;b++){f=e[b];if(f.name===a)break;f=null}}}return f};a.Image.prototype.runAnalysis=function(d,b,c){var e,f=this,g={};if(a.helper.connected&&this.analysisPackages)if(e=this.lookupAnalysis(d)){e.action&&(g.cmd=this.expandMacro(e.action,b));if(e.keys){g.keys={};for(d=0;d<e.keys.length;d++)g.keys[e.keys[d]]=this.expandMacro("$"+e.keys[d],b)}g.id=this.expandMacro("$id");g.image=this.file;
g.fits=this.fitsFile;g.rtype=e.rtype;switch(a.helper.type){case "nodejs":case "socket.io":b=e.xclass?e.xclass+":"+e.name:e.name;break;default:b="runAnalysis"}a.helper.send(b,g,function(b){var d;d="object"===typeof b?b:0<=b.search(a.analOpts.epattern)?{stderr:b}:{stdout:b};d.errcode=d.errcode||0;if(c)c(d.stdout,d.stderr,d.errcode,e);else{if(d.errcode||d.stderr)b=d.stderr?d.stderr:sprintf("ERROR: while executing %s [%s]",e.name,d.errcode),a.error(b,a.analOpts.epattern);switch(e.rtype){case "text":case void 0:f.displayAnalysis("text",
d.stdout);break;case "plot":f.displayAnalysis("plot",d.stdout);break;case "alert":d.stdout&&alert(d.stdout);break;case "fits":a.Load(d.stdout,{display:f.display});break;case "png":a.Load(d.stdout,{display:f.display});break;case "none":break;default:a.error("unknown analysis result type: "+e.rtype)}}})}else a.error("could not find analysis task: "+d)};a.Image.prototype.displayAnalysis=function(d,b,c){var e,f,g,h=a.lightOpts[a.LIGHTWIN];c=c||"AnalysisResults: "+(this.fitsFile||this.id);e="Analysis_"+
a.uniqueID();switch(d){case "text":f="<div class='JS9Analysis'></div>";b&&(f+="<pre class='JS9AnalysisText'>"+b+"</pre>");f=a.lightWin(e,"inline",f+"</div>",c,h.textWin);break;case "plot":try{g=JSON.parse(b)}catch(l){a.error("can't plot return data: "+b,l)}if(!g)return;f=sprintf("<div id='%s' class='JS9Analysis'><div id='%sPlot' class='JS9Plot' ></div></div>",e,e);f=a.lightWin(e,"inline",f,c,h.plotWin);b=$("#"+e+" #"+e+"Plot");if(g.data)try{$.plot(b,[g],this.params.plotOpts)}catch(j){a.error("can't plot data",
j)}break;case "params":f=a.lightWin(e,"ajax",b,c,h.paramWin);break;case "dpath":f=a.lightWin(e,"ajax",b,c,h.dpathWin)}return f};a.Image.prototype.loadAuxFile=function(d,b){var c=this,e,f,g,h,l=a.auxFiles.length,j=[],m=function(){c.aux[f.name]=f;a.Image.prototype.mkOffScreenCanvas.call(h);a.Image.prototype.mkRawDataFromPNG.call(h);if(b)try{a.xeqByName(b,window,c,f)}catch(d){a.error("in aux mask onload callback",d)}a.DEBUG&&a.log("JS9 %s: %s dims(%d,%d) min/max(%d,%d)",h.type,h.file,h.raw.width,h.raw.height,
h.raw.dmin,h.raw.dmax)},n=function(d){c.aux[f.name]=f;f.regions=d;if(b)try{a.xeqByName(b,window,c,f)}catch(g){a.error("in aux region onload callback",g)}},r=function(d){c.aux[f.name]=f;f.text=d;if(b)try{a.xeqByName(b,window,c,f)}catch(g){a.error("in aux text onload callback",g)}},k=function(b,d){a.log(sprintf("could not load auxiliary file: %s [%s]",f.url,d))};if(d&&l){for(e=0;e<l;e++)f=a.auxFiles[e],f.image&&!f.regex&&(f.regex=RegExp(f.image));g=d.split(":");for(e=0;e<l;e++)if(f=a.auxFiles[e],g[0]===
f.name&&this.id.match(f.regex)&&(1===g.length||g[1]===f.type))switch(f.type){case "mask":if(f.im){if(this.aux[f.name]=f,b)try{a.xeqByName(b,window,this,f)}catch(q){a.error("in aux mask callback",q)}}else j.push(f);break;case "regions":if(f.layer){if(this.aux[f.name]=f,b)try{a.xeqByName(b,window,this,f)}catch(p){a.error("in aux regions callback",p)}}else j.push(f);break;case "text":if(f.text){if(this.aux[f.name]=f,b)try{a.xeqByName(b,window,this,f)}catch(s){a.error("in aux text callback",s)}}else j.push(f)}for(e=
0;e<j.length;e++)switch(f=j[e],f.type){case "mask":f.im={};h=f.im;h.type="aux";h.file=f.url;h.id=h.file.split("/").reverse()[0];h.params={};h.params.scalemin=Number.Nan;h.params.scalemax=Number.Nan;h.png={};h.png.image=new Image;$(h.png.image).on("load",m).on("error",k);h.png.image.src=a.InstallDir(f.url);break;case "regions":f.layer=this.display.newShapeLayer(d,a.Regions.opts);g=a.InstallDir(f.url);$.ajax({url:g,cache:!1,dataType:"json",success:n,error:k});break;case "text":g=a.InstallDir(f.url),
$.ajax({url:g,cache:!1,dataType:"text",success:r,error:k})}}};a.Image.prototype.saveFITS=function(d){var b,c,e,f,g,h,l,j,m,n;if(window.hasOwnProperty("saveAs")){m=this.raw.data.buffer;d=d||"js9.fits";h=a.raw2FITS(this.raw);l=2880-h.length%2880;2880===l&&(l=0);for(b=0;b<l;b++)h+=" ";l=2880-m.byteLength%2880;2880===l&&(l=0);j=new ArrayBuffer(h.length+m.byteLength+l);j=new Uint8Array(j);for(b=0;b<h.length;b++)j[b]=h.charCodeAt(b);if(b=0<(new Int8Array((new Int16Array([1])).buffer))[0]){g=h.length;f=
Math.abs(this.raw.bitpix)/8;n=new Uint8Array(m);for(b=0;b<n.byteLength;b+=f){c=b+f-1;for(e=0;e<f;c--,e++)j[g++]=n[c]}}else j.set(new Uint8Array(m),h.length);g=h.length+m.byteLength;for(b=0;b<l;b++)j[g++]=0;h=new Blob([j],{type:"application/octet-binary"});saveAs(h,d)}else a.error("no saveAs function available to save FITS file")};a.Image.prototype.savePNG=function(d){window.hasOwnProperty("saveAs")?(d=d||"js9.png",this.display.canvas.toBlob(function(a){saveAs(a,d)})):a.error("no saveAs function available to save PNG file")};
a.Image.prototype.updateValpos=function(d,b){var c,e,f,g,h;c=null;e=function(a,b){return a.toFixed(b||3)};f=function(a,b){var d="",c="";0>a&&(a=Math.abs(a),c="-");for(d+=a;d.length<b;)d="0"+d;return c+d};if(this.params.valpos){void 0===b&&(b=!0);if(this.valpos)return b&&this.displayMessage("info",this.valpos),this.valpos;g={x:d.x,y:d.y,sys:"image"};h="image"===this.params.wcssys?g:this.imageToLogicalPos(d);c=this.raw.data[Math.floor(d.y-0.5)*this.raw.width+Math.floor(d.x-0.5)];switch(this.raw.bitpix){case 8:case 16:case -16:case 32:f=
f(c,3);break;case -32:f=e(c,3);break;case -64:f=e(c,6);break;default:f=f(c,3)}e="value("+f+") "+h.sys+"("+e(h.x)+", "+e(h.y)+")";c={ix:g.x,iy:g.y,isys:"image",px:h.x,py:h.y,psys:h.sys,ra:"",dec:"",wcssys:"",val:c,val3:f,vstr:e,id:this.id,file:this.file,object:this.object};0<this.wcs&&("image"!==this.params.wcssys&&"physical"!==this.params.wcssys)&&(g=a.pix2wcs(this.wcs,d.x,d.y).trim().split(/\s+/),e=e+" "+g[2]+"("+g[0]+", "+g[1]+")",c.ra=g[0],c.dec=g[1],c.wcssys=g[2],c.vstr=e);b&&this.displayMessage("info",
c)}return c};a.Image.prototype.getColormap=function(){if(this.cmapObj)return{colormap:this.cmapObj.name,contrast:this.params.contrast,bias:this.params.bias}};a.Image.prototype.setColormap=function(d,b,c){switch(arguments.length){case 1:case 3:switch(d){case "rgb":a.globalOpts.rgb.mode=!a.globalOpts.rgb.mode;break;case "invert":this.params.invert=!this.params.invert;break;case "reset":this.params.invert=a.imageOpts.invert;this.params.contrast=a.imageOpts.contrast;this.params.bias=a.imageOpts.bias;
break;default:switch(this.cmapObj.name){case "red":a.globalOpts.rgb.rim=null;break;case "green":a.globalOpts.rgb.gim=null;break;case "blue":a.globalOpts.rgb.bim=null}this.cmapObj=a.lookupColormap(d);this.params.colormap=this.cmapObj.name;switch(d){case "red":a.globalOpts.rgb.rim=this;break;case "green":a.globalOpts.rgb.gim=this;break;case "blue":a.globalOpts.rgb.bim=this}}3===arguments.length&&(isNaN(b)||(this.params.contrast=b),isNaN(c)||(this.params.bias=c));break;case 2:isNaN(d)||(this.params.contrast=
d),isNaN(b)||(this.params.bias=b)}this.displayImage("colors");return this};a.Image.prototype.getScale=function(){if(this.params.scale)return{scale:this.params.scale,scalemin:this.params.scalemin,scalemax:this.params.scalemax}};a.Image.prototype.setScale=function(d,b,c){var e=this,f=function(b){0<=a.scales.indexOf(b)?e.params.scale=b:a.error("unknown scale: "+b)};if(arguments.length){switch(arguments.length){case 1:f(d);break;case 2:this.params.scalemin=parseInt(d,10);this.params.scalemax=parseInt(b,
10);this.mkColorData();break;default:f(d),this.params.scalemin=parseInt(b,10),this.params.scalemax=parseInt(c,10),this.mkColorData()}this.displayImage("scaled")}return this};a.Image.prototype.zscale=function(d){var b,c;if(!a.zscale||!this.raw||!this.raw.data)return this;b=this.raw.data;try{c=Astroem._malloc(b.length*b.BYTES_PER_ELEMENT)}catch(e){a.error("image too large for zscale",e)}try{Astroem.HEAPU8.set(new Uint8Array(b.buffer),c)}catch(f){a.error("can't transfer image to heap for zscale",f)}b=
a.zscale(c,this.raw.width,this.raw.height,this.raw.bitpix,this.params.zscalecontrast,this.params.zscalesamples,this.params.zscaleline);Astroem._free(c);c=b.trim().split(" ");this.params.z1=parseFloat(c[0]);this.params.z2=parseFloat(c[1]);d&&(this.params.scalemin=this.params.z1,this.params.scalemax=this.params.z2);return this};a.Colormap=function(d,b,c,e){this.name=d;switch(arguments.length-1){case 1:this.type="lut";this.colors=b;break;case 3:this.type="sao";this.vertices=[];this.vertices[0]=b;this.vertices[1]=
c;this.vertices[2]=e;break;default:a.error("colormap requires name and 1 or 3 array arg")}a.colormaps.push(this);1<a.DEBUG&&a.log("JS9 colormap:  %s",this.name)};a.Colormap.prototype.mkColorCell=function(d){var b,c=a.COLORSIZE,e=[0,0,0];switch(this.type){case "sao":var f,g;d/=c;for(f=0;3>f;f++){g=this.vertices[f];b=g.length;for(c=0;c<b&&!(g[c][0]>d);c++);c=0===c?g[0][1]:c===b?g[b-1][1]:(b=(g[c][1]-g[c-1][1])/(g[c][0]-g[c-1][0]))?b*(d-g[c-1][0])+g[c-1][1]:g[c][1];e[f]=255*c}break;case "lut":f=this.colors.length;
d=Math.floor(d*f/c+0.5);0<=d&&d<f&&(e[0]=255*this.colors[d][0],e[1]=255*this.colors[d][1],e[2]=255*this.colors[d][2]);break;default:a.error("unknown colormap type")}return e};a.Display=function(d){this.divjq=d instanceof jQuery?d:"object"===typeof d?$(d):$("#"+d);this.divjq.attr("id")||this.divjq.attr("id",a.DEFID);this.id=this.divjq.attr("id");this.divjq.addClass("JS9");this.width=this.divjq.attr("data-width");this.width||(this.width=a.WIDTH);this.divjq.css("width",this.width);this.width=parseInt(this.divjq.css("width"),
10);this.height=this.divjq.attr("data-height");this.height||(this.height=a.HEIGHT);this.divjq.css("height",this.height);this.height=parseInt(this.divjq.css("height"),10);this.canvas=document.createElement("canvas");this.canvasjq=$(this.canvas).addClass("JS9Image").css("z-index",a.ZINDEX).attr("width",this.width).attr("height",this.height);this.displayConjq=$("<div>").addClass("JS9Container").css("z-index",a.ZINDEX).attr("tabindex","0").append(this.canvasjq).appendTo(this.divjq);this.context=this.canvas.getContext("2d");
a.ANTIALIAS||(this.context.imageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1);this.image=null;this.pluginInstances={};this.layers={};this.x=0;for(d=this.canvas;d;d=d.offsetParent)this.x+=d.offsetLeft;this.y=0;for(d=this.canvas;d;d=d.offsetParent)this.y+=d.offsetTop;this.initMessages();this.divjq.on("mouseover",this,function(b){return a.mouseOverCB(b)});this.divjq.on("mousedown touchstart",this,function(b){return a.mouseDownCB(b)});this.divjq.on("mousemove touchmove",
this,function(b){return a.mouseMoveCB(b)});this.divjq.on("mouseup touchend",this,function(b){return a.mouseUpCB(b)});this.divjq.on("mouseout",this,function(b){return a.mouseOutCB(b)});this.divjq.on("keypress",this,function(b){return a.keyPressCB(b)});this.divjq.on("keydown",this,function(b){return a.keyDownCB(b)});this.divjq.on("dragenter",this,function(b){return a.dragenter(this.id,b.originalEvent)});this.divjq.on("dragover",this,function(b){return a.dragover(this.id,b.originalEvent)});this.divjq.on("dragexit",
this,function(b){return a.dragexit(this.id,b.originalEvent)});this.divjq.on("drop",this,function(b){return a.dragdrop(this.id,b.originalEvent,a.NewFITSImage)});this.divjq.append('<div style="visibility:hidden; position:relative; top:-50;left:-50"> <input type="file" id="openLocalFile-'+this.id+'" multiple="true" onchange="javascript:for(var i=0; i<this.files.length; i++){JS9.Load(this.files[i], {display:\''+this.id+"'}); }\"> </div>");this.divjq.append('<div style="visibility:hidden; position:relative; top:-50;left:-50"> <input type="file" id="refreshLocalFile-'+
this.id+'" multiple="true" onchange="javascript:for(var i=0; i<this.files.length; i++){JS9.RefreshImage(this.files[i], {display:\''+this.id+"'}); }\"> </div>");this.divjq.append('<div style="visibility:hidden; position:relative; top:-50;left:-50"> <input type="file" id="openLocalRegions-'+this.id+'" multiple="true" onchange="javascript:for(var i=0; i<this.files.length; i++){JS9.LoadRegions(this.files[i], {display:\''+this.id+"'}); }\"> </div>");a.displays.push(this);a.DEBUG&&a.log("JS9 display:  %s (%d,%d)",
this.id,this.x,this.y)};a.Display.prototype.initMessages=function(){this.messageContainer=$("<div>").addClass("JS9Container").css("z-index",a.MESSZINDEX).appendTo(this.divjq);this.infoArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer);this.regionsArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer);return this};a.Display.prototype.displayPlugin=function(d){var b,c,e,f,g,h,l,j;h=this.pluginInstances[d.name];switch(a.globalOpts.winType){case "light":b=a.lightOpts[a.LIGHTWIN];
if(!h||!h.status){if(c=d.name.replace(/\s/g,"_"),e=this.id+"_"+c+"_lightDiv",f=this.id+"_"+c+"_outerDiv",c=this.id+"_"+c+"_innerDiv",h||(g=$("<div>").attr("id",f).css("display","none").appendTo($(this.divjq)),$("<div>").addClass(d.name).attr("id",c).attr("data-js9id",this.divjq.attr("id")).css("height","100%").css("width","100%").appendTo(g)),g=d.opts.winDims[0]||a.WIDTH,l=d.opts.winDims[1]||a.HEIGHT,j=d.opts.winResize?"1":"0",b=sprintf(b.format,g,l,j),g=d.opts.toolbarHTML&&0<=d.opts.toolbarHTML.search(/\$title/)?
"":d.opts.winTitle||"",f=a.lightWin(e,"div",f,g,b),e=$("#"+e+" #"+c),h=a.instantiatePlugin(e,d,f),h.winHandle.onclose=function(){h.winHandle.hide();h.status="inactive";return!1},h.status="active",d.opts.plugindisplay)try{d.opts.plugindisplay.call(h,this.image)}catch(m){a.log("plugindisplayCB: %s [%s]\n%s",d.name,m.message,a.strace(m))}}else if("inactive"===h.status){if(h.winHandle&&(h.winHandle.show(),h.status="active",d.opts.plugindisplay))try{d.opts.plugindisplay.call(h,this.image)}catch(n){a.log("plugindisplayCB: %s [%s]\n%s",
d.name,n.message,a.strace(n))}}else"active"===h.status&&h.winHandle&&(h.winHandle.hide(),h.status="inactive");break;case "new":a.error("external window support for plugins not yet implemented")}};a.Command=function(d){for(var b in d)d.hasOwnProperty(b)&&(this[b]=d[b]);d.name||a.error("command has no name");!d.get&&!d.set&&a.error("command requires get and/or set routine");a.commands.push(this);1<a.DEBUG&&a.log("JS9 command:  %s",this.name)};a.Command.prototype.getDisplayInfo=function(a){a&&a.id&&
(this.display=a,this.image=a.image);return this};a.Command.prototype.getWhich=function(a){return this.get&&!this.set?"get":this.set&&!this.get?"set":this.which?this.which(a):0===a.length?"get":"set"};a.Console=function(d,b){this.display.conMode=2;this.hist=[];this.histtemp=this.histpos=0;this.histused=!1;this.consoleConjq=$("<div>").addClass("JS9ConsoleContainer").appendTo(this.divjq);"light"!==this.winType&&(this.width=this.divjq.attr("data-width"),this.width||(this.width=d||a.CONWIDTH),this.divjq.css("width",
this.width),this.width=parseInt(this.divjq.css("width"),10),this.height=this.divjq.attr("data-height"),this.height||(this.height=b||a.CONHEIGHT),this.divjq.css("height",this.height),this.height=parseInt(this.divjq.css("height"),10),this.consoleConjq.css("width",this.width).css("height",this.height));this.consoleConjq.attr("tabindex","0");this.consoleConjq.on("keydown",this,function(b){return a.consoleKeyDownCB(b)});this.out("Type 'help' for a list of commands","info");this.inp()};a.Console.prototype.inp=
function(){this.consoleConjq.find(".JS9CmdIn:last").attr("readonly","readonly");this.consoleConjq.append(a.consoleHTML.replace(/@@PR@@/g,"js9>"));this.consoleConjq.find(".JS9CmdIn:last").focus().attr("autocapitalize","off").attr("autocorrect","off").attr("autocomplete","off");return this};a.Console.prototype.out=function(a,b){switch(b.toLowerCase()){case "error":a="ERROR: "+a;b="Error";break;case "info":b="Info";break;case "out":b="Out";break;default:b="Out"}$("<div>").addClass("JS9Cmd"+b).html(a).appendTo(this.consoleConjq);
return this};a.Console.prototype.xeq=function(){var d,b,c,e,f=this.consoleConjq.find(".JS9CmdIn:last").val(),g=f.replace(/ {2,}/g," ").split(" "),h=[];if(!g[0])return this;b=g[0];for(d=1;d<g.length;d++)h.push(g[d]);this.histused||(this.hist[this.hist.length]=f);this.histpos=this.hist.length;this.histused=!1;try{if(c=a.lookupCommand(b))switch(c.getDisplayInfo(this.display),c.getWhich(h)){case "get":e=c.get(h)||"";this.out(e,"ok");break;case "set":(e=c.set(h))&&this.out(e,"ok");break;default:e=sprintf("unknown cmd type for '%s'",
b),a.error(e)}else e=sprintf("unknown command '%s'",b),0<h.length&&(e=e+" "+h),a.error(e)}catch(l){this.out(l.message,"error")}return this};a.Info={};a.Info.CLASS="JS9";a.Info.NAME="Info";a.Info.opts={infoURL:"./params/info.html",infoHTML:'<table id="info" class="js9InfoTable"><tr><td>file:</td><td colspan="2"><input type="text" id="id" size="28" value="" readonly="readonly" /></td></tr> <tr><td>object:</td><td colspan="2"><input type="text" id="object" size="28" value="" readonly="readonly" /></td></tr> <tr><td>value:</td><td colspan="2"><input type="text" id="val3" size="28" value="" readonly="readonly" /></td></tr> <tr><td><input type="text" id="isys" size="10" value="" readonly="readonly" /></td><td><input type="text" id="ix" size="13" value="" readonly="readonly" /></td><td><input type="text" id="iy" size="13" value="" readonly="readonly" /></td></tr> <tr><td><input type="text" id="psys" size="10" value="" readonly="readonly" /></td><td><input type="text" id="px" size="13" value="" readonly="readonly" /></td><td><input type="text" id="py" size="13" value="" readonly="readonly" /></td></tr> <tr><td><input type="text" id="wcssys" size="10" value="" readonly="readonly" /></span></td><td><input type="text" id="ra" size="13" value="" readonly="readonly" /></td><td><input type="text" id="dec" size="13" value="" readonly="readonly" /></td></tr> <tr><td colspan="3"><textarea style="background: #E9E9E9; border: #CCCCCC solid 1px" id="regions" rows="4" cols="40" value="" readonly="readonly" /></td></tr></table>'};
a.Info.init=function(d,b){this.width=this.divjq.attr("data-width");this.width||(this.width=d||a.INFOWIDTH);this.divjq.css("width",this.width);this.width=parseInt(this.divjq.css("width"),10);this.height=this.divjq.attr("data-height");this.height||(this.height=b||a.INFOHEIGHT);this.divjq.css("height",this.height);this.height=parseInt(this.divjq.css("height"),10);this.infoConjq=$("<div>").addClass("JS9Container").append(a.Info.opts.infoHTML).appendTo(this.divjq);this.jq=this.infoConjq.find("#info")};
a.Info.display=function(d,b,c){var e,f,g,h;this.display&&this.display.pluginInstances&&(f=this.display.pluginInstances.JS9Info);c=c?c:f&&"active"===f.status?f:this.display?this.display:this;if(c===f){switch(typeof b){case "string":g=f.jq.find("#"+d);0<g.length&&g.val(b);break;case "object":for(h in b)if(b.hasOwnProperty(h)){switch(h){case "wcssys":b[h]||(b[h]="wcs")}g=f.jq.find("#"+h);0<g.length&&g.val(b[h])}}return this}switch(d){case "regions":f=c.regionsArea;e=";";break;case "info":f=c.infoArea;
e="";break;default:f=c.infoArea}if(this.primary&&0.8>this.primary.img.height/this.display.canvas.height)d="black";else switch(d){case "regions":d=a.textColorOpts.regions;break;case "info":d=a.textColorOpts.info;break;default:d=a.textColorOpts.info}switch(typeof b){case "string":g=b;break;case "object":g=b.vstr}""!==e&&(b=g.split(e),2<b.length&&(b=RegExp(e,"g"),g=g.replace(b,"<br>")));f.css("color",d).html(g);return this};a.Image.prototype.displayMessage=a.Info.display;a.Info.clear=function(a){a?this.displayMessage(a,
""):(this.displayMessage("info",""),this.displayMessage("regions",""));return this};a.Image.prototype.clearMessage=a.Info.clear;a.Info.clearMain=function(a){a&&(a.displayMessage("info","",a.display),a.displayMessage("regions","",a.display))};a.Menubar=function(d,b){var c,e,f,g=this;this.width=this.divjq.attr("data-width");this.width||(this.width=d||a.MENUWIDTH);this.divjq.css("width",this.width);this.width=parseInt(this.divjq.css("width"),10);this.height=this.divjq.attr("data-height");this.height||
(this.height=b||a.MENUHEIGHT);this.divjq.css("height",this.height);this.height=parseInt(this.divjq.css("height"),10);if(""===a.menubarHTML){a.menubarHTML="<span id='JS9Menus_@@ID@@' class='ui-widget-header ui-corner-all'>";for(c=0;c<a.menuButtonOptsArr.length;c++)e=a.menuButtonOptsArr[c].name,f=a.menuButtonOptsArr[c].label,"#"===e[0]?(e=e.slice(1),a.menubarHTML+="<button type='button' id='"+e+"Menu@@ID@@' class='JS9Button' disabled='disabled'>"+f+" </button>"):a.menubarHTML+="<button type='button' id='"+
e+"Menu@@ID@@' class='JS9Button'>"+f+"</button>";a.menubarHTML+="<button type='button' id='hiddenRegionMenu@@ID@@'class='JS9Button' style='display:none'>R</button>";a.menubarHTML+="<button type='button' id='hiddenAnchorMenu@@ID@@'class='JS9Button' style='display:none'>R</button>";a.menubarHTML+="</span>"}this.display=a.lookupDisplay(this.id);this.display.menubar=this;c=a.menubarHTML.replace(/@@ID@@/g,this.id);this.menuConjq=$("<div>").addClass("JS9MenubarContainer").attr("width",this.width).attr("height",
this.height).html(c).appendTo(this.divjq);$(function(){function b(){var d=g.display;a.bugs.hide_menu&&d.image&&d.image.displayImage("primary")}function d(){var b,c,e,f=[];if(0<=g.id.search(a.SUPERMENU))if(c=g.divjq.data("displays").split(","),"*"===c[0])for(b=0;b<a.displays.length;b++)f.push(a.displays[b]);else for(b=0;b<c.length;b++)(e=a.lookupDisplay(c[b]))&&f.push(e);f.length||f.push(g.display);return f}$("#fileMenu"+g.id).on("mousedown",function(a){a.preventDefault();$("#fileMenu"+g.id).contextMenu()});
$.contextMenu({selector:"#fileMenu"+g.id,zIndex:a.MENUZINDEX,events:{hide:b},build:function(){var b,c,g,e,f=0,h={},p=d()[0];e=a.images.length;for(b=0;b<e;b++)c=a.images[b],c.display===p&&(g=c.id,h[g]={name:g},p.image&&p.image.id===c.id&&(h[g].icon="sun"),f++);f||(h.noimg={name:"[no images]",events:{keyup:function(){}}});h["sep"+f++]="------";h.open={name:"open ..."};h.print={name:"print ..."};h.header={name:"display FITS header"};h.pageid={name:"display pageid"};h.savefits={name:"save image as FITS"};
h.savepng={name:"save image as PNG"};h.close={name:"close image"};h["sep"+f++]="------";h.lite={name:"new JS9 light window"};h.xnew={name:"new JS9 separate window"};2<a.DEBUG&&(h["sep"+f++]="------",h.refresh={name:"debug: refresh ..."});return{callback:function(b){d().forEach(function(d){var c,g=d.image;switch(b){case "close":g&&g.closeImage();break;case "header":g&&(g.raw.header?g.displayAnalysis("text",a.raw2FITS(g.raw,!0),"FITSHeader_"+g.id):a.error("no FITS header for "+g.id));break;case "lite":a.LoadWindow(null,
null,"light");break;case "xnew":a.LoadWindow(null,null,"new");break;case "pageid":d="<center><p>Usage: js9 -pageid [pageid] ...<p>"+a.helper.pageid||"none</center>";a.lightWin("fileid"+a.uniqueID(),"inline",d,"page ID",a.lightOpts[a.LIGHTWIN].lineWin);break;case "open":a.OpenFileMenu(d);break;case "refresh":$("#refreshLocalFile-"+d.id).click();break;case "savefits":g&&(d=g.id.replace(/png/,"fits").replace(/.gz$/,"").replace(/\[.*\]/,""),g.saveFITS(d));break;case "savepng":g&&(d=g.id.replace(/fits/,
"png").replace(/.gz$/,"").replace(/\[.*\]/,""),g.savePNG(d));break;case "print":g&&g.print();break;default:for(c=0;c<a.images.length;c++)if(g=a.images[c],d.id===g.display.id&&g.id===b){g.displayImage("display");g.clearMessage();break}}})},items:h}}});$("#viewMenu"+g.id).on("mousedown",function(a){a.preventDefault();$("#viewMenu"+g.id).contextMenu()});$.contextMenu({selector:"#viewMenu"+g.id,zIndex:a.MENUZINDEX,events:{hide:b},build:function(){var b,c,g,e,f,h="",p=0,s=0,t={},u=d()[0],w=u.image;for(b=
0;b<a.plugins.length;b++)if(c=a.plugins[b],g=c.name,c.opts.menuItem&&"view"===c.opts.menu&&(e=u.pluginInstances[g],!e||e.winHandle))c.xclass!==h&&(p+=1),h=c.xclass,t[g]={name:c.opts.menuItem},e&&"active"===e.status&&(t[g].icon="sun");t["sep"+p++]="------";if(w){for(f in w.layers)w.layers.hasOwnProperty(f)&&"main"===w.layers[f].dlayer.dtype&&(s++,t[f]={name:f},w.layers[f].show&&(t[f].icon="sun"));1<s&&(t.hide={name:"HideAll"},t.show={name:"ShowAll"},t["sep"+p++]="------")}t.valpos={name:"display value/position"};
u.image&&u.image.params.valpos&&(t.valpos.icon="sun");return{callback:function(b){d().forEach(function(d){var c,g,e,f=d.image;switch(b){case "valpos":f&&(f.params.valpos=!f.params.valpos,f.params.valpos||f.clearMessage());break;case "show":case "hide":if(f)for(g in f.layers)f.layers.hasOwnProperty(g)&&"main"===f.layers[g].dlayer.dtype&&f.showShapeLayer(g,b);break;default:for(c=0;c<a.plugins.length;c++)if(e=a.plugins[c],e.name===b){d.displayPlugin(e);return}if(f)for(g in f.layers)if(f.layers.hasOwnProperty(g)&&
b===g){d=f.layers[g].show?"hide":"show";f.showShapeLayer(g,d);break}}})},items:t}}});$("#zoomMenu"+g.id).on("mousedown",function(a){a.preventDefault();$("#zoomMenu"+g.id).contextMenu()});$.contextMenu({selector:"#zoomMenu"+g.id,zIndex:a.MENUZINDEX,events:{hide:b},build:function(){var b,c,e,f,h=0,q=d()[0].image,p={zoomtitle:{name:"Zoom Factors:",disabled:!0}};for(b=a.imageOpts.zooms;1<=b;b--)c=Math.pow(2,-b),e=Math.pow(2,b),f=sprintf("zoom%s",c),e=sprintf("zoom 1/%s",e),p[f]={name:e},q&&q.primary.sect.zoom===
c&&(p[f].icon="sun");for(b=0;b<=a.imageOpts.zooms;b++)c=Math.pow(2,b),f=sprintf("zoom%s",c),e=sprintf("zoom %s",c),p[f]={name:e},q&&q.primary.sect.zoom===c&&(p[f].icon="sun");p["sep"+h++]="------";p.zoomiotitle={name:"Zoom In/Out:",disabled:!0};p.zoomIn={name:"zoom in"};p.zoomOut={name:"zoom out"};p.zoomToFit={name:"zoom to fit"};p["sep"+h++]="------";p.zoom={events:{keyup:function(a){var b=$.contextMenu.getInputValues(a.data),d=g.display.image;switch(a.which||a.keyCode){case 9:case 13:d&&(isNaN(b.zoom)||
d.setZoom(b.zoom))}a.data.edited=!0}},name:"numeric zoom value:",type:"text"};p["sep"+h++]="------";p.center={name:"pan to center"};p.reset={name:"reset zoom/pan"};return{callback:function(a){d().forEach(function(b){if(b=b.image)switch(a){case "zoomIn":b.setZoom("x2");break;case "zoomOut":b.setZoom("/2");break;case "zoomToFit":b.setZoom("tofit");break;case "center":b.setPan();break;case "reset":b.setZoom("1");b.setPan();break;default:a.match(/^zoom/)&&b.setZoom(a.slice(4))}})},events:{show:function(a){var b=
g.display.image,d={};b&&(d.zoom=String(b.primary.sect.zoom));$.contextMenu.setInputValues(a,d)},hide:function(a){var b=g.display.image;b&&a.edited&&(delete a.edited,a=$.contextMenu.getInputValues(a),isNaN(a.zoom)||b.setZoom(a.zoom))}},items:p}}});$("#scaleMenu"+g.id).on("mousedown",function(a){a.preventDefault();$("#scaleMenu"+g.id).contextMenu()});$.contextMenu({selector:"#scaleMenu"+g.id,zIndex:a.MENUZINDEX,events:{hide:b},build:function(){var b,c,e,f=0,h={},q=d()[0],p=function(a,b){isNaN(b.scalemin)||
(a.params.scalemin=b.scalemin);isNaN(b.scalemax)||(a.params.scalemax=b.scalemax);a.displayImage("colors")},s=function(a){var b=$.contextMenu.getInputValues(a.data),d=g.display.image;switch(a.which||a.keyCode){case 9:case 13:p(d,b)}a.data.edited=!0};h.scaletitle={name:"Scaling Algorithms:",disabled:!0};for(b=0;b<a.scales.length;b++)e=c=a.scales[b],h[c]={name:e},q.image&&q.image.params.scale===c&&(h[c].icon="sun");h["sep"+f++]="------";h.scalemin={events:{keyup:s},name:"low limit for clipping:",type:"text"};
h.scalemax={events:{keyup:s},name:"high limit for clipping:",type:"text"};h["sep"+f++]="------";h.dminmax={name:"set limits to data min/max"};h.zscale={name:"set limits to zscale z1/z2"};return{callback:function(a,b){d().forEach(function(d){if(d=d.image)switch(a){case "dminmax":return d.params.scaleclipping="dataminmax",d.params.scalemin=d.raw.dmin,d.params.scalemax=d.raw.dmax,$.contextMenu.setInputValues(b,{scalemin:String(d.params.scalemin),scalemax:String(d.params.scalemax)}),d.displayImage("colors"),
!1;case "zscale":return(!d.params.z1||d.params.z2)&&d.zscale(!1),d.params.scaleclipping="zscale",d.params.scalemin=d.params.z1,d.params.scalemax=d.params.z2,$.contextMenu.setInputValues(b,{scalemin:String(d.params.scalemin),scalemax:String(d.params.scalemax)}),d.displayImage("colors"),!1;default:d.setScale(a)}})},events:{show:function(a){var b=g.display.image,d={};b&&(d.scalemin=String(b.params.scalemin),d.scalemax=String(b.params.scalemax));$.contextMenu.setInputValues(a,d)},hide:function(a){var b=
g.display.image;b&&a.edited&&(delete a.edited,a=$.contextMenu.getInputValues(a),p(b,a))}},items:h}}});$("#colorMenu"+g.id).on("mousedown",function(a){a.preventDefault();$("#colorMenu"+g.id).contextMenu()});$.contextMenu({selector:"#colorMenu"+g.id,zIndex:a.MENUZINDEX,events:{hide:b},build:function(){var b,c,e,f=0,h={},q=d()[0],p=function(a,b){isNaN(b.contrast)||(a.params.contrast=b.contrast);isNaN(b.bias)||(a.params.bias=b.bias);isNaN(b.alpha)||(a.params.alpha=b.alpha);a.displayImage("colors")},s=
function(a){var b=$.contextMenu.getInputValues(a.data),d=g.display.image;switch(a.which||a.keyCode){case 9:case 13:p(d,b)}a.data.edited=!0};h.cmaptitle={name:"Colormaps:",disabled:!0};for(b=0;b<a.colormaps.length;b++)e=c=a.colormaps[b].name,h[c]={name:e},q.image&&q.image.cmapObj.name===c&&(h[c].icon="sun");h["sep"+f++]="------";h.contrast={events:{keyup:s},name:"contrast value:",type:"text"};h.bias={events:{keyup:s},name:"bias value:",type:"text"};h.alpha={events:{keyup:s},name:"alpha value:",type:"text"};
h["sep"+f++]="------";h.reset={name:"reset contrast/bias"};h["sep"+f++]="------";h.invert={name:"invert colormap"};q.image&&q.image.params.invert&&(h.invert.icon="sun");h["sep"+f++]="------";h.rgb={name:"RGB mode"};a.globalOpts.rgb.mode&&(h.rgb.icon="sun");return{callback:function(a){d().forEach(function(b){(b=b.image)&&b.setColormap(a)})},events:{show:function(a){var b=g.display.image,d={};b&&(d.contrast=String(b.params.contrast),d.bias=String(b.params.bias),d.alpha=String(b.params.alpha));$.contextMenu.setInputValues(a,
d)},hide:function(a){var b=g.display.image;b&&a.edited&&(delete a.edited,a=$.contextMenu.getInputValues(a),p(b,a))}},items:h}}});$("#regionMenu"+g.id).on("mousedown",function(a){a.preventDefault();$("#regionMenu"+g.id).contextMenu()});$.contextMenu({selector:"#regionMenu"+g.id,zIndex:a.MENUZINDEX,events:{hide:b},build:function(){var b=d()[0].image,c={regiontitle:{name:"Regions:",disabled:!0},annulus:{name:"annulus"},box:{name:"box"},circle:{name:"circle"},ellipse:{name:"ellipse"},point:{name:"point"},
polygon:{name:"polygon"},text:{name:"text"},sep2:"------",loadRegions:{name:"load regions"},saveRegions:{name:"save regions"},listRegions:{name:"list regions"},deleteRegions:{name:"delete regions"},listonchange:{name:"list on change"},xeqonchange:{name:"xeq on change"}};b&&b.params.listonchange&&(c.listonchange.icon="sun");b&&b.params.xeqonchange&&(c.xeqonchange.icon="sun");return{callback:function(b){d().forEach(function(d){var c=d.image;if(c)switch(b){case "deleteRegions":c.removeShapes("regions",
"all");c.clearMessage("regions");break;case "loadRegions":a.OpenRegionsMenu(d);break;case "saveRegions":c.saveRegions("all",!0);break;case "listRegions":c.listRegions("all",2);break;case "xeqonchange":c.params.xeqonchange=!c.params.xeqonchange;break;case "listonchange":c.params.listonchange=!c.params.listonchange;break;default:c.addShapes("regions",b,{ireg:!0})}})},items:c}}});$("#wcsMenu"+g.id).on("mousedown",function(a){a.preventDefault();$("#wcsMenu"+g.id).contextMenu()});$.contextMenu({selector:"#wcsMenu"+
g.id,zIndex:a.MENUZINDEX,events:{hide:b},build:function(){var b,c,g,e=0,f={},h=d()[0];f.wcssystitle={name:"WCS Systems:",disabled:!0};for(b=0;b<a.wcssyss.length;b++)g=c=a.wcssyss[b],f[c]={name:g},h.image&&h.image.params.wcssys===c&&(f[c].icon="sun");f["sep"+e++]="------";f.wcsutitle={name:"WCS Units:",disabled:!0};for(b=0;b<a.wcsunitss.length;b++)g=c=a.wcsunitss[b],f[c]={name:g},h.image&&h.image.params.wcsunits===c&&(f[c].icon="sun");return{callback:function(b){d().forEach(function(d){var c=RegExp(b);
(d=d.image)&&(0<=a.wcssyss.join("@").search(c)?d.setWCSSys(b):0<=a.wcsunitss.join("@").search(c)?d.setWCSUnits(b):a.error("unknown wcs sys/units: "+b))})},items:f}}});$("#analysisMenu"+g.id).on("mousedown",function(a){a.preventDefault();$("#analysisMenu"+g.id).contextMenu()});$.contextMenu({selector:"#analysisMenu"+g.id,zIndex:a.MENUZINDEX,events:{hide:b},build:function(){var b,c,g,e,f,h=0,p=0,s={};f=d()[0];var t=f.image,u="";for(b=0;b<a.plugins.length;b++)if(c=a.plugins[b],e=c.name,c.opts.menuItem&&
"analysis"===c.opts.menu&&(g=f.pluginInstances[e],!g||g.winHandle))c.xclass!==u&&(s["sep"+p++]="------",s["sep"+p++]={name:c.xclass+" Plugins:"},s["sep"+(p-1)].disabled=!0),u=c.xclass,s[e]={name:c.opts.menuItem},g&&"active"===g.status&&(s[e].icon="sun"),p++;0<p&&(s["sep"+p++]="------");s.remotetitle={name:"Server-side Tasks:",disabled:!0};if(t&&t.analysisPackages){e=t.analysisPackages;for(c=0;c<e.length;c++){f=e[c];for(b=0;b<f.length;b++)if(!f[b].hidden&&("fits"!==f[b].files||t.fitsFile)&&!("png"===
f[b].files&&"fits2png"!==t.source))g=f[b].title,f[b].purl&&(g+=" ..."),s[f[b].name]={name:g},h++}}h||(s.notasks={name:"[none]",disabled:!0,events:{keyup:function(){}}});s["sep"+p++]="------";s.dpath={name:"set data path ..."};return{callback:function(b){d().forEach(function(d){var c,g,e;g=d.image;for(c=0;c<a.plugins.length;c++)if(e=a.plugins[c],e.name===b){d.displayPlugin(e);return}if(g)switch(b){case "dpath":a.globalOpts.dhtmlonload=function(){$("#dataPath").val(a.globalOpts.dataPath)};a.globalOpts.dhtmlloadid=
"dataPathForm";g=g.displayAnalysis("dpath",a.InstallDir(a.analOpts.dpathURL),"Data Path for Drag and Drop");$(g).data("dispid",d.id);break;default:if(c=g.lookupAnalysis(b))c.purl?(g=g.displayAnalysis("params",a.InstallDir(c.purl),c.title+": "+g.fitsFile),$(g).data("dispid",d.id).data("aname",c.name)):g.runAnalysis(c.name)}})},items:s}}});$("#helpMenu"+g.id).on("mousedown",function(a){a.preventDefault();$("#helpMenu"+g.id).contextMenu()});$.contextMenu({selector:"#helpMenu"+g.id,zIndex:a.MENUZINDEX,
events:{hide:b},build:function(){var b,c,d=1,g="",e={helptitle:{name:"JS9 Help:",disabled:!0}};for(b in a.helpOpts)a.helpOpts.hasOwnProperty(b)&&(c=a.helpOpts[b],""!==g&&c.type!==g&&(e["sep"+d++]="------",c.heading&&(e["sep"+d++]={name:c.heading+" Help:"},e["sep"+(d-1)].disabled=!0)),g=c.type,e[b]={name:c.title});e["sep"+d++]="------";e.about={name:"About JS9"};return{callback:function(b){switch(b){case "about":alert(sprintf("JS9: image display right in your browser\nversion: %s\nprincipals: Eric Mandel (lead), Alexey Vikhlinin (science,management)\ncontact: saord@cfa.harvard.edu\n%s",
a.VERSION,a.COPYRIGHT));break;default:a.DisplayHelp(b)}},items:e}}})})};a.Helper=function(){this.helper=this.connected=!1;this.type=a.globalOpts.helperType||"sock.io";this.pageid=null;this.connect()};a.Helper.prototype.connectinfo=function(){if(null===a.helper.connected)return"notConfigured";if(a.helper.connected){var d=sprintf("connected %s %s",a.helper.type,a.helper.url);a.helper.pageid&&(d+="<p>"+a.helper.pageid);return d}return sprintf("notConnected %s",a.helper.type)};a.Helper.prototype.connect=
function(d){var b=this;d&&(this.type=d);if(this.socket){try{this.socket.disconnect()}catch(c){a.log("warning: can't disconnect from socket")}this.socket=null}this.url=a.globalOpts.helperURL?0<=a.globalOpts.helperURL.search(/:\/\//)?a.globalOpts.helperURL:a.globalOpts.helperProtocol+a.globalOpts.helperURL:document.domain?a.globalOpts.helperProtocol+document.domain:a.globalOpts.helperProtocol+"localhost";switch(this.type){case "none":this.connected=null;a.Preload(!0);break;case "get":case "post":a.globalOpts.helperCGI||
a.error("cgi script name missing for helper");this.url+="/"+a.globalOpts.helperCGI;this.helper=this.connected=!0;a.DEBUG&&a.log("JS9 helper: connect: "+this.type);a.Preload(!0);break;case "sock.io":case "nodejs":a.globalOpts.helperPort||a.error("port missing for helper");this.url+=":"+a.globalOpts.helperPort;this.sockurl=this.url+"/socket.io/socket.io.js";$.ajax({url:this.sockurl,dataType:"script",success:function(){var c,d;b.socket=io.connect(b.url);b.socket.on("connect",function(){b.connected=!0;
b.helper=!0;d=[];for(c=0;c<a.displays.length;c++)d.push(a.displays[c].id);b.socket.emit("displays",{displays:d},function(a){b.pageid=a});a.Preload(!0);a.DEBUG&&a.log("JS9 helper: connect: "+b.type)});b.socket.on("disconnect",function(){b.connected=!1;b.helper=!1;1<a.DEBUG&&a.log("JS9 helper: disconnect")});b.socket.on("reconnect",function(){b.connected=!0;b.helper=!0;1<a.DEBUG&&a.log("JS9 helper: reconnect")});b.socket.on("msg",function(b,c){var d,e,f,n=[],r=b.cmd,k=b.id;a.globalOpts.alerts=!1;if(a.publics[r]){$.isArray(b.args)||
(b.args=[b.args]);n=$.extend(!0,[],b.args);k&&n.push({display:k});try{f=a.publics[r].apply(null,n)}catch(q){f=sprintf("ERROR: %s",q.message)}c&&c(f);a.globalOpts.alerts=!0}else if(!r||"#"===r)c&&c(""),a.globalOpts.alerts=!0;else{d=a.lookupCommand(r);e=a.lookupDisplay(k);if(d&&e)switch(d.getDisplayInfo(e),b.args?n=$.extend(!0,[],b.args):b.paramlist&&(n=b.paramlist.split(/ +/)),d.getWhich(n)){case "get":try{f=d.get(n)||""}catch(p){f="ERROR: "+p.message}break;case "set":try{f=d.set(n)||"OK"}catch(s){f=
"ERROR: "+s.message}break;default:f=sprintf("ERROR: unknown cmd type for '%s'",r)}else d||(f=sprintf("ERROR: unknown cmd '%s'",r)),e||(f=sprintf("ERROR: unknown display (%s)",k));a.globalOpts.alerts=!0;c&&c(f)}})},error:function(b,c,d){a.DEBUG&&a.log("JS9 helper: connect failure: "+c+" "+d)}});break;default:a.error("unknown helper type: "+this.type)}};a.Helper.prototype.send=function(d,b,c){if(!this.connected)return null;b&&"object"===typeof b?(b.cookie=document.cookie,a.globalOpts.dataPath&&!b.dataPath&&
(b.dataPath=a.globalOpts.dataPath+":.")):b={dataPath:"."};a.TOROOT&&(b.dataPath+=":"+a.TOROOT);switch(this.type){case "get":case "post":b.key=d;$.ajax({url:this.url,type:this.type.toUpperCase(),data:b,dataType:"text",success:function(b){"string"===typeof b&&0<=b.search(a.analOpts.epattern)&&a.log(b);c&&c(b)},error:function(b,c,d){a.DEBUG&&a.log("JS9 helper: "+this.type+" failure: "+c+" "+d)}});break;case "sock.io":case "nodejs":a.helper.socket.emit(d,b,c)}return this};a.Fabric={};a.Fabric.elements=
"cornerSize cornerColor borderColor transparentCorners selectionLineWidth centeredScaling hasControls hasRotatingPoint hasBorders params pub".split(" ");a.Fabric.opts={originX:"center",originY:"center",strokeWidth:2,cornerSize:8*(fabric.isTouchSupported?2:1),transparentCorners:!1,selectionLineWidth:2,centeredScaling:!0,selectable:!0,skipOffset:!0,padding:0,canvas:{selection:!0,zindex:a.SHAPEZINDEX},fill:"transparent"};a.Fabric.rescaleStrokeWidth=function(d,b){var c=(this.scaleX+this.scaleY)/2;d=d||
1;d*=c;!b&&this.params&&(b=this.params.sw1);"group"===this.type?this.forEachObject(function(c){a.Fabric.rescaleStrokeWidth.call(c,d,b)}):this.setStrokeWidth(b/d)};a.Fabric.rescaleEvenly=function(){var a;if(this.params&&this.scaleX!==this.scaleY)switch(this.params.shape){case "annulus":case "circle":a=this.params.lastscale||1,this.scaleX!==a?this.scaleY=this.scaleX:this.scaleY!==a&&(this.scaleX=this.scaleY),this.params.lastscale=this.scaleX}};fabric.Object.prototype.rescaleBorder=a.Fabric.rescaleStrokeWidth;
fabric.Object.prototype.rescaleEvenly=a.Fabric.rescaleEvenly;a.Fabric.newShapeLayer=function(d,b,c){var e,f;if(this&&d){if(this.layers[d])return this.layers[d];this.layers[d]={};f=this.layers[d];f.params=[];f.params.sel=null;f.params.sellayer=null;c?f.dtype="other":(f.dtype="main",c=this.divjq);e=c.attr("id")+"-"+d.replace(/\s+/,"_")+"-shapeLayer";f.display=this;f.opts=$.extend(!0,{},b);f.opts.canvas=f.opts.canvas||{};f.opts.canvas.selection=f.opts.canvas.selection||!0;f.opts.canvas.zindex=f.opts.canvas.zindex||
a.SHAPEZINDEX;f.el=a.Fabric.elements;f.divjq=$("<div>").addClass("JS9Container").css("z-index",0).appendTo(c);f.canvasjq=$("<canvas>").addClass("JS9Layer").attr("id",e).attr("width",c.css("width")).attr("height",c.css("height")).appendTo(f.divjq);f.canvas=new fabric.Canvas(f.canvasjq[0]);f.canvas.renderOnAddRemove=!1;f.canvas.selection=f.opts.canvas.selection;f.canvas.on("mouse:down",function(b){var c,e,j,m;if(b.target&&f.display.image)c=b.target,e=f.display.image,!a.specialKey(b.e)&&c.params&&(j=
(new Date).getTime(),c.params.lasttime&&j-c.params.lasttime<a.DBLCLICK&&(m=!0),c.params.lasttime=j),m?c.params.winid||(a.globalOpts.dhtmlonload=function(){c.pub&&a.Regions.initConfigForm.call(e,c)},a.globalOpts.dhtmlloadid="regionsConfigForm",c.params.winid=e.displayAnalysis("params",a.InstallDir(a.Regions.opts.configURL),"Region Configuration")):("main"===f.dtype&&(e.rclick=1),a.specialKey(b.e)&&("polygon"===b.target.type?(a.Fabric.addPolygonPoint.call(e,d,b.target,b.e),a.Fabric._updateShape.call(e,
d,b.target,null,"update")):b.target.polyparams&&(a.Fabric.removePolygonPoint.call(e,d,b.target,b.e),a.Fabric._updateShape.call(e,d,b.target.polyparams.polygon,null,"update"))));else if(this._selection=this.selection)this.selection=a.specialKey(b.e)});f.canvas.on("mouse:up",function(){var a,b=[];if(f.display.image){this.getActiveObject()&&b.push(this.getActiveObject());this.getActiveGroup()&&(b=this.getActiveGroup().getObjects());for(a=0;a<b.length;a++)b[a].polyparams&&f.canvas.setActiveObject(b[a].polyparams.polygon)}this.selection=
this._selection||this.selection});f.canvas.on("object:scaling",function(a){a.target.rescaleEvenly();a.target.rescaleBorder()});f.canvas.on("object:selected",function(b){f.params.sel&&(b.target.params&&f.params.sel!==b.target)&&f.canvas.fire("before:selection:cleared",{target:f.params.sel});switch(b.target.type){case "polygon":a.Fabric.addPolygonAnchors(f,b.target),f.canvas.renderAll()}b.target.polyparams?f.params.sel=b.target.polyparams.polygon:b.target.params&&(f.params.sel=b.target);f.display.image&&
(f.display.image.layer=d)});f.canvas.on("before:selection:cleared",function(b){f.params.sel=null;f.display.image&&(f.display.image.layer=null);switch(b.target.type){case "polygon":a.Fabric.removePolygonAnchors(f,b.target),f.canvas.renderAll()}});if(f.divjq.closest(a.lightOpts[a.LIGHTWIN].drag).length)if(fabric.isTouchSupported)f.divjq.on("touchstart",function(){f.canvas.calcOffset()});else f.divjq.on("mouseenter",function(){f.canvas.calcOffset()});return f}};a.Fabric.showShapeLayer=function(d,b){var c=
this,e,f,g,h;if(f=this.getShapeLayer(d)){h=f.canvas;g=this.display.layers[d];if("show"===b||!0===b)"show"===b&&(f.show=!0),f.json&&f.show&&h.loadFromJSON(f.json,function(){var b,e,m,n;h.renderAll();h.selection=f.opts.canvas.selection;e=g.opts.canvas.zindex;g.divjq.css("z-index",e);for(b in c.layers)if(c.layers.hasOwnProperty(b)&&(d!==b&&c.layers[b].show)&&(m=c.display.layers[b],m.divjq.css("z-index")<e&&(n=m.canvas.getActiveObject())))a.Fabric.removePolygonAnchors(m,n),m.canvas.discardActiveObject();
f.json=null});else if("hide"===b||!1===b)f.show&&(h.forEachObject(function(b){a.Fabric.removePolygonAnchors(g,b);b.params&&b.params.winid&&(b.params.winid.close(),b.params.winid=null)}),e=h.toJSON(f.dlayer.el),f.json=JSON.stringify(e),h.selection=!1,g.divjq.css("z-index",0),h.clear()),"hide"===b&&(f.show=!1);return this}};a.Fabric.displayShapeLayers=function(){var a;if(this!==this.display.image){if(this.display.image&&this.display.image.layers)for(a in this.display.image.layers)this.display.image.layers.hasOwnProperty(a)&&
this.display.image.showShapeLayer(a,!1);if(this.layers)for(a in this.layers)this.layers.hasOwnProperty(a)&&this.showShapeLayer(a,!0)}};a.Fabric.getShapeLayer=function(a){var b,c;if(!a)return null;c=this.layers[a];if(!c){b=this.display.layers[a];if(!b)return null;this.layers[a]={};c=this.layers[a];c.show=!0;c.nshape=0;c.dlayer=b;c.opts=c.dlayer.opts;c.canvas=c.dlayer.canvas;c.canvas.calcOffset()}return c};a.Fabric._parseShapeOptions=function(d,b,c){var e,f,g,h,l,j,m,n={},r={};h="main"===this.display.layers[d].dtype?
this.primary.sect.zoom:1;l=h/("main"===this.display.layers[d].dtype?this.binning.bin||1:1);if(b.remove)return{remove:!0};r.tags=[];if(b.tags)if("string"===typeof b.tags){f=b.tags.toLowerCase().split(",");for(d=0;d<f.length;d++)r.tags[d]=f[d].trim()}else if($.isArray(b.tags))for(d=0;d<b.tags.length;d++)r.tags[d]=b.tags[d].trim();void 0!==b.angle&&(n.angle=-b.angle);void 0!==b.x&&void 0!==b.y&&(e=this.imageToDisplayPos(b),n.left=e.x,n.top=e.y);void 0!==b.left&&(n.left=b.left);void 0!==b.top&&(n.top=
b.top);void 0===n.left&&(n.left=c&&void 0!==c.left?c.left:this.display.canvasjq.attr("width")/2-1);void 0===n.top&&(n.top=c&&void 0!==c.top?c.top:this.display.canvasjq.attr("height")/2-1+1);b.dx&&(n.left+=b.dx);b.dy&&(n.top-=b.dy);switch(b.shape){case "annulus":r.radii=[];if(void 0!==b.radii)if("string"===typeof b.radii){r.radii=b.radii.replace(/ /g,"").split(",");for(e=d=0;d<r.radii.length;d++)""!==r.radii[d]&&(r.radii[e++]=parseInt(r.radii[d],10))}else r.radii=b.radii;else{b.ireg&&a.SCALEIREG&&
(b.iradius&&(b.iradius/=l),b.oradius&&(b.oradius/=l));h=(b.oradius-b.iradius)/b.nannuli;l=b.nannuli+1;for(d=0;d<l;d++)f=b.iradius+h*d,r.radii.push(f)}break;case "box":b.ireg&&a.SCALEIREG&&(b.width&&(b.width/=l),b.height&&(b.height/=l));break;case "circle":b.ireg&&a.SCALEIREG&&b.radius&&(b.radius/=l);break;case "ellipse":b.ireg&&a.SCALEIREG&&(b.r1&&(b.r1/=l),b.r2&&(b.r2/=l));break;case "point":switch(b.ptshape){case "box":b.width=2*b.ptsize;b.height=2*b.ptsize;break;case "circle":b.radius=b.ptsize;
break;case "ellipse":b.rx=b.ptsize,b.ry=b.ptsize/2}b.lockRotation=!0;b.lockScalingX=!0;b.lockScalingY=!0;b.hasControls=!1;b.hasRotatingPoint=!1;b.hasBorders=!0;break;case "polygon":if(b.pts&&b.pts.length){if("string"===typeof b.pts){g=b.pts.replace(/ /g,"").split(",");f=g.length;if("string"===typeof g[0])for(d=0;d<f;d++)g[d]=parseFloat(g[d]);b.pts=[];for(e=d=0;d<f;d+=2,e++)b.pts[e]={x:g[d],y:g[d+1]}}f=b.pts.length;for(d=0;d<f;d++)b.pts[d]=this.imageToDisplayPos(b.pts[d]);b.left&&b.top?g={x:b.left,
y:b.top}:(g=a.centroidPolygon(b.pts),n.left=g.x,n.top=g.y);b.points=[];for(d=0;d<f;d++)e={x:(b.pts[d].x-g.x)/h,y:(b.pts[d].y-g.y)/h},b.points.push(e)}if(b.ireg&&a.SCALEIREG){f=b.points.length;for(d=0;d<f;d++)b.points[d].x/=l,b.points[d].y/=l}}for(j in b)if(b.hasOwnProperty(j))switch(j){case "tags":case "x":case "y":case "dx":case "dy":case "pts":case "left":case "top":case "angle":case "radii":case "ireg":break;case "type":case "originX":case "originY":case "width":case "height":case "scaleX":case "scaleY":case "flipX":case "flipY":case "opacity":case "cornerSize":case "transparentCorners":case "hoverCursor":case "padding":case "borderColor":case "cornerColor":case "centeredScaling":case "centeredRotation":case "fill":case "fillRule":case "backgroundColor":case "stroke":case "strokeWidth":case "strokeDashArray":case "strokeLineCap":case "strokeLineJoin":case "strokeMiterLimit":case "shadow":case "borderOpacityWhenMoving":case "borderScaleFactor":case "transformMatrix":case "minScaleLimit":case "selectable":case "evented":case "visible":case "hasControls":case "hasBorders":case "hasRotatingPoint":case "rotatingPointOffset":case "perPixelTargetFind":case "includeDefaultValues":case "clipTo":case "lockMovementX":case "lockMovementY":case "lockRotation":case "lockScalingX":case "lockScalingY":case "lockUniScaling":case "radius":case "rx":case "ry":case "points":case "selectionLineWidth":case "fontFamily":case "fontSize":case "fontStyle":case "fontWeight":case "text":case "textDecoration":case "textAlign":case "lineHeight":case "textBackgroundColor":n[j]=
b[j];break;case "shape":m=b[j];break;default:r[j]=b[j]}if(!(b=r.color)){b=r.tags;j=r.tagcolors;var k,q;j=j||{};for(k in j)if(j.hasOwnProperty(k)&&(d=k.split("_"),0===$(b).not(d).length&&0===$(d).not(b).length)){q=j[k];break}if(!q)for(k in j)if(j.hasOwnProperty(k)&&(d=k.split("_"),0===$(b).not(d).length)){q=j[k];break}if(!q)for(k in j)if(j.hasOwnProperty(k)&&(d=k.split("_"),0===$(d).not(b).length)){q=j[k];break}b=q=q||c&&c.get("stroke")||j.defcolor||a.globalOpts.defcolor||"#000000"}n.stroke=b;n.selectColor=
n.stroke;n.cornerColor=n.stroke;n.borderColor=n.stroke;void 0!==r.fixinplace&&(c=r.fixinplace,void 0===n.lockMovementX&&(n.lockMovementX=c),void 0===n.lockMovementY&&(n.lockMovementY=c),void 0===n.lockRotation&&(n.lockRotation=c),void 0===n.lockScalingX&&(n.lockScalingX=c),void 0===n.lockScalingY&&(n.lockScalingY=c),void 0===n.hasControls&&(n.hasControls=!c),void 0===n.hasRotatingPoint&&(n.hasRotatingPoint=!c),void 0===n.hasBorders&&(n.hasBorders=!c));return{shape:m,opts:n,params:r}};a.Fabric.addShapes=
function(d,b,c){var e,f,g,h,l,j,m,n,r,k,q=[],p={};if((j=this.getShapeLayer(d))&&j.show){m=j.canvas;"main"===this.display.layers[d].dtype?(n=this.primary.sect.zoom,r=this.binning.bin||1):r=n=1;if("string"===typeof b)e=this.parseRegions(b),b="string"===typeof e?[{shape:e}]:e;else if(!$.isArray(b))if("object"===typeof b)b=[b];else return;if("string"===typeof c)try{l=JSON.parse(c)}catch(s){return a.error("can't parse shape opts: "+c,s),null}else l=c;m.size()||(c=this.display.layers[d],"regions"===d&&
c.opts.canvas.zindex++,c.divjq.css("z-index",c.opts.canvas.zindex));h=$.extend(!0,{},a.Fabric.opts,j.opts,l);for(g=0;g<b.length;g++)if(c=$.extend(!0,{},h,b[g]),f=a.Fabric._parseShapeOptions.call(this,d,c),f.remove)this.removeShapes(d,"all");else if(f.shape){c=f.opts;p=f.params;p.id=++j.nshape;switch(f.shape){case "annulus":p.shape="annulus";f=c.top;k=c.left;c.top=0;c.left=0;if(p.radii)for(e=0;e<p.radii.length;e++)c.radius=p.radii[e],q.push(new fabric.Circle(c));c.top=f;c.left=k;c.width=2*c.radius;
c.height=2*c.radius;e=new fabric.Group(q,c);break;case "box":p.shape="box";e=new fabric.Rect(c);break;case "circle":p.shape="circle";e=new fabric.Circle(c);break;case "ellipse":p.shape="ellipse";c.rx=p.r1;c.ry=p.r2;e=new fabric.Ellipse(c);break;case "point":p.shape="point";switch(p.ptshape){case "box":e=new fabric.Rect(c);break;case "circle":e=new fabric.Circle(c);break;case "ellipse":e=new fabric.Ellipse(c);break;default:e=new fabric.Rect(c)}break;case "polygon":p.shape="polygon";e=new fabric.Polygon(c.points,
c,p.skipOffset);break;case "text":p.shape="text";p.text=c.text||"Double-click to add text here";if(window.hasOwnProperty("fabric")&&(!l||!l.strokeWidth))c.strokeWidth="1.4.0"===fabric.version?0:1;e=new fabric.Text(p.text,c);break;default:a.error("unknown shape: "+f.shape)}m.add(e);p.layerName=d;p.sw1=e.strokeWidth;p.listonchange=!1;e.params=p;if(j.opts.panzoom)switch(p.shape){case "point":case "text":break;default:e.scale(n/r)}e.rescaleBorder();a.Fabric._updateShape.call(this,d,e,null,"add",p)}(void 0===
p.redraw||p.redraw)&&m.renderAll();return p.id}};a.Fabric.selectShapes=function(a,b,c){var e,f,g,h,l=this;if(!this.layers||!a||!this.layers[a])return null;b=b||"all";a=this.layers[a].canvas;f=a.getActiveGroup();g={group:null};switch(typeof b){case "object":b.params&&(g.group=f&&f.contains(b)?f:null,c.call(l,b,g));break;case "number":a.forEachObject(function(a){a.params&&b===a.params.id&&(g.group=f&&f.contains(a)?f:null,c.call(l,a,g))});break;case "string":h=b.toLowerCase().replace("box","rect"),"selected"===
b?a.getActiveObject()?(a=a.getActiveObject(),a.params&&(g.group=null,c.call(l,a,g))):f&&(g.group=f,f.forEachObject(function(a){a.params&&c.call(l,a,g)})):a.forEachObject(function(a){if(a.params)if(g.group=f&&f.contains(a)?f:null,"all"===b)c.call(l,a,g);else if(b===a.stroke)c.call(l,a,g);else if(h===a.type)c.call(l,a,g);else if(a.params.tags)for(e=0;e<a.params.tags.length;e++)b===a.params.tags[e]&&c.call(l,a,g)})}return this};a.Fabric.updateShapes=function(d,b,c,e){var f=this;this.selectShapes(d,b,
function(b,h){a.Fabric._updateShape.call(f,d,b,h,c,e)});return this};a.Fabric._updateShape=function(d,b,c,e,f){var g,h,l,j,m,n,r,k={},q=this.layers[d],p=function(a){return a.toFixed(1)};c=c||{};f=f||{};n=this.display;l="main"===this.display.layers[d].dtype?this.primary.sect.zoom:1;k.mode=e||"update";k.id=b.params.id;k.shape=b.params.shape;k.layer=d;k.color=b.stroke;k.tags=b.params.tags;e=b.getCenterPoint();c.group&&(r=c.group.getCenterPoint(),e={x:e.x+r.x,y:e.y+r.y});r=this.displayToImagePos(e);k.x=
r.x;k.y=r.y;k.imsys="image";k.lcs=this.imageToLogicalPos(r);"image"===this.params.wcssys?(j=k.x,m=k.y):(j=k.lcs.x,m=k.lcs.y,k.imsys=k.lcs.sys);k.angle=-b.angle;c.group&&(k.angle-=c.group.angle);for(;0>k.angle;)k.angle+=360;for(;360<k.angle;)k.angle-=360;e=1*(b.scaleX/l);l=1*(b.scaleY/l);c.group&&(e*=c.group.scaleX,l*=c.group.scaleY);switch(k.shape){case "annulus":k.shape="annulus";k.radii=[];k.imstr="annulus("+p(j)+", "+p(m)+", ";h="annulus "+k.x+" "+k.y+" ";l=b.getObjects();j=l.length;for(c=0;c<
j;c++)m=l[c].radius*e,k.imstr+=p(m),h+=k.x+" "+k.y+" "+(k.x+m)+" "+k.y+" ",k.imstr=c===j-1?k.imstr+")":k.imstr+", ",k.radii.push(m);break;case "box":k.shape="box";k.width=b.width*e;k.height=b.height*l;k.imstr="box("+p(j)+", "+p(m)+", "+p(k.width)+", "+p(k.height)+", "+k.angle.toFixed(4)+")";h="box "+k.x+" "+k.y+" "+k.x+" "+k.y+" "+(k.x+k.width)+" "+k.y+" "+k.x+" "+k.y+" "+k.x+" "+(k.y+k.height)+" "+k.angle*Math.PI/180;break;case "circle":k.radius=b.radius*e;k.imstr="circle("+p(j)+", "+p(m)+", "+p(k.radius)+
")";h="circle "+k.x+" "+k.y+" "+k.x+" "+k.y+" "+(k.x+k.radius)+" "+k.y;break;case "ellipse":k.r1=b.width*e/2;k.r2=b.height*l/2;k.imstr="ellipse("+p(j)+", "+p(m)+", "+p(k.r1)+", "+p(k.r2)+", "+k.angle.toFixed(4)+")";h="ellipse "+k.x+" "+k.y+" "+k.x+" "+k.y+" "+(k.x+k.r1)+" "+k.y+" "+k.x+" "+k.y+" "+k.x+" "+(k.y+k.r2)+" "+k.angle*Math.PI/180;break;case "point":k.width=b.width*e;k.height=b.height*l;k.imstr="point("+p(j)+", "+p(m)+")";h="point "+k.x+" "+k.y;break;case "polygon":k.imstr="polygon(";h="polygon ";
k.pts=[];for(c=0;c<b.points.length;c++)0<c&&(k.imstr+=", ",h+=" "),m={x:k.x+b.points[c].x*e,y:k.y-b.points[c].y*l},m=a.rotatePoint(m,k.angle,{x:k.x,y:k.y}),"image"===this.params.wcssys?k.imstr+=p(m.x)+", "+p(m.y):(j=this.imageToLogicalPos(m),k.imstr+=p(j.x)+", "+p(j.y)),h+=m.x+" "+m.y,k.pts.push(m);k.imstr+=")";break;case "text":k.imstr="text("+p(j)+", "+p(m)+', "'+b.text+'")',k.text=b.text,h="text "+k.x+" "+k.y+' "'+b.text+'"'}if(this.wcs&&0<this.wcs){if("regions"===d&&!1!==f.dowcsstr||"regions"!==
d&&!0===f.dowcsstr)k.wcsstr=a.reg2wcs(this.wcs,h).replace(/;$/,"");h=a.pix2wcs(this.wcs,r.x,r.y).trim().split(/\s+/);k.ra=h[0];k.dec=h[1];k.wcssys=h[2]}b.set("pub",k);b.params.winid&&($(b.params.winid).is(":visible")?a.Regions.initConfigForm.call(this,b):b.params.winid=null);if(f.nocb)return k;if("regions"===d&&this.params.xeqonchange&&q.show&&this.onregionschange)try{this.params.xeqonchange=!1,a.xeqByName(this.onregionschange,window,this,k)}catch(s){a.log("error in xeqonchange: %s [%s]\n%s",this.id,
s.message,a.strace(s))}finally{this.params.xeqonchange=!0}if(this.params.xeqonchange&&q.show&&q.opts.onchange)try{this.params.xeqonchange=!1,a.xeqByName(q.opts.onchange,window,this,k)}catch(t){a.log("error in onchange: %s [%s]\n%s",this.id,t.message,a.strace(t))}finally{this.params.xeqonchange=!0}f="on"+d+"change";for(g in n.pluginInstances)if(n.pluginInstances.hasOwnProperty(g)&&(d=n.pluginInstances[g],b=d.plugin.opts,d.isActive(f)))try{b[f].call(d,this,k)}catch(u){d.errLog(f,u)}return k};a.Fabric.removeShapes=
function(d,b){var c=this,e,f;if(e=this.getShapeLayer(d))return f=e.canvas,this.selectShapes(d,b,function(b,e){a.Fabric._updateShape.call(c,d,b,e,"remove");e&&e.group&&e.group.remove(b);b.params&&b.params.winid&&b.params.winid.close();f.remove(b)}),f.getActiveGroup()&&f.discardActiveGroup(),f.renderAll(),this};a.Fabric.getShapes=function(a,b){var c=[];this.selectShapes(a,b,function(a){c.push(a.pub||{})});return c};a.Fabric.changeShapes=function(d,b,c){var e,f,g,h,l,j,m,n,r,k,q,p,s=this;if((l=this.getShapeLayer(d))&&
c)return j=l.canvas,"main"===this.display.layers[d].dtype?(q=this.primary.sect.zoom,p=this.binning.bin||1):p=q=1,m=j.getActiveObject(),this.selectShapes(d,b,function(b,u){h=$.extend(!0,{},b.params,c);g=a.Fabric._parseShapeOptions.call(this,d,h,b);if(g.remove)this.removeShapes(d,"all");else{b.set(g.opts);b.params=$.extend(!1,{},b.params,g.params);switch(b.params.shape){case "annulus":if(c.radii&&c.radii.length){r=b.get("stroke");b.forEachObject(function(a){b.remove(a);j.remove(a)});n=b.params.radii.length;
for(e=k=0;e<n;e++)f=new fabric.Circle({radius:b.params.radii[e],stroke:r}),k=Math.max(k,b.params.radii[e]),b.add(f);b.scaleX=q/p;b.scaleY=q/p;b.width=2*k;b.height=2*k;m===b&&j.setActiveObject(b)}break;case "box":c.width&&(b.scaleX=q/p);c.height&&(b.scaleY=q/p);break;case "circle":c.radius&&(b.scaleX=q/p,b.scaleY=q/p);break;case "ellipse":c.r1&&(b.rx=c.r1,b.scaleX=q/p,b.width=2*b.rx);c.r2&&(b.ry=c.r2,b.scaleY=q/p,b.height=2*b.ry);break;case "polygon":c.points&&c.points.length&&(b.scaleX=q/p,b.scaleY=
q/p),m===b&&(a.Fabric.removePolygonAnchors(l.dlayer,b),a.Fabric.addPolygonAnchors(l.dlayer,b)),a.resetPolygonCenter(b)}b.rescaleBorder();b.setCoords();a.Fabric._updateShape.call(s,d,b,u,"update")}}),(void 0===c.redraw||c.redraw)&&j.renderAll(),this};a.Fabric.refreshShapes=function(d){var b,c,e,f,g,h,l,j,m,n=!1,r=this;if(m=this.getShapeLayer(d))return"main"===this.display.layers[d].dtype&&(n=!0),n?(e=this.binning.bin,f=this.primary.sect.zoom,g=this.binning.obin/this.primary.sect.ozoom*f/e,h=this.binning.obin/
this.primary.sect.ozoom*f/e):(e=1,h=g=f=this.primary.sect.zoom),e=m.canvas,e.getActiveGroup()&&e.discardActiveGroup(),c=e.getActiveObject(),this.selectShapes(d,"all",function(d){b=r.logicalToDisplayPos(d.pub.lcs);d.setLeft(b.x);d.setTop(b.y);switch(d.params.shape){case "point":case "text":break;default:l=g,j=h,n&&(l*=d.scaleX,j*=d.scaleY),d.scaleX=l,d.scaleY=j,d.rescaleBorder()}d.setCoords();switch(d.type){case "polygon":c===d&&(a.Fabric.removePolygonAnchors(m.dlayer,d),a.Fabric.addPolygonAnchors(m.dlayer,
d))}}),n&&(this.binning.obin=this.binning.bin,this.primary.sect.ozoom=this.primary.sect.zoom),e&&e.renderAll(),this};a.Fabric.addPolygonPoint=function(d,b,c){var e,f,g,h,l,j,m,n,r,k={},q,p,s,t,u,w=Number.MAX_VALUE;if(b&&b.points){k=a.eventToDisplayPos(c);c=b.getCenterPoint().x;g=b.getCenterPoint().y;c=(k.x-c)/b.get("scaleX");q=(k.y-g)/b.get("scaleY");for(g=-b.get("angle")*Math.PI/180;g>2*Math.PI;)g-=2*Math.PI;k=Math.cos(g)*c-Math.sin(g)*q;q=Math.sin(g)*c+Math.cos(g)*q;c=b.points;for(g=0;g<c.length;g++)f=
c[g],h=c[(g+1)%c.length],l=f.x<h.x?f.x:h.x,j=f.y<h.y?f.y:h.y,m=f.x>h.x?f.x:h.x,n=f.y>h.y?f.y:h.y,e=f.x-h.x,f=f.y-h.y,r=Math.sqrt(e*e+f*f),0!==r&&(e/=r,f/=r),r=k-h.x,u=q-h.y,r=r*e+u*f,e=h.x+e*r,h=h.y+f*r,e<l?e=l:e>m&&(e=m),h<j?h=j:h>n&&(h=n),l=(e-k)*(e-k)+(h-q)*(h-q),l<w&&(w=l,p=e,s=h,t=g===c.length?0:g);d=this.getShapeLayer(d);a.Fabric.removePolygonAnchors(d.dlayer,b);c.splice(t+1,0,{x:p,y:s});d.canvas.setActiveObject(b)}};a.Fabric.removePolygonPoint=function(d,b){var c,e,f,g;b&&b.polyparams&&(e=
b.polyparams.polygon,f=e.points,g=b.polyparams.point,c=this.getShapeLayer(d),a.Fabric.removePolygonAnchors(c.dlayer,e),f.splice(g,1),a.resetPolygonCenter(e),c.canvas.setActiveObject(e))};a.Fabric.addPolygonAnchors=function(d,b){var c,e,f={},g=d.canvas,h=function(){var b=this.polyparams.polygon,c=this.polyparams.point,e=b.get("points"),h=d.display.image;b.angle?f=a.rotatePoint({x:this.left,y:this.top},-b.angle,{x:b.left,y:b.top}):(f.x=this.left,f.y=this.top);e[c].x=(f.x-b.left)/b.scaleX;e[c].y=(f.y-
b.top)/b.scaleY;a.resetPolygonCenter(b);a.Fabric._updateShape.call(h,b.params.layerName,b,null,"update");h&&(h.params.listonchange||b.params.listonchange)&&h.listRegions(b,2);g.renderAll()},l=function(b){var c,d={};for(c=0;c<b.params.anchors.length;c++)d.x=b.left+b.points[c].x*b.scaleX,d.y=b.top+b.points[c].y*b.scaleY,b.angle&&(d=a.rotatePoint(d,b.angle,{x:b.left,y:b.top})),b.params.anchors[c].set({left:d.x,top:d.y,angle:b.angle}),b.params.anchors[c].setCoords();b._calcDimensions(!0);g.renderAll()};
if(!b.params.anchors){b.params.anchors=[];for(c=0;c<b.points.length;c++)f.x=b.left+b.points[c].x*b.scaleX,f.y=b.top+b.points[c].y*b.scaleY,b.angle&&(f=a.rotatePoint(f,b.angle,b.getCenterPoint())),e=new fabric.Rect({left:f.x,top:f.y,hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,selectable:!0,fill:b.get("stroke"),hoverCursor:"pointer",width:a.Fabric.opts.cornerSize,height:a.Fabric.opts.cornerSize,padding:2}),e.on("moving",h),e.polyparams={},e.polyparams.polygon=b,e.polyparams.point=c,b.params.anchors[c]=
e,g.add(e);b.on("moving",function(){l(b)});b.on("rotating",function(){l(b)});b.on("scaling",function(){l(b)});b.setCoords()}};a.Fabric.removePolygonAnchors=function(a,b){var c,e=a.canvas;if(b.params&&b.params.anchors){for(c=0;c<b.params.anchors.length;c++)e.remove(b.params.anchors[c]);delete b.params.anchors}};a.resetPolygonCenter=function(d){var b={},c,e;d._calcDimensions();c=(d.minX+d.width/2)*d.scaleX;e=(d.minY+d.height/2)*d.scaleY;d.angle?b=a.rotatePoint({x:d.left+c,y:d.top+e},d.angle,{x:d.left,
y:d.top}):(b.x=d.left+c,b.y=d.top+e);d.left=b.x;d.top=b.y;d.setCoords()};a.Fabric.print=function(){var d,b,c;b=sprintf("width=%s,height=%s,menubar=1,toolbar=1,status=0,scrollbars=1,resizable=1",this.display.canvasjq.attr("width"),this.display.canvasjq.attr("height"));c=this.display.canvas.toDataURL("image/png");if(b=window.open(null,this.id,b)){b.document.open();b.document.write("<html><body style='padding: 0px; margin: 0px' onload='window.print(); return false'>");b.document.write("<div style='position: absolute'>");
b.document.write("<img src='");b.document.write(c);b.document.write("' />");b.document.write("</div>");for(d in this.layers)this.layers.hasOwnProperty(d)&&("main"===this.layers[d].dlayer.dtype&&this.layers[d].show)&&(b.document.write("<div style='position: absolute'>"),b.document.write(this.layers[d].dlayer.canvas.toSVG()),b.document.write("</div>"));b.document.write("</body></html>");b.document.close()}else a.log("warning: could not create print window (check your pop-up blockers)")};a.Fabric.initGraphics=
function(){var d;a.Display.prototype.newShapeLayer=a.Fabric.newShapeLayer;a.Image.prototype.addShapes=a.Fabric.addShapes;a.Image.prototype.selectShapes=a.Fabric.selectShapes;a.Image.prototype.updateShapes=a.Fabric.updateShapes;a.Image.prototype.updateShape=a.Fabric._updateShape;a.Image.prototype.getShapes=a.Fabric.getShapes;a.Image.prototype.changeShapes=a.Fabric.changeShapes;a.Image.prototype.removeShapes=a.Fabric.removeShapes;a.Image.prototype.refreshShapes=a.Fabric.refreshShapes;a.Image.prototype.getShapeLayer=
a.Fabric.getShapeLayer;a.Image.prototype.showShapeLayer=a.Fabric.showShapeLayer;a.Image.prototype.displayShapeLayers=a.Fabric.displayShapeLayers;a.Image.prototype.print=a.Fabric.print;for(d in a.Fabric.opts)a.Fabric.opts.hasOwnProperty(d)&&(fabric.Object.prototype[d]=a.Fabric.opts[d])};a.Fabric.initGraphics();a.Regions={};a.Regions.CLASS="JS9";a.Regions.NAME="Regions";a.Regions.opts={canvas:{zindex:a.SHAPEZINDEX+2},panzoom:!0,tags:"source,include",strokeWidth:2,iradius:0,oradius:30,nannuli:10,width:60,
height:60,radius:30,r1:30,r2:20,ptshape:"box",ptsize:2,points:[{x:-30,y:30},{x:30,y:30},{x:0,y:-30}],fontFamily:"Helvetica",fontSize:14,fontStyle:"normal",fontWeight:300,textAlign:"left",angle:0,aradius1:4,aradius2:8,configURL:"./params/regionsconfig.html",tagcolors:{include_source:"#00FF00",exclude_source:"#FF0000",include_background:"#FFD700",exclude_background:"#FF8C00",source:"#00FF00",background:"#FFD700",defcolor:"#00FF00"}};a.Regions.init=function(d){var b;a.Image.prototype.parseRegions=a.Regions.parseRegions;
a.Image.prototype.saveRegions=a.Regions.saveRegions;a.Image.prototype.listRegions=a.Regions.listRegions;b=this.display.newShapeLayer(d||"regions",a.Regions.opts);b.canvas.on("mouse:up",function(){var a,d,f=[];if(b.display.image){d=b.display.image;this.getActiveObject()&&f.push(this.getActiveObject());this.getActiveGroup()&&(f=this.getActiveGroup().getObjects());for(a=0;a<f.length;a++)if(f[a].params){d.params.listonchange?d.listRegions("all",2):f[a].params.listonchange&&d.listRegions("selected",2);
break}}});return this};a.Regions.initConfigForm=function(a){var b,c,e=a.params.winid,f="#"+$(e).attr("id")+" #regionsConfigForm ";$(f+"."+a.pub.shape).each(function(){$(this).removeClass("nodisplay")});$(f+".val").each(function(){c="";b=$(this).attr("name");switch(b){case "pts":a.pub.pts?a.pub.pts.forEach(function(a){c&&(c+=", ");c+=sprintf("%s, %s",a.x,a.y)}):a.pub.imstr&&(c=a.pub.imstr.replace(/^.*\(/,"").replace(/\)$/,""));break;default:void 0!==a.pub[b]&&(c=a.pub[b])}$(this).val(c)});a.pub.wcsstr&&
$(f+".wcs").removeClass("nodisplay");void 0===a.params.listonchange&&(a.params.listonchange=!1);a.params.listonchange?$(f+"[name='listonchange']").attr("checked","checked"):$(f+"[name='listonchange']").removeAttr("checked");void 0===a.params.fixinplace&&(a.params.fixinplace=!1);a.params.fixinplace?$(f+"[name='fixinplace']").attr("checked","checked"):$(f+"[name='fixinplace']").removeAttr("checked");switch(a.pub.shape){case "box":case "ellipse":case "polygon":case "text":$(f+".angle").removeClass("nodisplay")}$(f).data("im",
this);$(f).data("shape",a);$(f).data("winid",e)};a.Regions.processConfigForm=function(d,b,c){var e,f,g,h=c.length,l={},j=function(a,b,c){return"remove"===b||void 0!==a.pub[b]&&String(a.pub[b])!==c||void 0!==a.params[b]&&String(a.params[b])!==c?!0:!1},m=function(a){return"true"===a?!0:"false"===a?!1:""===a||isNaN(a)?a:parseFloat(a)};for(e=0;e<h;e++)switch(f=c[e].name,g=c[e].value,f){case "x":j(d,f,g)&&(l[f]=m(g),void 0===l.y&&(l.y=d.pub.y));break;case "y":j(d,f,g)&&(l[f]=m(g),void 0===l.x&&(l.x=d.pub.x));
break;default:j(d,f,g)&&(l[f]=m(g))}this.changeShapes(d.pub.layer,d,l);a.Regions.initConfigForm.call(this,d,b)};a.Regions.listRegions=function(a,b){var c,e,f,g,h,l,j="",m="none",n=!1,r=[];void 0===b&&(b=2);r=this.getShapes("regions",a);f=r.length;if(b)for(c=0;c<f;c++)if(e=r[c],"source,include"!==e.tags.join(",")){n=!0;break}for(c=0;c<f;c++)e=r[c],h=e.tags.join(","),l=0<=h.indexOf("exclude")?"-":"",n&&(g=" # "+h),e.wcsstr&&"image"!==this.params.wcssys&&"physical"!==this.params.wcssys?("wcs"!==m&&("none"!==
m&&(j+="; "),j+=this.params.wcssys,m="wcs"),j+="; "+l+e.wcsstr):e.imstr&&(m!==e.imsys&&("none"!==m&&(j+="; "),j+=e.imsys,m=e.imsys),j+="; "+l+e.imstr),n&&(j+=g);1<b&&this.displayMessage("regions",j);return j};a.Regions.parseRegions=function(d){var b=[],c,e,f,g,h,l,j,m,n,r,k,q,p=/(annulus)|(box)|(circle)|(ellipse)|(polygon)|(point)|(text)/,s=/(fk4)|(fk5)|(icrs)|(galactic)|(ecliptic)|(image)|(physical)/,t=/\(\s*([^)]+?)\s*\)/,u=/(\{[^}]*\})/,w=/\s*,\s*/,v=function(b){b=a.saostrtod(b);var c=String.fromCharCode(a.saodtype());
switch(c){case '"':b/=3600;break;case "'":b/=60;break;case "r":b*=180/Math.PI}return{dval:b,dtype:c}},y=function(b,c){var d,e;e=v(b);d=v(c);if(":"===e.dtype||":"===d.dtype)n=!0;m||n?(":"===e.dtype&&("galactic"!==j&&"ecliptic"!==j)&&(e.dval*=15),d=a.wcs2pix(this.wcs,e.dval,d.dval).split(/ +/),e=parseFloat(d[0])-1,d=parseFloat(d[1])-1):"physical"===j?(d=this.logicalToImagePos({x:e.dval,y:d.dval}),e=d.x,d=d.y):(e=e.dval,d=d.dval);return[e,d]},x=function(a,b){var c=v(a);if((m||n)&&c.dtype&&"."!==c.dtype)c.dval=
Math.abs(c.dval/k["cdelt"+b]);return c.dval};d=d.trim();if(!d.match(/(\(|\{|#|;|\n)/))return d;try{k=JSON.parse(a.wcsinfo(this.wcs))}catch(z){k={cdelt1:1,cdelt2:1,crot:0,imflip:0}}l=this.getWCSSys();j="physical";this.setWCSSys(j);m="image"!==j&&"physical"!==j;f=d.split(/\n|;/);for(d=0;d<f.length;d++)if("#"!==f[d].trim().substr(0,1)){n=!1;g=f[d];h=void 0;c={opts:{},args:[],isregion:0};c.cmd=0<=g.indexOf("(")?g.split("(")[0].trim().toLowerCase():0<=g.indexOf("{")?g.split("{")[0].trim().toLowerCase():
0<=g.indexOf("#")?g.split("#")[0].trim().toLowerCase():g.trim().toLowerCase();c.cmd&&(c.isregion=0<=c.cmd.search(p));c.comment=g.split("#")[1];c.comment&&(c.comment=c.comment.trim().toLowerCase());if((h=u.exec(g))&&h[1])try{c.opts=JSON.parse(h[1].trim())}catch(A){c.opts={}}if((h=t.exec(g))&&h[1])c.args=h[1].split(w);c.isregion&&0===c.cmd.indexOf("-")&&(c.cmd=c.cmd.slice(1),c.comment=c.comment?c.comment+",exclude":"exclude");h=c;q=h.args.length;if(h.isregion){g=$.extend(!0,{},h.opts);g.shape=h.cmd;
2<=q&&(r=y.call(this,h.args[0],h.args[1]),g.x=r[0],g.y=r[1]);switch(h.cmd){case "annulus":g.radii=[];for(c=2;c<q;c++)g.radii.push(x.call(this,h.args[c],1));break;case "box":3<=q&&(g.width=x.call(this,h.args[2],1));4<=q&&(g.height=x.call(this,h.args[3],2));5<=q&&(g.angle=v(h.args[4]).dval);break;case "circle":3<=q&&(g.radius=x.call(this,h.args[2],1));break;case "ellipse":3<=q&&(g.r1=x.call(this,h.args[2],1));4<=q&&(g.r2=x.call(this,h.args[3],2));5<=q&&(g.angle=v(h.args[4]).dval);break;case "polygon":g.pts=
[];for(e=c=0;c<q;c+=2,e++)r=y.call(this,h.args[c],h.args[c+1]),g.pts[e]={x:r[0],y:r[1]};delete g.x;delete g.y;break;case "text":3<=q&&(c=g,e=h.args[2].replace(/^['"]/,"").replace(/['"]$/,""),c.text=e)}h.comment&&(g.tags=h.comment);b.push(g)}else h.cmd.match(s)?(this.setWCSSys(h.cmd),j=this.getWCSSys(),m="image"!==j&&"physical"!==j):("remove"===h.cmd||"delete"===h.cmd)&&b.push({remove:!0})}this.setWCSSys(l);return b};a.Regions.saveRegions=function(d){var b=sprintf("# Region file format: JS9 version 1.0");
d=this.listRegions(d,1);b=sprintf("%s\n%s\n",b,d.replace(/; */g,"\n"));b=new Blob([b],{type:"text/plain;charset=utf-8"});window.hasOwnProperty("saveAs")?saveAs(b,"js9.reg"):a.error("no saveAs function available to save region file");return d};a.Regions.keyDownCB=function(a,b,c,e){var f,g;b={evt:c};var h=c.which||c.keyCode;e=e||"regions";g=a.display.layers[e].canvas;switch(h){case 8:case 46:c.preventDefault();f="removeRegion";break;case 37:c.preventDefault();f="editRegion";b.dx=-1;break;case 38:c.preventDefault();
f="editRegion";b.dy=1;break;case 39:c.preventDefault();f="editRegion";b.dx=1;break;case 40:c.preventDefault();f="editRegion";b.dy=-1;break;case 68:f="downRegion";break;case 85:f="upRegion"}switch(f){case "removeRegion":a.removeShapes(e,"selected");a.clearMessage(e);g.fire("mouse:up");break;case "editRegion":a.changeShapes(e,"selected",b);g.fire("mouse:up");break;case "downRegion":a.selectShapes(e,"selected",function(a){g.sendToBack(a)});break;case "upRegion":a.selectShapes(e,"selected",function(a){g.bringToFront(a)})}};
a.Magnifier={};a.Magnifier.CLASS="JS9";a.Magnifier.NAME="Magnifier";a.Magnifier.opts={originX:"left",originY:"top",hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,selectable:!1,zoom:4,canvas:{selection:!1},tagcolors:{defcolor:"#00FF00"}};a.Magnifier.HTML="<span><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"zoomMagnifier\", \"x2\"); return false'>x2</button><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"zoomMagnifier\", \"/2\"); return false'>/2</button><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"zoomMagnifier\", \""+
a.Magnifier.opts.zoom+"\"); return false'>"+a.Magnifier.opts.zoom+"</button></span>";a.Magnifier.init=function(d,b){this.width=this.divjq.attr("data-width");this.width||(this.width=d||a.MAGWIDTH);this.divjq.css("width",this.width);this.width=parseInt(this.divjq.css("width"),10);this.height=this.divjq.attr("data-height");this.height||(this.height=b||a.MAGHEIGHT);this.divjq.css("height",this.height);this.height=parseInt(this.divjq.css("height"),10);this.canvas=document.createElement("canvas");this.canvasjq=
$(this.canvas);this.canvasjq.addClass("JS9Magnifier");this.canvasjq.css("z-index",a.ZINDEX);this.canvasjq.attr("width",this.width);this.canvasjq.attr("height",this.height);this.context=this.canvas.getContext("2d");a.ANTIALIAS||(this.context.imageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1);this.containerjq=$("<div>").addClass("JS9Container").append(this.canvasjq).appendTo(this.divjq);this.display.newShapeLayer("magnifier",a.Magnifier.opts,
this.divjq)};a.Magnifier.display=function(d,b){var c,e,f,g,h,l,j,m,n,r,k,q;d&&(d.display.pluginInstances.JS9Magnifier&&"active"===d.display.pluginInstances.JS9Magnifier.status)&&(d.magnifier||(d.magnifier={zoom:a.Magnifier.opts.zoom,posx:0,posy:0}),e=d.display.pluginInstances.JS9Magnifier,g=d.display.canvas,f=d.magnifier.zoom,j=Math.floor(e.width/f),m=Math.floor(e.height/f),b?(c=d.imageToDisplayPos(b),h=c.x-j/2,l=c.y-m/2,d.magnifier.posx=h,d.magnifier.posy=l):(h=d.magnifier.posx,l=d.magnifier.posy),
r=n=0,k=e.canvas.width,q=e.canvas.height,0>h&&(j+=h,n-=h*f,k+=h*f,h=0),c=h+j-g.width,0<c&&(j-=c,k=j*f),0>l&&(m+=l,r-=l*f,q+=l*f,l=0),c=l+m-g.height,0<c&&(m-=c,q=m*f),e.context.clear(),e.context.drawImage(g,h,l,j,m,n,r,k,q),d.magnifier.boxid||(d.magnifier.boxid=d.addShapes("magnifier","box"),$(e.canvas).css("background-color","black")),g=e.width/2,e=e.height/2,d.changeShapes("magnifier",d.magnifier.boxid,{left:g,top:e,width:f,height:f}))};a.Magnifier.zoom=function(d,b){var c,e;if(d&&d.magnifier){c=
d.magnifier;e=c.zoom;switch(b.charAt(0)){case "x":case "*":e*=parseFloat(b.slice(1));break;case "/":e/=parseFloat(b.slice(1));break;default:e=parseFloat(b)}if(!e||1>e)e=1;c.zoom=e;a.Magnifier.display(d)}};a.Magnifier.close=function(a){a.display.pluginInstances.JS9Magnifier&&a.display.pluginInstances.JS9Magnifier.context.clear()};a.Panner={};a.Panner.CLASS="JS9";a.Panner.NAME="Panner";a.Panner.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,zoom:4,canvas:{selection:!0},tagcolors:{defcolor:"#00FF00"}};
a.Panner.HTML="<span><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"zoomPanner\", \"x2\"); return false'>x2</button><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"zoomPanner\", \"/2\"); return false'>/2</button><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"zoomPanner\", \"1\"); return false'>Zoom1</button><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"panImage\"); return false'>Center</button></span>";a.Panner.init=function(d,
b){var c,e=this;this.width=this.divjq.attr("data-width");this.width||(this.width=d||a.PANWIDTH);this.divjq.css("width",this.width);this.width=parseInt(this.divjq.css("width"),10);this.height=this.divjq.attr("data-height");this.height||(this.height=b||a.PANHEIGHT);this.divjq.css("height",this.height);this.height=parseInt(this.divjq.css("height"),10);this.canvas=document.createElement("canvas");this.canvasjq=$(this.canvas);this.canvasjq.addClass("JS9Panner");this.canvasjq.css("z-index",a.ZINDEX);this.canvasjq.attr("width",
this.width);this.canvasjq.attr("height",this.height);this.context=this.canvas.getContext("2d");a.ANTIALIAS||(this.context.imageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1);this.containerjq=$("<div>").addClass("JS9Container").append(this.canvasjq).appendTo(this.divjq);c=this.display.newShapeLayer("panner",a.Panner.opts,this.divjq);c.canvas.on("object:modified",function(b){var d=e.display.image;if(d){var h=b.target.getCenterPoint();b=h.x*
d.panner.xblock/d.panner.zoom+d.panner.x0-d.panner.ix;h=(c.canvas.height-h.y)*d.panner.yblock/d.panner.zoom+d.panner.y0-d.panner.iy;try{d.display.pluginInstances.JS9Panner.status="inactive",d.setPan(b,h)}catch(l){a.log("couldn't pan image")}finally{d.display.pluginInstances.JS9Panner.status="active"}}});this.display.image&&a.Panner.display(this.display.image)};a.Panner.create=function(a){var b,c,e,f,g,h,l,j,m,n,r,k,q;if(a&&a.raw&&a.display.pluginInstances.JS9Panner&&a.psColors){a.panner||(a.panner=
{});a.panner.zoom||(a.panner.zoom=1);b=a.display.pluginInstances.JS9Panner;c=a.panner;e=a.primary.sect;k=Math.min(a.raw.width,b.width);q=Math.min(a.raw.height,b.height);c.xblock=a.raw.width/k;c.yblock=a.raw.height/q;c.xblock>c.yblock?(q=q/c.xblock*c.yblock,c.yblock=c.xblock):c.yblock>c.xblock&&(k=k/c.yblock*c.xblock,c.xblock=c.yblock);b=a.display.context.createImageData(k,q);1===c.zoom?(h=c.xblock,l=c.yblock,e=g=0):(h=c.xblock/c.zoom,l=c.yblock/c.zoom,g=Math.max(0,(e.x0+e.x1-k*h)/2),e=Math.max(0,
(e.y0+e.y1-q*l)/2));c.x0=g;c.y0=e;for(j=0;j<q;j++){n=Math.floor(e+(q-j-1)*l)*a.raw.width;r=j*k;for(c=0;c<k;c++)f=Math.floor(g+c*h),f=a.colorData[f+n],a.psColors[f]&&(m=4*(r+c),b.data[m]=a.psColors[f][0],b.data[m+1]=a.psColors[f][1],b.data[m+2]=a.psColors[f][2],b.data[m+3]=255)}a.panner.img=b;a.panner.ix=0;a.panner.iy=0;return a}};a.Panner.display=function(d){var b,c,e,f,g,h,l;if(d&&(d.display.pluginInstances.JS9Panner&&"active"===d.display.pluginInstances.JS9Panner.status)&&(a.Panner.create(d),c=
d.panner,b=d.display.pluginInstances.JS9Panner,e=d.primary.sect,c.img))return c.img.width<b.canvas.width&&(c.ix=Math.floor((b.canvas.width-c.img.width)/2)),c.img.height<b.canvas.height&&(c.iy=Math.floor((b.canvas.height-c.img.height)/2)),b.context.clear(),b.context.putImageData(c.img,c.ix,c.iy),f=c.zoom/c.xblock,g=c.zoom/c.yblock,h=e.width*f/e.zoom,l=e.height*g/e.zoom,f=(e.x0-c.x0)*f+c.ix,b=b.height-1-((e.y1-c.y0)*g+c.iy),f=f+1+h/2,b=b+1+l/2,f=Math.floor(f),b=Math.floor(b),h=Math.floor(h),l=Math.floor(l),
h={left:f,top:b,width:h,height:l},d.panner.boxid?d.changeShapes("panner",d.panner.boxid,h):d.panner.boxid=d.addShapes("panner","box",h),d};a.Panner.zoom=function(d,b){var c,e,f;if(d&&d.panner&&d.display.pluginInstances.JS9Panner){e=d.panner;c=d.display.pluginInstances.JS9Panner;f=e.zoom;switch(b.charAt(0)){case "*":case "x":case "X":c=Math.min(Math.min(c.width,c.height),f*parseFloat(b.slice(1)));break;case "/":c=Math.max(1,f/parseFloat(b.slice(1)));break;default:c=parseFloat(b)}if(!c||1>c)c=1;e.zoom=
c;a.Panner.display(d);return d}};a.Panner.close=function(a){a.display.pluginInstances.JS9Panner&&a.display.pluginInstances.JS9Panner.context.clear();return a};a.Catalogs={};a.Catalogs.CLASS="JS9";a.Catalogs.NAME="Catalogs";a.Catalogs.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,selectable:!1,evented:!1,canvas:{selection:!1},panzoom:!0,shape:"circle",strokeWidth:2,width:10,height:10,radius:5,eradius:{x:5,y:3},angle:0,tagcolors:{defcolor:"#00FF00"}};a.invoke=function(a,b){function c(){return a.apply(this,
b)}var e;c.prototype=a.prototype;e=new c;e.constructor=a;return e};"function"!==typeof Object.create&&(Object.create=function(a){var b=function(){};b.prototype=a;return new b});a.getImageID=function(d,b){var c,e,f=0,g=1,h=a.images.length,l=/.*<([0-9][0-9]*)>$/;for(c=0;c<h;c++)e=a.images[c],e.display.id===b&&d===e.oid&&(0<=e.id.search(l)&&(e=e.id.replace(l,"$1"),g=Math.max(g,parseInt(e,10))),f++);return f?d+"<"+String(g+1)+">":d};var H=1;a.uniqueID=function(){return H++};a.listev=function(d){d=$(d||
"body")[0];d=$.hasData(d)&&$._data(d);a.log(d.events)};a.waiting=function(a){switch(a){case !0:$("body").addClass("waiting");break;case !1:$("body").removeClass("waiting")}};a.lightWin=function(d,b,c,e,f){switch(a.LIGHTWIN){case "dhtml":return dhtmlwindow.open(d,b,c,e,f)}};a.checkNew=function(d){d||a.error("internal failure in a JS9 constructor")};a.specialKey=function(a){return a.metaKey||a.ctrlKey};a.strace=function(d){var b="";1<a.DEBUG&&(b=d.stack||d.stacktrace||"");return b};a.bcall=function(d,
b,c){var e,f;(e=$(d).closest("div[class^=JS9PluginToolbar]").data("displayid"))?f=a.getImage(e):a.error("can't find display for cmd: "+b);f||a.error("can't find image for cmd: "+b);switch(b){case "zoomPanner":3>arguments.length&&a.error("missing argument(s) for cmd: "+b);try{a.Panner.zoom(f,c)}catch(g){a.error("error calling zoomPanner()",g)}break;case "zoomMagnifier":3>arguments.length&&a.error("missing argument(s) for cmd: "+b);try{a.Magnifier.zoom(f,c)}catch(h){a.error("error calling zoomMagnifier()",
h)}break;case "panImage":try{f.setPan()}catch(l){a.error("error calling setPan()",l)}}};a.centroidPolygon=function(a){var b,c,e=0,f=0;if(a&&a.length){c=a.length;for(b=0;b<c;b++)e+=a[b].x,f+=a[b].y;return{x:e/c,y:f/c}}};a.lookupImage=function(d,b){var c,e=null,f=null,g=a.images.length;for(c=0;c<g;c++)if(f=a.images[c],d===f||d===f.file||d===a.TOROOT+f.file||f.fitsFile&&d===f.fitsFile)if(0<$("#"+f.display.id).length&&(!b||b===f.display.id)){e=f;break}return e};a.lookupDisplay=function(d){var b,c=RegExp(sprintf("[-_]?(%s)$",
a.PLUGINS));if(d&&"*"!==d&&0>d.toString().search(a.SUPERMENU)){for(b=0;b<a.displays.length;b++)if(d===a.displays[b]||d===a.displays[b].id)return a.displays[b];if("string"===typeof d){d=d.replace(c,"");for(b=0;b<a.displays.length;b++)if(d===a.displays[b]||d===a.displays[b].id)return a.displays[b]}a.error("can't find JS9 display with id: "+d)}return a.displays[0]};a.getImage=function(d){var b=null,c=null,b=a.lookupImage(d);if(!b&&(c=a.lookupDisplay(d)))b=c.image;return b};a.onFileList=function(d,b,
c){var e,f=function(b,c,d){a.fits.handleFITSFile?(b.name&&(c.filename=b.name),a.fits.handleFITSFile(b,c,d)):a.error("no FITS module available to load FITS file")};for(e=0;e<d.length;e++)if(-1!==d[e].type.indexOf("image/"))switch(d[e].type){case "image/fits":f(d[e],b,c);break;default:a.handleImageFile(d[e],b,c)}else f(d[e],b,c)};a.fetchURL=function(d,b,c,e){var f=new XMLHttpRequest,g;b||(b=d,d=/([^\\\/]+)$/.exec(b)[1]);g=$.extend(!0,{},c,a.fits.options);f.open("GET",b,!0);f.responseType=c.responseType?
c.responseType:"blob";f.onload=function(){var h;4===this.readyState&&(200===this.status||0===this.status?"blob"===f.responseType?(h=new Blob([this.response]),h.name=d,a.onFileList([h],g,e)):c.display?e(this.response,c,{display:c.display}):e(this.response,c):404===this.status?a.error("could not find "+b):a.error("can't load: "+b+" ("+this.status+")"))};f.onerror=function(){a.error("can't load: "+b)};f.onreadystatechange=function(){f.xtimeout&&(clearTimeout(f.xtimeout),delete f.xtimeout)};try{f.send()}catch(h){a.error("request to load "+
b+" failed",h)}f.xtimeout=setTimeout(function(){a.error("timeout while waiting for response from server; "+b+" might not exist")},a.globalOpts.xtimeout)};a.fitsLibrary=function(d){var b;if(!d)return a.fits.name;b=d.toLowerCase();switch(b){case "fitsy":a.fits=Fitsy;a.fits.datahandler(a.NewFitsImage);a.fits.options=a.userOpts.fits||a.fits.options||{};break;case "astroem":case "cfitsio":a.fits=Astroem;a.fits.options=a.fits.options||{};a.fits.options.handler=a.NewFitsImage;a.userOpts.fits?(a.fits.options.extlist=
a.userOpts.fits.extlist,a.fits.options.table={nx:a.userOpts.fits.table.nx,ny:a.userOpts.fits.table.ny}):(a.fits.options.extlist=a.globalOpts.extlist,a.fits.options.table={nx:a.globalOpts.dims[0],ny:a.globalOpts.dims[1]});a.fits.maxFITSMemory&&a.globalOpts.maxMemory&&a.fits.maxFITSMemory(a.globalOpts.maxMemory);break;default:a.error("unknown fits library: "+d)}a.fits.name=b;a.fits.options.error=a.error;a.fits.options.waiting=a.waiting;return b};a.handleImageFile=function(d,b,c){b=$.extend(!0,{},b,
a.fits.options);void 0===c&&(c=a.Load);var e=new FileReader;e.onload=function(a){var e=new Image;e.src=a.target.result;e.onload=function(){var a,f,j,m=0;a=document.createElement("canvas");f=a.getContext("2d");var n=e.height,r=e.width;a.width=r;a.height=n;f.drawImage(e,0,0);var k=f.getImageData(0,0,r,n).data,q=new Float32Array(n*r);for(f=0;f<n;f++)for(a=0;a<r;a++)j=0.299*k[m]+0.587*k[m+1]+0.114*k[m+2],q[(n-f)*r+a]=j,m+=4;a={head:{},name:d.name,filedata:q,naxis:2,axis:[0,r,n],bitpix:-32,data:q};a.dmin=
Number.MAX_VALUE;a.dmax=Number.MIN_VALUE;for(m=0;m<n*r;m++)a.dmin=Math.min(a.dmin,a.data[m]),a.dmax=Math.max(a.dmax,a.data[m]);c(a,b)}};e.readAsDataURL(d)};a.lookupColormap=function(d){var b;d||(d=a.imageOpts.colormap);if(d)for(b=0;b<a.colormaps.length;b++)if(a.colormaps[b].name===d)return a.colormaps[b];a.error("unknown colormap '"+d+"'")};a.lookupCommand=function(d){var b,c;if(d){c=d.toLowerCase();for(b=0;b<a.commands.length;b++)if(d=a.commands[b],d.name===c||d.alias===c||d.alias2===c)return d}return null};
a.error=function(d,b,c){var e,f,g="",h="",l=!0;a.waiting(!1);"string"===typeof b?(f=d.match(b))?f[1]?d=f[1]:f[0]&&(d=f[0]):l=!1:"object"===typeof b&&(e=b);3>arguments.length&&(c=!0);if(l&&(e&&e.message?d+=sprintf(" (%s)",e.message):d&&(e=Error(d)),(f=a.strace(e))&&(h="\n\nStacktrace:\n"+f),a.globalOpts.alerts&&(d&&("string"===typeof d&&0>d.search(/ERROR/))&&(g="JS9 ERROR: "),alert(g+(d+h))),c))throw e;};a.eventToDisplayPos=function(a){var b,c;a||(a=window.event);a.target?b=a.target:a.srcElement&&
(b=a.srcElement);3===b.nodeType&&(b=b.parentNode);a.originalEvent&&a.originalEvent.changedTouches&&a.originalEvent.changedTouches.length?(c=a.originalEvent.changedTouches[0].pageX,a=a.originalEvent.changedTouches[0].pageY):(c=a.pageX,a=a.pageY);c-=$(b).offset().left;b=a-$(b).offset().top;return{x:Math.floor(c-1),y:Math.floor(b-1)}};a.rotatePoint=function(a,b,c){var e;c=c||{x:0,y:0};b=Math.PI*b/180;e=Math.cos(b);b=Math.sin(b);return{x:e*(a.x-c.x)-b*(a.y-c.y)+c.x,y:b*(a.x-c.x)+e*(a.y-c.y)+c.y}};a.log=
function(){if(void 0!==window.console&&void 0!==window.console.log)try{console.log.apply(console,arguments)}catch(a){Function.prototype.bind.call(console.log,console).apply(console,arguments)}};a.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)};a.cardpars=function(d){var b;if("="===d[8])return b=d.slice(0,8).trim(),d=d.slice(10).replace(/\'/g," ").replace(/\/.*/,"").trim(),"T"===d?d=!0:"F"===d?d=!1:a.isNumber(d)&&(d=parseFloat(d)),[b,d]};a.raw2FITS=function(a,b){var c,e,f,g=!1,h="";
if(a.card)for(c=0;c<a.card.length;c++)e=a.card[c],h+=e,"END "===e.substring(0,4)&&(g=!0),b&&(h+="\n");else if(a.cardstr)for(c=0;c<a.ncard;c++)e=a.cardstr.slice(80*c,80*(c+1)),h+=e,"END "===e.substring(0,4)&&(g=!0),b&&(h+="\n");else if(a.header)for(e in c=a.header,c)if(c.hasOwnProperty(e)&&!("js9Protocol"===e||"js9Endian"===e))"END"===e&&(g=!0),f=c[e],!0===f&&(f="T"),h+=sprintf("%-8s%-2s%-70s",e,"=",f),b&&(h+="\n");g||(h+=sprintf("%-8s%-72s","END"," "),b&&(h+="\n"));return h};CanvasRenderingContext2D.prototype.clear=
CanvasRenderingContext2D.prototype.clear||function(a){a&&(this.save(),this.setTransform(1,0,0,1,0,0));this.clearRect(0,0,this.canvas.width,this.canvas.height);a&&this.restore()};a.xeqByName=function(d,b){var c,e,f,g;e=Array.prototype.slice.call(arguments,2);c=typeof d;switch(c){case "function":return d.apply(b,e);case "string":f=d.split(".");g=f.pop();for(c=0;c<f.length;c++)b=b[f[c]];return b[g].apply(b,e);default:a.error("unknown function type: "+c)}};a.loadPrefs=function(d,b){$.ajax({url:d,dataType:"json",
async:!1,success:function(b){var d,f,g;for(g in b)if(b.hasOwnProperty(g)&&a.hasOwnProperty(g)&&(f=typeof a[g],d=typeof b[g],f===d||"string"===d))switch(f){case "object":$.isArray(b[g])?a[g]=b[g]:$.extend(!0,a[g],b[g]);break;case "number":case "string":a[g]=b[g]}},error:function(){b&&("Chrome"===a.BROWSER[0]&&""===document.domain?a.log("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access the preference file."):a.log("JS9 prefs file not available: %s",
d))}})};a.isTypedArray=function(a){a=Object.prototype.toString.call(a);return{"[object Int8Array]":!0,"[object Uint8Array]":!0,"[object Uint8ClampedArray]":!0,"[object Int16Array]":!0,"[object Uint16Array]":!0,"[object Int32Array]":!0,"[object Uint32Array]":!0,"[object Float32Array]":!0,"[object Float64Array]":!0}.hasOwnProperty(a)};a.mouseDownCB=function(d){var b,c,e,f,g=d.data,h=g.image;d.preventDefault();if(h)if(2<a.DEBUG&&a.log("m-down: %d %d %d %s",d.clientX-g.x,d.clientY-g.y,h.evstate,h.rclick),
c=a.eventToDisplayPos(d),f=h.displayToImagePos(c),h.dnpos=c,h.rclick)h.clearMessage("regions");else{if(!a.specialKey(d))for(b in g.pluginInstances)if(g.pluginInstances.hasOwnProperty(b)&&(c=g.pluginInstances[b],e=c.plugin.opts,c.isActive("onmousedown")&&(!h.rclick||e.mousedownRegions)))try{e.onmousedown.call(c,h,f,d.originalEvent||d)}catch(l){c.errLog("onmousedown",l)}h.evstate=d.button;d.originalEvent&&(d.originalEvent.touches&&d.originalEvent.touches.length)&&(h.evstate=d.originalEvent.touches.length-
2);$("body").on("mousemove",g,function(b){return a.mouseMoveCB(b)});$("body").on("mouseup",g,function(b){return a.mouseUpCB(b)})}};a.mouseUpCB=function(d){var b,c,e,f,g=d.data,h=g.image;d.preventDefault();if(h){b=a.eventToDisplayPos(d);c=h.displayToImagePos(b);h.rclick?h.dnpos&&Math.abs(h.dnpos.x-b.x)<a.NOMOVE&&Math.abs(h.dnpos.y-b.y)<a.NOMOVE?h.updateShapes("regions","selected","select"):h.updateShapes("regions","selected","update"):a.specialKey(d)&&(h.dnpos&&Math.abs(h.dnpos.x-b.x)<a.NOMOVE&&Math.abs(h.dnpos.y-
b.y)<a.NOMOVE)&&h.setPan(c.x,c.y);if(!a.specialKey(d))for(e in g.pluginInstances)if(g.pluginInstances.hasOwnProperty(e)&&(b=g.pluginInstances[e],f=b.plugin.opts,b.isActive("onmouseup")&&(!h.rclick||f.mouseupRegions)))try{f.onmouseup.call(b,h,c,d.originalEvent||d)}catch(l){b.errLog("onmouseup",l)}h.rclick=0;h.evstate=-1;$("body").off("mouseup");$("body").off("mousemove");2<a.DEBUG&&a.log("m-up: %d %d %s",d.clientX-g.x,d.clientY-g.y,h.rclick)}};a.mouseMoveCB=function(d){var b,c,e,f,g=d.data,h=g.image;
d.preventDefault();if(h){b=a.eventToDisplayPos(d);c=h.displayToImagePos(b);h.valpos=null;3<a.DEBUG&&a.log("m-move: %d %d %s %s",d.clientX-g.x,d.clientY-g.y,h.rclick,h.evstate);if(h.rclick&&(h.rclick=2,(f=h.display.layers.regions.params.sel)&&(h.params.listonchange||f.params.listonchange)))h.updateShape("regions",f,null,"update",!0),h.listRegions("selected",2);switch(h.evstate){case -1:if(0<c.x&&(0<c.y&&c.x<h.raw.width&&c.y<h.raw.height)&&!a.specialKey(d))for(e in a.globalOpts.internalValPos&&(h.valpos=
h.updateValpos(c)),g.pluginInstances)if(g.pluginInstances.hasOwnProperty(e)&&(b=g.pluginInstances[e],f=b.plugin.opts,b.isActive("onmousemove")&&(!h.rclick||f.mousemoveRegions)))try{f.onmousemove.call(b,h,c,d.originalEvent||d)}catch(l){b.errLog("onmousemove",l)}break;case 0:case 1:if(h.rclick||a.specialKey(d))break;if(h.dnpos&&Math.abs(h.dnpos.x-b.x)<a.NOMOVE&&Math.abs(h.dnpos.y-b.y)<a.NOMOVE)break;c.x=Math.floor(b.x+0.5);c.y=Math.floor(b.y+0.5);if(0>c.x||0>c.y||c.x>=g.canvas.width||c.y>=g.canvas.height)break;
h.params.bias=c.x/g.canvas.width;h.params.contrast=10*(c.y/g.canvas.height);a.bugs.firefox_linux?window.setTimeout(function(){h.displayImage("scaled")},0):h.displayImage("scaled")}}};a.mouseOverCB=function(d){var b,c,e,f,g=d.data,h=g.image;d.preventDefault();if(h&&(h.display.displayConjq.focus(),!a.specialKey(d)))for(c in b=a.eventToDisplayPos(d),b=h.displayToImagePos(b),g.pluginInstances)if(g.pluginInstances.hasOwnProperty(c)&&(e=g.pluginInstances[c],f=e.plugin.opts,e.isActive("onmouseover")&&(!h.rclick||
f.mouseoverRegions)))try{f.onmouseover.call(e,h,b,d.originalEvent||d)}catch(l){e.errLog("onmouseover",l)}};a.mouseOutCB=function(d){var b,c,e,f,g=d.data,h=g.image;d.preventDefault();if(h&&(h.display.displayConjq.blur(),!a.specialKey(d)))for(c in b=a.eventToDisplayPos(d),b=h.displayToImagePos(b),g.pluginInstances)if(g.pluginInstances.hasOwnProperty(c)&&(e=g.pluginInstances[c],f=e.plugin.opts,e.isActive("onmouseout")&&(!h.rclick||f.mouseoutRegions)))try{f.onmouseout.call(e,h,b,d.originalEvent||d)}catch(l){e.errLog("onmouseout",
l)}};a.keyPressCB=function(d){var b,c,e,f,g=d.data,h=g.image;b=d.which||d.keyCode;d.preventDefault();3<a.DEBUG&&a.log("keypress: %d ",b);b=a.eventToDisplayPos(d);b=h.displayToImagePos(b);for(c in g.pluginInstances)if(g.pluginInstances.hasOwnProperty(c)&&(e=g.pluginInstances[c],f=e.plugin.opts,e.isActive("onkeypress")))try{f.onkeypress.call(e,h,b,d.originalEvent||d)}catch(l){e.errLog("onkeypress",l)}};a.keyDownCB=function(d){var b,c,e,f,g=d.data,h=g.image;b=d.which||d.keyCode;3<a.DEBUG&&a.log("keydown: %d ",
b);b=a.eventToDisplayPos(d);b=h.displayToImagePos(b);for(c in g.pluginInstances)if(g.pluginInstances.hasOwnProperty(c)&&(e=g.pluginInstances[c],f=e.plugin.opts,e.isActive("onkeydown")))try{f.onkeydown.call(e,h,b,d.originalEvent||d)}catch(l){e.errLog("onkeydown",l)}h.layer&&h.layers[h.layer].opts.usekeyboard&&a.Regions.keyDownCB(h,b,d,h.layer)};a.dragenter=function(a,b){b.stopPropagation();b.preventDefault()};a.dragover=function(a,b){b.stopPropagation();b.preventDefault()};a.dragexit=function(a,b){b.stopPropagation();
b.preventDefault()};a.dragdrop=function(d,b,c){var e=b.target.files||b.dataTransfer.files,f=$.extend(!0,{},a.fits.options);b.stopPropagation();b.preventDefault();void 0===f.display&&(f.display=d);void 0===f.extlist&&(f.extlist=a.globalOpts.extlist);a.onFileList(e,f,c)};a.consoleKeyDownCB=function(d){var b=d.data,c=d.which||d.keyCode;if(!a.specialKey(d)){d=b.consoleConjq.find(".JS9CmdIn:last");d.focus();if(b.hist.length&&(38===c||40===c)){b.hist[b.histpos]?b.hist[b.histpos]=d.val():b.histtemp=d.val();
switch(c){case 38:b.histpos--;0>b.histpos&&(b.histpos=0);break;case 40:b.histpos++;b.histpos>b.hist.length&&(b.histpos=b.hist.length);break;default:a.error("internal keycode switch mixup")}b.hist[b.histpos]?(d.val(b.hist[b.histpos]),b.histused=b.histpos!==b.hist.length?!0:!1):(d.val(b.histtemp),b.histused=!1)}13===c&&(a.globalOpts.alerts=!1,b.xeq(),a.globalOpts.alerts=!0,b.inp())}};a.RegisterPlugin=function(d,b,c,e){var f;if(d&&(b&&c)&&(f=d+b,e?(e.viewMenuItem&&(e.menuItem=e.viewMenuItem),e.menuItem&&
!e.menu&&(e.menu="view"),e.menu&&(e.menu=e.menu.toLowerCase())):e=[],a.PLUGINS&&(a.PLUGINS+="|"),a.PLUGINS+=f.replace(/JS9/,""),a.plugins.push({xclass:d,xname:b,name:f,opts:e,func:c,instances:[]}),e.help)){var g;c=e.help.match(/^.*[\\\/]/);c[0]&&(g="plugins/"+c[0].replace(/[\\\/]+$/,""));c=e.help.replace(/^.*[\\\/]/,"");a.helpOpts[b]={type:g,url:c,heading:d,title:e.menuItem?e.menuItem:f}}};a.instantiatePlugin=function(d,b,c,e){var f,g,h;if("string"===typeof b){for(f=0;f<a.plugins.length;f++)if(g=
a.plugins[f],g.name===b){b=g;break}"string"===typeof b&&a.error("unknown plugin: "+b)}g=Object.create(b.func.prototype);g.name=b.name;g.isActive=function(a){if("active"!==this.status||!this.plugin.opts.hasOwnProperty(a))return!1;switch(this.winType){case "virtual":return!0;default:return this.divjq.is(":visible")}};g.errLog=function(b,c){a.log("error in %s: %s [%s]\n%s",b,this.name,c.message,a.strace(c))};if(d){h=d instanceof jQuery?d:"object"===typeof d?$(d):$("#"+d);for(f=0;f<b.instances.length;f++)if(h.is(b.instances[f].odivjq))return b.instances[f]}else h=
$("div");if(d)if(c)g.id=h.attr("id")||b.name,g.winType="light",g.winHandle=c,g.odivjq=h,g.divjq=h,g.outerdivjq=g.divjq.closest(a.lightOpts[a.LIGHTWIN].top);else{if(g.id=h.attr("id")||b.name,g.winType="div",c=h.attr("id")||"JS9Plugin",h.wrap("<div class='JS9PluginContainer'>"),g.odivjq=h,g.divjq=h,g.divjq.addClass(b.xclass+"Plugin").addClass("JS9Plugin"),g.outerdivjq=g.divjq.closest(".JS9PluginContainer"),b.opts.toolbarSeparate||h.data("toolbarseparate"))c="<div class='"+a.lightOpts[a.LIGHTWIN].dragBar+
"'>",$(c).insertBefore(g.divjq)}else g.id=b.name,g.winType="virtual";g.plugin=b;g.el=d;g.status="active";b.instances.push(g);if("virtual"===g.winType)for(f=0;f<a.displays.length;f++)a.displays[f].pluginInstances[b.name]||(g.div=null,g.display=a.displays[f],b.func.apply(g,e),a.displays[f].pluginInstances[b.name]=g);else{g.div=g.divjq[0];g.outerdiv=g.outerdivjq[0];if(b.opts.winDims&&(!g.divjq.width()||!g.divjq.height()))g.divjq.css("width",b.opts.winDims[0]),g.divjq.css("height",b.opts.winDims[1]);
c=g.divjq.data("js9id")||g.id;g.display=a.lookupDisplay(c);if(h=h.data("toolbarhtml")||b.opts.toolbarHTML)h=a.Image.prototype.expandMacro.call(null,h,[{name:"title",value:b.opts.winTitle||""}]),d=g.divjq.closest(a.lightOpts[a.LIGHTWIN].drag),0===d.length&&(d=g.divjq),$("<div class='JS9PluginToolbar-"+g.winType+"'>").css("z-index",a.BTNZINDEX).html(h).data("displayid",g.display.id).insertAfter(d);g.display.pluginInstances[b.name]=g;b.func.apply(g,e)}return g};a.instantiatePlugins=function(){var d,
b=function(b){$("div."+b.name).each(function(){a.instantiatePlugin($(this),b,null,b.opts.divArgs)});!b.opts.menuItem&&(b.opts.winDims&&!b.opts.winDims[0]&&!b.opts.winDims[1])&&a.instantiatePlugin(null,b,null,b.opts.divArgs)};for(d=0;d<a.plugins.length;d++)b(a.plugins[d])};a.init=function(){var d;window.HTMLCanvasElement||a.error("sorry: your browser does not support JS9 (no HTML5 canvas support). Try a modern version of Firefox, Chrome, or Safari.");JSON||a.error("sorry: your browser does not support JS9 (no JSON support). Try a modern version of Firefox, Chrome, or Safari.");
if(!a.INSTALLDIR){try{a.INSTALLDIR=$('link[href$="js9.css"]').attr("href").replace(/js9\.css$/,"")||""}catch(b){a.INSTALLDIR=""}a.TOROOT=a.INSTALLDIR.replace(/([^\/.])+/g,"..")}window.hasOwnProperty("Kinetic")&&!window.hasOwnProperty("fabric")&&a.error("please load fabric.js instead of Kinetic.js");a.WIDTH=a.WIDTH||512;a.HEIGHT=a.HEIGHT||512;a.INFOWIDTH=a.INFOWIDTH||345;a.INFOHEIGHT=a.INFOHEIGHT||265;a.MENUWIDTH=a.MENUWIDTH||a.WIDTH;a.MENUHEIGHT=a.MENUHEIGHT||"auto";a.CONWIDTH=a.CONWIDTH||a.WIDTH;
a.CONHEIGHT=a.CONHEIGHT||180;a.MAGWIDTH=a.MAGWIDTH||a.WIDTH/2;a.MAGHEIGHT=a.MAGHEIGHT||a.HEIGHT/2;a.PANWIDTH=a.PANWIDTH||320;a.PANHEIGHT=a.PANHEIGHT||320;a.DS9WIDTH=a.DS9WIDTH||250;a.DS9HEIGHT=a.DS9HEIGHT||250;"dhtml"===a.LIGHTWIN&&($("<div>").attr("id","dhtmlwindowholder").appendTo($(document.body)).append("<span style='display:none'>.</span>"),$("#dhtmlwindowholder").bind("DOMNodeInserted",function(b){var c=a.globalOpts.dhtmlonload,d=a.globalOpts.dhtmlloadid;c&&d===$(b.target).attr("id")&&(delete a.globalOpts.dhtmlonload,
delete a.globalOpts.dhtmlloadid,window.setTimeout(function(){c.call(null)},a.TIMEOUT))}),dhtmlwindow.imagefiles=[a.InstallDir("images/min.gif"),a.InstallDir("images/close.gif"),a.InstallDir("images/restore.gif"),a.InstallDir("images/resize.gif")]);a.PREFSFILE&&(a.loadPrefs(a.InstallDir(a.PREFSFILE),1),a.loadPrefs(a.PREFSFILE,0));"file:"===a.globalOpts.helperProtocol&&(a.globalOpts.helperProtocol="http:");a.globalOpts.helperProtocol+="//";if(window.hasOwnProperty("localStorage")){if(d=localStorage.getItem("images")){try{a.userOpts.images=
JSON.parse(d)}catch(c){}a.userOpts.images&&$.extend(!0,a.imageOpts,a.userOpts.images)}if(d=localStorage.getItem("regions")){try{a.userOpts.regions=JSON.parse(d)}catch(e){}a.userOpts.regions&&$.extend(!0,a.Regions.opts,a.userOpts.regions)}if(d=localStorage.getItem("fits"))try{a.userOpts.fits=JSON.parse(d)}catch(f){}}a.DEBUG=a.DEBUG||a.globalOpts.debug||0;window.hasOwnProperty("Astroem")&&(a.initwcs=Astroem.initwcs,a.wcsinfo=Astroem.wcsinfo,a.wcssys=Astroem.wcssys,a.wcsunits=Astroem.wcsunits,a.pix2wcs=
Astroem.pix2wcs,a.wcs2pix=Astroem.wcs2pix,a.reg2wcs=Astroem.reg2wcs,a.saostrtod=Astroem.saostrtod,a.saodtype=Astroem.saodtype,a.zscale=Astroem.zscale);window.hasOwnProperty("Fitsy")?(a.fitsLibrary("fitsy"),a.fits=Fitsy):window.hasOwnProperty("Astroem")&&(a.fitsLibrary("cfitsio"),a.fits=Astroem);$("div.JS9").each(function(){a.checkNew(new a.Display($(this)))});a.RegisterPlugin("JS9","Menubar",a.Menubar);a.RegisterPlugin("JS9","Info",a.Info.init,{menuItem:"InfoBox",plugindisplay:a.Info.clearMain,winTitle:"JS9 Info",
winResize:!0,winDims:[a.INFOWIDTH,a.INFOHEIGHT]});a.RegisterPlugin("JS9","Console",a.Console,{menuItem:"Console",winTitle:"JS9 Console",winResize:!0,winDims:[a.WIDTH,180]});a.RegisterPlugin(a.Regions.CLASS,a.Regions.NAME,a.Regions.init,{onkeydown:a.Regions.keyDownCB,divArgs:["regions"],winDims:[0,0]});a.RegisterPlugin(a.Magnifier.CLASS,a.Magnifier.NAME,a.Magnifier.init,{menuItem:"Magnifier",toolbarSeparate:!1,toolbarHTML:a.Magnifier.HTML,onmousemove:a.Magnifier.display,onimageclose:a.Magnifier.close,
winTitle:"JS9 Magnifier",winDims:[a.MAGWIDTH,a.MAGHEIGHT],divArgs:[a.DS9WIDTH,a.DS9HEIGHT]});a.RegisterPlugin(a.Panner.CLASS,a.Panner.NAME,a.Panner.init,{menuItem:"Panner",toolbarSeparate:!1,toolbarHTML:a.Panner.HTML,onimagedisplay:a.Panner.display,onimageclose:a.Panner.close,winTitle:"JS9 Panner",winDims:[a.PANWIDTH,a.PANHEIGHT],divArgs:[a.DS9WIDTH,a.DS9HEIGHT]});a.instantiatePlugins();a.checkNew(new a.Colormap("grey",[[0,0],[1,1]],[[0,0],[1,1]],[[0,0],[1,1]]));a.checkNew(new a.Colormap("red",[[0,
0],[1,1]],[[0,0],[0,0]],[[0,0],[0,0]]));a.checkNew(new a.Colormap("green",[[0,0],[0,0]],[[0,0],[1,1]],[[0,0],[0,0]]));a.checkNew(new a.Colormap("blue",[[0,0],[0,0]],[[0,0],[0,0]],[[0,0],[1,1]]));a.checkNew(new a.Colormap("a",[[0,0],[0.25,0],[0.5,1],[1,1]],[[0,0],[0.25,1],[0.5,0],[0.77,0],[1,1]],[[0,0],[0.125,0],[0.5,1],[0.64,0.5],[0.77,0],[1,0]]));a.checkNew(new a.Colormap("b",[[0,0],[0.25,0],[0.5,1],[1,1]],[[0,0],[0.5,0],[0.75,1],[1,1]],[[0,0],[0.25,1],[0.5,0],[0.75,0],[1,1]]));a.checkNew(new a.Colormap("bb",
[[0,0],[0.5,1],[1,1]],[[0,0],[0.25,0],[0.75,1],[1,1]],[[0,0],[0.5,0],[1,1]]));a.checkNew(new a.Colormap("he",[[0,0],[0.015,0.5],[0.25,0.5],[0.5,0.75],[1,1]],[[0,0],[0.065,0],[0.125,0.5],[0.25,0.75],[0.5,0.81],[1,1]],[[0,0],[0.015,0.125],[0.03,0.375],[0.065,0.625],[0.25,0.25],[1,1]]));a.checkNew(new a.Colormap("i8",[[0,0,0],[0,1,0],[0,0,1],[0,1,1],[1,0,0],[1,1,0],[1,0,1],[1,1,1]]));a.checkNew(new a.Colormap("aips0",[[0.196,0.196,0.196],[0.475,0,0.608],[0,0,0.785],[0.373,0.655,0.925],[0,0.596,0],[0,
0.965,0],[1,1,0],[1,0.694,0],[1,0,0]]));a.checkNew(new a.Colormap("sls",[[0,0,0],[0.043442,0,0.052883],[0.086883,0,0.105767],[0.130325,0,0.15865],[0.173767,0,0.211533],[0.217208,0,0.264417],[0.26065,0,0.3173],[0.304092,0,0.370183],[0.347533,0,0.423067],[0.390975,0,0.47595],[0.434417,0,0.528833],[0.477858,0,0.581717],[0.5213,0,0.6346],[0.506742,0,0.640217],[0.492183,0,0.645833],[0.477625,0,0.65145],[0.463067,0,0.657067],[0.448508,0,0.662683],[0.43395,0,0.6683],[0.419392,0,0.673917],[0.404833,0,0.679533],
[0.390275,0,0.68515],[0.375717,0,0.690767],[0.361158,0,0.696383],[0.3466,0,0.702],[0.317717,0,0.712192],[0.288833,0,0.722383],[0.25995,0,0.732575],[0.231067,0,0.742767],[0.202183,0,0.752958],[0.1733,0,0.76315],[0.144417,0,0.773342],[0.115533,0,0.783533],[0.08665,0,0.793725],[0.057767,0,0.803917],[0.028883,0,0.814108],[0,0,0.8243],[0,0.019817,0.838942],[0,0.039633,0.853583],[0,0.05945,0.868225],[0,0.079267,0.882867],[0,0.099083,0.897508],[0,0.1189,0.91215],[0,0.138717,0.926792],[0,0.158533,0.941433],
[0,0.17835,0.956075],[0,0.198167,0.970717],[0,0.217983,0.985358],[0,0.2378,1],[0,0.268533,1],[0,0.299267,1],[0,0.33,1],[0,0.360733,1],[0,0.391467,1],[0,0.4222,1],[0,0.452933,1],[0,0.483667,1],[0,0.5144,1],[0,0.545133,1],[0,0.575867,1],[0,0.6066,1],[0,0.631733,0.9753],[0,0.656867,0.9506],[0,0.682,0.9259],[0,0.707133,0.9012],[0,0.732267,0.8765],[0,0.7574,0.8518],[0,0.782533,0.8271],[0,0.807667,0.8024],[0,0.8328,0.7777],[0,0.857933,0.753],[0,0.883067,0.7283],[0,0.9082,0.7036],[0,0.901908,0.676675],[0,
0.895617,0.64975],[0,0.889325,0.622825],[0,0.883033,0.5959],[0,0.876742,0.568975],[0,0.87045,0.54205],[0,0.864158,0.515125],[0,0.857867,0.4882],[0,0.851575,0.461275],[0,0.845283,0.43435],[0,0.838992,0.407425],[0,0.8327,0.3805],[0,0.832308,0.354858],[0,0.831917,0.329217],[0,0.831525,0.303575],[0,0.831133,0.277933],[0,0.830742,0.252292],[0,0.83035,0.22665],[0,0.829958,0.201008],[0,0.829567,0.175367],[0,0.829175,0.149725],[0,0.828783,0.124083],[0,0.828392,0.098442],[0,0.828,0.0728],[0.033167,0.834167,
0.066733],[0.066333,0.840333,0.060667],[0.0995,0.8465,0.0546],[0.132667,0.852667,0.048533],[0.165833,0.858833,0.042467],[0.199,0.865,0.0364],[0.232167,0.871167,0.030333],[0.265333,0.877333,0.024267],[0.2985,0.8835,0.0182],[0.331667,0.889667,0.012133],[0.364833,0.895833,0.006067],[0.398,0.902,0],[0.43095,0.902,0],[0.4639,0.902,0],[0.49685,0.902,0],[0.5298,0.902,0],[0.56275,0.902,0],[0.5957,0.902,0],[0.62865,0.902,0],[0.6616,0.902,0],[0.69455,0.902,0],[0.7275,0.902,0],[0.76045,0.902,0],[0.7934,0.902,
0],[0.810617,0.897133,0.003983],[0.827833,0.892267,0.007967],[0.84505,0.8874,0.01195],[0.862267,0.882533,0.015933],[0.879483,0.877667,0.019917],[0.8967,0.8728,0.0239],[0.913917,0.867933,0.027883],[0.931133,0.863067,0.031867],[0.94835,0.8582,0.03585],[0.965567,0.853333,0.039833],[0.982783,0.848467,0.043817],[1,0.8436,0.0478],[0.995725,0.824892,0.0516],[0.99145,0.806183,0.0554],[0.987175,0.787475,0.0592],[0.9829,0.768767,0.063],[0.978625,0.750058,0.0668],[0.97435,0.73135,0.0706],[0.970075,0.712642,
0.0744],[0.9658,0.693933,0.0782],[0.961525,0.675225,0.082],[0.95725,0.656517,0.0858],[0.952975,0.637808,0.0896],[0.9487,0.6191,0.0934],[0.952975,0.600408,0.085617],[0.95725,0.581717,0.077833],[0.961525,0.563025,0.07005],[0.9658,0.544333,0.062267],[0.970075,0.525642,0.054483],[0.97435,0.50695,0.0467],[0.978625,0.488258,0.038917],[0.9829,0.469567,0.031133],[0.987175,0.450875,0.02335],[0.99145,0.432183,0.015567],[0.995725,0.413492,0.007783],[1,0.3948,0],[0.998342,0.3619,0],[0.996683,0.329,0],[0.995025,
0.2961,0],[0.993367,0.2632,0],[0.991708,0.2303,0],[0.99005,0.1974,0],[0.988392,0.1645,0],[0.986733,0.1316,0],[0.985075,0.0987,0],[0.983417,0.0658,0],[0.981758,0.0329,0],[0.9801,0,0],[0.955925,0,0],[0.93175,0,0],[0.907575,0,0],[0.8834,0,0],[0.859225,0,0],[0.83505,0,0],[0.810875,0,0],[0.7867,0,0],[0.762525,0,0],[0.73835,0,0],[0.714175,0,0],[0.69,0,0],[0.715833,0.083333,0.083333],[0.741667,0.166667,0.166667],[0.7675,0.25,0.25],[0.793333,0.333333,0.333333],[0.819167,0.416667,0.416667],[0.845,0.5,0.5],
[0.870833,0.583333,0.583333],[0.896667,0.666667,0.666667],[0.9225,0.75,0.75],[0.948333,0.833333,0.833333],[0.974167,0.916667,0.916667],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1]]));a.checkNew(new a.Colormap("hsv",function(){var a,b,c,d,e,f,r,k=[],q=0;for(a=0;200>a;a++,q++){b=1-a/199;c=360*b+270;d=Math.abs(Math.sin(3.1416*b));for(b=Math.pow(1-b,1/3);360<=c;)c-=360;c/=60;r=Math.floor(c);e=c-r;c=b*(1-d);f=b*(1-d*e);d=b*(1-d*(1-e));k[q]=[];switch(r){case 0:k[q].push(b);k[q].push(d);
k[q].push(c);break;case 1:k[q].push(f);k[q].push(b);k[q].push(c);break;case 2:k[q].push(c);k[q].push(b);k[q].push(d);break;case 3:k[q].push(c);k[q].push(f);k[q].push(b);break;case 4:k[q].push(d);k[q].push(c);k[q].push(b);break;case 5:k[q].push(b),k[q].push(c),k[q].push(f)}}return k}()));a.checkNew(new a.Colormap("heat",[[0,0],[0.34,1],[1,1]],[[0,0],[1,1]],[[0,0],[0.65,0],[0.98,1],[1,1]]));a.checkNew(new a.Colormap("cool",[[0,0],[0.29,0],[0.76,0.1],[1,1]],[[0,0],[0.22,0],[0.96,1],[1,1]],[[0,0],[0.53,
1],[1,1]]));a.checkNew(new a.Colormap("rainbow",[[0,1],[0.2,0],[0.6,0],[0.8,1],[1,1]],[[0,0],[0.2,0],[0.4,1],[0.8,1],[1,0]],[[0,1],[0.4,1],[0.6,0],[1,0]]));a.checkNew(new a.Colormap("standard",[[0,0],[0.333,0.3],[0.333,0],[0.666,0.3],[0.666,0.3],[1,1]],[[0,0],[0.333,0.3],[0.333,0.3],[0.666,1],[0.666,0],[1,0.3]],[[0,0],[0.333,1],[0.333,0],[0.666,0.3],[0.666,0],[1,0.3]]));a.checkNew(new a.Colormap("staircase",function(){var a,b,c=[],d=0;for(a=1;5>=a;a++,d++)b=a/5,c[d]=[],c[d].push(0.3*b),c[d].push(0.3*
b),c[d].push(b);for(a=1;5>=a;a++,d++)b=a/5,c[d]=[],c[d].push(0.3*b),c[d].push(b),c[d].push(0.3*b);for(a=1;5>=a;a++,d++)b=a/5,c[d]=[],c[d].push(b),c[d].push(0.3*b),c[d].push(0.3*b);return c}()));a.checkNew(new a.Colormap("color",[[0,0,0],[0.18431,0.18431,0.18431],[0.37255,0.37255,0.37255],[0.56078,0.56078,0.56078],[0.74902,0.74902,0.74902],[0.93725,0.93725,0.93725],[0,0.18431,0.93725],[0,0.37255,0.74902],[0,0.49804,0.49804],[0,0.74902,0.3098],[0,0.93725,0],[0.3098,0.62353,0],[0.49804,0.49804,0],[0.62353,
0.3098,0],[0.93725,0,0],[0.74902,0,0.3098]]));a.checkNew(new a.Command({name:"analysis",alias:"run",help:"list/run analysis for current image",get:function(){var a,b,c,d,e,f="",r=this.image;if(r&&r.analysisPackages)for(b=0;b<r.analysisPackages.length;b++){e=r.analysisPackages[b];for(a=0;a<e.length;a++)d=e[a],f&&(f+=", "),c=d.xclass?d.xclass+":"+d.name:d.name,f+=sprintf("%s (%s)",d.title,c);b<r.analysisPackages.length-1&&(f+="\n")}return f},set:function(b){var c,d=this.image;d&&((c=d.lookupAnalysis(b[0]))?
c.purl?(b=d.displayAnalysis("params",a.InstallDir(c.purl),c.title+": "+d.fitsFile),$(b).data("dispid",d.display.id).data("aname",c.name)):d.runAnalysis(c.name):a.error("unknown analysis command '"+b[0]+"'"))}}));a.checkNew(new a.Command({name:"colormap",alias:"cmap",help:"set/get colormap for current image",get:function(){var a;if(a=this.image)return a=a.getColormap(),sprintf("%s %s %s",a.colormap,a.contrast,a.bias)},set:function(a){var b=this.image;b&&b.setColormap.apply(b,a)}}));a.checkNew(new a.Command({name:"colormaps",
alias:"cmaps",help:"get list of available colormaps",get:function(){var b,c="";for(b=0;b<a.colormaps.length;b++)c&&(c+=", "),c+=a.colormaps[b].name;return c}}));a.checkNew(new a.Command({name:"help",help:"get list of available commmands",get:function(){var b,c,d;d="<table>";for(b=0;b<a.commands.length;b++)c=a.commands[b],d+="<tr><td>"+c.name+"</td><td>"+c.help,c.alias&&(d+=" ("+c.alias,c.alias2&&(d+=", "+c.alias2),d+=")"),d+="</td></tr>";return d+"</table>"}}));a.checkNew(new a.Command({name:"helper",
help:"get/set helper connection",get:function(){return a.helper.connectinfo()},set:function(b){a.helper.connect(b[0].trim())}}));a.checkNew(new a.Command({name:"image",help:"get name of currently loaded image or display specified image",get:function(){var a=this.image;if(a)return a.file},set:function(b){var c,d;for(c=0;c<a.images.length;c++)if(d=a.images[c],0<=d.file.search(b[0])&&d.display===this.display){d.displayImage("display");break}}}));a.checkNew(new a.Command({name:"images",help:"get list of currently loaded images",
get:function(){var b,c,d="";for(b=0;b<a.images.length;b++)c=a.images[b],c.display===this.display&&(d&&(d+=", "),d+=c.file);return d}}));a.checkNew(new a.Command({name:"load",help:"load image(s)",set:function(b){var c;for(c=0;c<b.length;c++)a.Load(b[c],{display:this.display.id})}}));a.checkNew(new a.Command({name:"pan",help:"set/get pan location for current image",get:function(){var a;if(a=this.image)return a=a.getPan(),sprintf("%s %s",a.x,a.y)},set:function(a){var b=this.image;b&&b.setPan.apply(b,
a)}}));a.checkNew(new a.Command({name:"pix2wcs",help:"get image pixel value for specified wcs position",set:function(b){var c=this.image;if(c)return b=a.Pix2WCS(c,b[0],b[1]),b.str}}));a.checkNew(new a.Command({name:"print",help:"print image window",get:function(){var a=this.image;a&&a.print()}}));a.checkNew(new a.Command({name:"regions",alias:"reg",alias2:"region",help:"add region to current image or list all regions",get:function(){var a=this.image;if(a)return a.listRegions("all",0)||""},set:function(a){var b=
this.image;b&&("delete"===a[0]||"remove"===a[0]?(a=a.slice(1).join(" "),b.removeShapes("regions",a)):(a=a.join(" "),b.addShapes("regions",a)))}}));a.checkNew(new a.Command({name:"scale",help:"set/get scaling for current image",get:function(){var a;if(a=this.image)return a=a.getScale(),sprintf("%s %s %s",a.scale,a.scalemin,a.scalemax)},set:function(a){var b=this.image;b&&b.setScale.apply(b,a)}}));a.checkNew(new a.Command({name:"scales",help:"get list of available scales",get:function(){return a.scales.join(", ")}}));
a.checkNew(new a.Command({name:"status",help:"get status for specified (or current) image",get:function(b){var c,d,e,f="";for(c=0;c<a.images.length;c++)if(d=a.images[c],0<=d.file.search(b[0])){e=d;break}e?c=1:(c=0,e=this.image);if(e){if(c>b.length)return e.status.load;for(;c<b.length;c++)switch(d=b[c].toLowerCase().trim(),d){case "load":f&&(f+="\n"),f+=e.status.load}}return f}}));a.checkNew(new a.Command({name:"url",help:"display a url",set:function(b){a.DisplayHelp(b[0])}}));a.checkNew(new a.Command({name:"wcssys",
help:"set/get wcs system for current image",get:function(){var a=this.image;if(a)return a.getWCSSys()},set:function(a){var b=this.image;b&&b.setWCSSys(a[0])}}));a.checkNew(new a.Command({name:"wcsu",help:"set/get wcs units used for current image",get:function(){var a=this.image;if(a)return a.getWCSUnits()},set:function(a){var b=this.image;b&&b.setWCSUnits(a[0])}}));a.checkNew(new a.Command({name:"wcssystems",help:"get list of available wcs systems",get:function(){return a.wcssyss.join(", ")}}));a.checkNew(new a.Command({name:"wcsunits",
help:"get list of available wcs units",get:function(){return a.wcsunitss.join(", ")}}));a.checkNew(new a.Command({name:"wcs2pix",help:"get wcs position for specified image pixel",set:function(b){var c=this.image;if(c)return b=a.WCS2Pix(c,b[0],b[1]),b.str}}));a.checkNew(new a.Command({name:"zoom",help:"set/get zoom for current image",get:function(){var a=this.image;if(a)return a.getZoom()},set:function(a){var b=this.image;b&&b.setZoom(a[0])}}));a.helper=new a.Helper;$(document).on("keyup keypress",
".js9AnalysisForm",function(a){if(13===(a.keyCode||a.which))return a.preventDefault(),!1});$(document).scrollTop(0)};a.parsePublicArgs=function(a){var b=null;a=Array.prototype.slice.call(a);var c=a[a.length-1];c&&("object"===typeof c&&c.hasOwnProperty("display")&&1===Object.keys(c).length)&&(b=c.display,a.pop());return{argv:a,display:b}};a.mkPublic=function(d,b){"string"===typeof b?a.Image.prototype[b]?(a[d]=function(){var c;c=a.parsePublicArgs(arguments);var d=a.getImage(c.display);if(d)return c=
d[b].apply(d,c.argv),c===d?"OK":c},a.publics[d]=a[d]):a.error("unknown image function for mkPublic: "+b):"function"===typeof b?(a[d]=b,a.publics[d]=a[d]):a.error("unsupported type for mkPublic: "+typeof b)};a.mkPublic("CloseImage","closeImage");a.mkPublic("DisplayImage","displayImage");a.mkPublic("GetColormap","getColormap");a.mkPublic("SetColormap","setColormap");a.mkPublic("GetZoom","getZoom");a.mkPublic("SetZoom","setZoom");a.mkPublic("GetPan","getPan");a.mkPublic("SetPan","setPan");a.mkPublic("GetScale",
"getScale");a.mkPublic("SetScale","setScale");a.mkPublic("GetValPos","updateValpos");a.mkPublic("ImageToDisplayPos","imageToDisplayPos");a.mkPublic("DisplayToImagePos","displayToImagePos");a.mkPublic("ImageToLogicalPos","imageToLogicalPos");a.mkPublic("LogicalToImagePos","logicalToImagePos");a.mkPublic("GetWCSUnits","getWCSUnits");a.mkPublic("SetWCSUnits","setWCSUnits");a.mkPublic("GetWCSSys","getWCSSys");a.mkPublic("SetWCSSys","setWCSSys");a.mkPublic("ShowShapeLayer","showShapeLayer");a.mkPublic("AddShapes",
"addShapes");a.mkPublic("RemoveShapes","removeShapes");a.mkPublic("GetShapes","getShapes");a.mkPublic("ChangeShapes","changeShapes");a.mkPublic("Print","print");a.mkPublic("RunAnalysis","runAnalysis");a.mkPublic("DisplayMessage","displayMessage");a.mkPublic("SetValPos",function(d){var b=null,c=a.parsePublicArgs(arguments);if(c=a.getImage(c.display))b=c.params.valpos,c.params.valpos=d;return b});a.mkPublic("Load",function(d,b){var c,e,f;c=a.parsePublicArgs(arguments);if(d)if(c=c.display?c.display:
0<a.displays.length?a.displays[0].id:a.DEFID,b=b||{},b.display=b.display||c,b.onload?e=b.onload:a.imageOpts.onload&&(e=a.imageOpts.onload,b.onload=e),d instanceof Blob){if(d.name){if(c=a.lookupImage(d.name,c)){c.displayImage("display");c.clearMessage();return}b.filename=d.name}b.filename||(b.filename=a.ANON);a.fits.handleFITSFile?(f=$.extend(!0,{},b,a.fits.options),a.fits.handleFITSFile(d,f,a.NewFitsImage)):a.error("no FITS module available to load this FITS blob")}else if("object"===typeof d)a.checkNew(new a.Image(d,
b,e));else if("string"!==typeof d&&a.error("unknown file type for Load: "+typeof d),"U0lNUExFICA9"===d.slice(0,12)&&(d=window.atob(d)),"SIMPLE  ="===d.slice(0,9)){f=[];for(c=0;c<d.length;c++)f[c]=d.charCodeAt(c);c=new Blob([new Uint8Array(f)]);b.filename||(b.filename=a.ANON);c.name=b.filename;a.fits.handleFITSFile?(f=$.extend(!0,{},b,a.fits.options),a.fits.handleFITSFile(c,f,a.NewFitsImage)):a.error("no FITS module available to process this memory FITS")}else(c=a.lookupImage(d,c))?(c.displayImage("display"),
c.clearMessage()):(d=d.trim(),c=d.split(".").pop().toLowerCase(),"png"===c?a.globalOpts.pngisfits?a.checkNew(new a.Image(d,b,e)):a.fetchURL(null,d,b,a.NewFitsImage):b.fits2png||void 0===b.fits2png&&a.globalOpts.fits2png?a.helper.connected?a.helper.send("fits2png",{fits:d},function(c){var d;c="object"===typeof c?c:0<=c.search(a.analOpts.epattern)?{stderr:c}:{stdout:c};c.stderr&&a.error(c.stderr,a.analOpts.epattern);c.stdout&&(c=c.stdout.replace(/\n*$/,"").split("\n").pop(),d=c.split(".").pop().toLowerCase(),
"png"===d?a.checkNew(new a.Image(c,b,e)):a.error("fits2png conversion failed: "+c))}):a.error("no helper available to convert this image: "+d):(a.waiting(!0),c=d.replace(/\[.*\]/,""),a.fetchURL(d,c,b,a.NewFitsImage)));else a.error("JS9.Load: no file specified for image load")});a.mkPublic("LoadRegions",function(d,b){var c;c=a.parsePublicArgs(arguments);d?(c=c.display?c.display:0<a.displays.length?a.displays[0].id:a.DEFID,b=b||{},b.display=b.display||c,"object"===typeof d?(c=new FileReader,c.onload=
function(c){a.AddRegions(c.target.result,b)},c.readAsText(d)):"string"===typeof d?(b.responseType="text",a.fetchURL(null,d,b,a.AddRegions)):a.error("unknown file type for LoadRegions: "+typeof d)):a.error("JS9.LoadRegions: no file specified for regions load")});a.mkPublic("LoadWindow",function(d,b,c,e,f){var g;g=a.helper.pageid||c||"win";b=b||{};switch(c){case "light":return b.id?(c=b.id,delete b.id):c=g+a.uniqueID(),g="d"+c,e=e||sprintf("<hr class='hline0'><div class='JS9Menubar' id='%sMenubar'></div><div class='JS9' id='%s'></div>",
c,c),f=f||a.lightOpts[a.LIGHTWIN].imageWin,a.lightWin(g,"inline",e,d,f),a.checkNew(new a.Display(c)),a.instantiatePlugins(),b.display=c,d&&a.Load(d,b),c;case "new":return b.id?(c=b.id,delete b.id):c=g+a.uniqueID(),f=document.getElementsByTagName("head")[0].innerHTML,!f.match(/src=["'].*js9\.js/)&&!f.match(/src=["'].*js9\.min\.js/)&&(f+=sprintf('<%s type="text/javascript" src="js9.min.js"></%s>',"script","script")),g=e||sprintf("<div class='JS9Menubar' id='%sMenubar'></div><div class='JS9' id='%s'></div>",
c,c),e=sprintf("<html><head>%s</head><body",f),d&&(e+=sprintf(" onload='JS9.Preload(\"%s\",%s);'",d,JSON.stringify(b))),e+=sprintf(">%s</body></html>\n",g),d=window.open(null,c,"width=540, height=560"),d=d.document,d.open(),d.write(e),d.close(),c}});a.mkPublic("Preload",function(d){var b,c,e="",f=null,g=arguments.length;b=a.parsePublicArgs(arguments);b.display&&(f={display:b.display},g-=1);switch(g){case 0:b=(null===a.helper.connected||a.helper.connected)&&0<a.preloads.length?2:3;break;case 1:b="boolean"===
typeof d?0<a.preloads.length?2:3:null===a.helper.connected||a.helper.connected?1:0;break;default:b=null===a.helper.connected||a.helper.connected?1:0}switch(b){case 0:for(b=0;b<g;b++)c=b+1,c<g&&"object"===typeof arguments[c]?(a.preloads.push([arguments[b],arguments[c],f]),b++):a.preloads.push([arguments[b],null,f]);break;case 1:a.globalOpts.alerts=!1;for(b=0;b<g;b++)if(c=b+1,c<g&&"object"===typeof arguments[c]){try{f?a.Load(arguments[b],arguments[c],f):a.Load(arguments[b],arguments[c])}catch(h){e=
e+" "+arguments[b]}b++}else try{f?a.Load(arguments[b],null,f):a.Load(arguments[b],null)}catch(l){e=e+" "+arguments[b]}a.globalOpts.alerts=!0;e&&a.error("could not preload image(s): "+e);break;case 2:a.globalOpts.alerts=!1;for(b=0;b<a.preloads.length;b++)try{a.preloads[b][2]?a.Load(a.preloads[b][0],a.preloads[b][1],a.preloads[b][2]):a.Load(a.preloads[b][0],a.preloads[b][1])}catch(j){e=e+" "+a.preloads[b][0]}a.globalOpts.alerts=!0;e&&a.error("could not preload image(s): "+e);a.preloads=[]}});a.mkPublic("RefreshImage",
function(d,b){var c=a.parsePublicArgs(arguments),e=a.getImage(c.display),f=function(b){a.Image.prototype.refreshImage.call(e,b,c.argv[1])};e?d instanceof Blob?a.fits.handleFITSFile?a.fits.handleFITSFile(d,a.fits.options,f):a.error("no FITS module available to refresh this image"):a.Image.prototype.refreshImage.apply(e,c.argv):d instanceof Blob&&a.Load.apply(null,arguments)});a.mkPublic("GetLoadStatus",function(d){var b=a.parsePublicArgs(arguments),c=a.getImage(b.display);return c?!b.argv[0]||c.oid===
b.argv[0]?c.status.load:"other":"none"});a.mkPublic("OpenFileMenu",function(a){$("#openLocalFile-"+a.id).click()});a.mkPublic("OpenRegionsMenu",function(a){$("#openLocalRegions-"+a.id).click()});a.mkPublic("NewFitsImage",function(d,b){var c;b&&b.onload&&(c=b.onload);a.checkNew(new a.Image(d,b,c))});a.mkPublic("GetImage",function(d){var b;d&&"string"!==typeof d&&(b=a.parsePublicArgs(arguments),d=b.display);return a.getImage(d)});a.mkPublic("GetImageData",function(d){var b=a.parsePublicArgs(arguments),
c=a.getImage(b.display),e=null;if(c){if(b.argv[0])if("array"===b.argv[0])e=Array.prototype.slice.call(c.raw.data);else if("base64"===b.argv[0]){for(var e="",f=new Uint8Array(c.raw.data.buffer),g=f.byteLength,b=0;b<g;b++)e+=String.fromCharCode(f[b]);e=window.btoa(e)}else b.argv[0]&&"false"!==b.argv[0]&&(e=c.raw.data);return{id:c.id,file:c.file,fits:c.fitsFile||"",source:c.source,imtab:c.imtab,width:c.raw.width,height:c.raw.height,bitpix:c.raw.bitpix,header:c.raw.header,data:e}}});a.mkPublic("LoadAuxFile",
function(d,b){var c=a.parsePublicArgs(arguments);(c=a.getImage(c.display))?c.loadAuxFile(d,b):a.error("could not find image for aux file: "+d)});a.mkPublic("SubmitAnalysis",function(d,b,c){var e,f,g;e=a.lightOpts[a.LIGHTWIN];var h=a.parsePublicArgs(arguments);b?e=a.lookupDisplay(h.display).id:(e=$(d).closest(e.top),b=e.data("aname"),e=e.data("dispid"));b?e&&(f=a.getImage(e)):g="internal error: could not find analysis task name";if(f){e=$(d).closest("form");try{h=e.serializeArray()}catch(l){h=null}f.runAnalysis(b,
h,c)}else g="internal error: could not find image";g&&a.error(g);return!1});a.mkPublic("Send",function(d,b,c){a.helper.connected?a.helper.send(d,b,c):a.error("no helper available")});a.mkPublic("EventToDisplayPos",function(d){return a.eventToDisplayPos(d)});a.mkPublic("PixToWCS",function(d,b){var c,e,f=1;c=a.parsePublicArgs(arguments);var g=a.getImage(c.display);if(g&&0<g.wcs)return c=a.pix2wcs(g.wcs,d-1,b-1).trim(),e=c.split(/ +/),"sexagesimal"===g.params.wcsunits&&("galactic"!==g.params.wcssys&&
"ecliptic"!==g.params.wcssys)&&(f=15),{ra:a.saostrtod(e[0])*f,dec:a.saostrtod(e[1]),sys:e[2],str:c}});a.Pix2WCS=a.PixToWCS;a.mkPublic("WCSToPix",function(d,b){var c,e,f;e=a.parsePublicArgs(arguments);return(e=a.getImage(e.display))&&0<e.wcs?(c=a.wcs2pix(e.wcs,d,b).trim().split(/ +/),e=parseFloat(c[0])+1,f=parseFloat(c[1])+1,c=sprintf("%f %f",e,f),{x:e,y:f,str:c}):null});a.WCS2Pix=a.WCSToPix;a.mkPublic("DisplayHelp",function(d){var b,c;d&&((c=a.helpOpts[d])?(b=c.title+"_"+a.uniqueID(),d=a.InstallDir(c.type+
"/"+c.url),a.lightWin(b,"iframe",d,c.title,"width=830px,height=400px,center=1,resize=1,scrolling=1")):(b=d+"_"+a.uniqueID(),c=d.split("/").reverse()[0],a.lightWin(b,"iframe",d,c,"width=830px,height=400px,center=1,resize=1,scrolling=1")))});a.mkPublic("NewShapeLayer",function(d,b){var c=a.parsePublicArgs(arguments);return(c=a.getImage(c.display))?c.display.newShapeLayer(d,b):null});a.mkPublic("AddRegions",function(d,b){var c=a.parsePublicArgs(arguments);return(c=a.getImage(c.display))?c.addShapes("regions",
d,b):null});a.mkPublic("RemoveRegions",function(d){var b=a.parsePublicArgs(arguments);return(b=a.getImage(b.display))?(b.removeShapes("regions",d),b.clearMessage("regions"),"OK"):null});a.mkPublic("GetRegions",function(d){var b=a.parsePublicArgs(arguments),c=a.getImage(b.display);return c?(b.argv.unshift("regions"),c.getShapes.apply(c,b.argv)):null});a.mkPublic("ChangeRegions",function(d,b){var c=a.parsePublicArgs(arguments);(c=a.getImage(c.display))&&c.changeShapes("regions",d,b);return null});a.mkPublic("InstallDir",
function(d){return a.INSTALLDIR+d});a.mkPublic("AddDivs",function(){var d,b=a.parsePublicArgs(arguments);for(d=0;d<b.argv.length;d++)a.checkNew(new a.Display(b.argv[d]));a.instantiatePlugins()});return a}(JS9);$(document).ready(function(){JS9.init()});
